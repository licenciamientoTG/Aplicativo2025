{% extends "views/layouts/base.html" %}
{% block title %}Tipo de cambio{% endblock %}
{% block mycss %}{% endblock %}
{% block menutitle %}Tipo de cambio actual{% endblock %}
{% block content %}

<div class="card">
    <div class="card-body">
        <div class="row">
            <div class="col">
                <label for="from">Fecha</label>
                <input type="date" class="form-control" name="from" id="from" value="{{ now|date('Y-m-d') }}" min="{{ now|date('Y-m-d') }}">
            </div>
            <div class="col">
                <label for="hour">Hora</label>
                <input type="time" class="form-control" name="hour" id="hour" value="{{ horaFormateada }}">
            </div>
            <div class="col">
                <label for="cot">Tipo de cambio</label>
                <input type="number" min="0" max="30" step="0.01" class="form-control" name="cot" id="cot" value="0.00">
            </div>
            <div class="col">
                <label for="cot" style="color: transparent">.</label>
                <button id="submitButton" class="btn btn-primary btn-block w-100">Enviar Seleccionados</button>
            </div>
        </div>
    </div>
</div>
<div class="card">
    <div class="card-header">
        <div class="card-actions float-end">
            <div class="dropdown position-relative">
                <a href="#" data-bs-toggle="dropdown" data-bs-display="static">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-horizontal align-middle">
                        <circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle>
                    </svg>
                </a>
                <div class="dropdown-menu dropdown-menu-end">
                    <a class="dropdown-item" href="#" id="exportExcel"><i data-feather="file-text"></i> Exportar a Excel</a>
                    <a class="dropdown-item" href="/administration/get_binnacle" id="binnacle" target="_blank"><i data-feather="file-text"></i> Ver bitácora</a>
                </div>
            </div>
        </div>
        <h5 class="card-title">Tipo de cambio actual</h5>
    </div>

    <div class="card-body table-responsive" id="cont">

        <table id="datatable_exchange_rate" class="table table-striped table-sm w-100">
            <thead>
            <tr>
                <th class="w-5">CHECK</th>
                <th>DESCRIPCIÓN</th>
                <th>NO. ESTACIÓN</th>
                <th>ESTACIÓN</th>
                <th>FECHA</th>
                <th>HORA</th>
                <th>CAMBIO</th>
                <th class="w-10">ACCIONES</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
            <tfoot>
            <tr>
                <th>CHECK</th>
                <th>DESCRIPCIÓN</th>
                <th>NO. ESTACIÓN</th>
                <th>ESTACIÓN</th>
                <th>FECHA</th>
                <th>HORA</th>
                <th>CAMBIO</th>
                <th>ACCIONES</th>
            </tr>
            </tfoot>
        </table>
    </div>
</div>

<input type="hidden" id="margen_inferior" value="{{ margen_inferior }}">
<input type="hidden" id="margen_superior" value="{{ margen_superior }}">
{% endblock %}
{% block myjs %}
<script src="{{ JS }}administration.js"></script>
<script>
    $(document).ready(function() {
        function isValidDate(dateString) {
            var regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateString.match(regex)) return false;

            var date = new Date(dateString);
            var timestamp = date.getTime();

            if (typeof timestamp !== 'number' || Number.isNaN(timestamp)) return false;

            return dateString === date.toISOString().split('T')[0];
        }

        function isValidTime(timeString) {
            var regex = /^([01]\d|2[0-3]):([0-5]\d)$/;
            return regex.test(timeString);
        }

        $('#submitButton').click(function() {

            // Vamos a validar los campos antes de enviar la información
            var from = $('#from').val();
            var hour = $('#hour').val();
            var cot = $('#cot').val();

            // Validación de los campos
            if (!from || !isValidDate(from)) {
                alert('Por favor, introduce una fecha válida (YYYY-MM-DD).');
                return;
            }

            if (!hour || !isValidTime(hour)) {
                alert('Por favor, introduce una hora válida (HH:MM).');
                return;
            }

            if (!cot || cot === '0.00' || isNaN(cot)) {
                alertify.myAlert(
                    `<div class="container text-center text-danger">
                    <h4 class="mt-2 text-danger">¡Error!</h4>
                </div>
                <div class="text-dark">
                    <p class="text-center">Por favor, introduce un valor del dólar válido y distinto de cero.</p>
                </div>`
                );
                return;
            }

            var selectedRows = [];
            var cambios = [];
            $('input[name="check"]:checked').each(function() {
                selectedRows.push($(this).val());
                var cambioText = $(this).closest('tr').find('td:eq(6)').text();
                // Remover el signo de dólar y otros caracteres no numéricos
                var cambioNum = parseFloat(cambioText.replace(/[^0-9.-]+/g, ''));
                if (!isNaN(cambioNum)) {
                    cambios.push(cambioNum);
                }
            });

            // Asegurarse de que hay al menos una fila seleccionada
            if (selectedRows.length > 0) {
                // De la variable cambios vamos a obtener el promedio
                var promedio = cambios.reduce((a, b) => parseFloat(a) + parseFloat(b), 0) / cambios.length;

                // Ahora vamos a validar si cot esta dentro de +/- 5% del promedio
                var margen_inferior_valor = promedio - (promedio * 0.05);
                var margen_superior_valor = promedio + (promedio * 0.05);

                if (cot < margen_inferior_valor || cot > margen_superior_valor) {
                    alertify.confirm('Confirme', '<p class="text-center">El tipo de cambio ingresado ($' + cot + ') supera el margen inferior/superior($'+margen_inferior_valor+'/$'+margen_superior_valor+') de +/-5%. </p><p class="text-center">¿Esta segur@ de realizar este movimiento?</p>',
                        function(){
                            $.ajax({
                                type: "POST",
                                url: "/administration/exchange_rate_process",
                                data: {
                                    rows: selectedRows,
                                    from: from,
                                    hour: hour,
                                    cot: cot
                                },
                                // Vamos a agregar la clase .loading antes de enviar
                                beforeSend: function() {
                                    $('.wrapper').addClass('loading');
                                    $('#submitButton').prop('disabled', true);
                                },
                                success: function(response) {
                                    // Manejar la respuesta del servidor aquí
                                    alertify.myAlert(
                                        `<div class="container text-center text-success">
                                            <h4 class="mt-2 text-success">¡Éxito!</h4>
                                        </div>
                                        <div class="text-dark">
                                            <p class="text-center">El tipo de cambio fue actualizado correctamente. Por favor, verifique la información en la tabla antes de enviarla.</p>
                                        </div>`
                                    );
                                    // recargamos la página
                                    setTimeout(() => {
                                        location.reload();
                                    }, 2000);
                                    $('#submitButton').prop('disabled', false);
                                },
                                error: function(xhr, status, error) {
                                    // Manejar cualquier error aquí
                                    console.error('Error:', error);
                                }
                            });
                        },
                        function(){
                            toastr.info('Operación cancelada', '¡Atención!', { timeOut: 3000 });
                            return;
                        }
                    );
                } else {
                    $.ajax({
                        type: "POST",
                        url: "/administration/exchange_rate_process",
                        data: {
                            rows: selectedRows,
                            from: from,
                            hour: hour,
                            cot: cot
                        },
                        // Vamos a agregar la clase .loading antes de enviar
                        beforeSend: function() {
                            $('.wrapper').addClass('loading');
                        },
                        success: function(response) {
                            // Manejar la respuesta del servidor aquí
                            alertify.myAlert(
                                `<div class="container text-center text-success">
                                <h4 class="mt-2 text-success">¡Éxito!</h4>
                            </div>
                            <div class="text-dark">
                                <p class="text-center">El tipo de cambio fue actualizado correctamente. Por favor, verifique la información en la tabla antes de enviarla.</p>
                            </div>`
                            );
                            // recargamos la página
                            setTimeout(() => {
                                location.reload();
                            }, 2000);

                        },
                        error: function(xhr, status, error) {
                            // Manejar cualquier error aquí
                            console.error('Error:', error);
                        }
                    });
                }

            } else {
                alertify.myAlert(
                    `<div class="container text-center text-danger">
                    <h4 class="mt-2 text-danger">¡Error!</h4>
                </div>
                <div class="text-dark">
                    <p class="text-center">Por favor, selecciona al menos una estación en la tabla.</p>
                </div>`
                );
            }
        });
    });
</script>
{% endblock %}