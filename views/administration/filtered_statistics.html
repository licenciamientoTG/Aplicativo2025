{% extends "views/layouts/base.html" %}
{% block title %}Lista de tickets{% endblock %}
{% block mycss %}
<style>
       tr.group,
tr.group:hover {
    background-color: rgba(0, 0, 0, 0.1) !important;
}
 
:root.dark tr.group,
:root.dark tr.group:hover {
    background-color: rgba(0, 0, 0, 0.75) !important;
}
.column_estation{
    background-color: #add5e6 !important;
    color: white !important;
}
.total_bg{
    background-color: #48A1C7 !important;
    color: white !important;
}
.total_bg2{
    background-color:#48A1C7 !important;
    color: white !important;

}


.border_center{
    border-top: 1px dotted  #358f92 !important;
    border-bottom: 1px dotted  #358f92 !important;
    border-left: 1px dotted #358f92 !important;
    border-right: 1px dotted  #358f92 !important;
}


table.dataTable thead th, table.dataTable thead td {
    padding: 10px 18px;
    border-bottom: 1px solid #dee2e6;
    background-color:  #3485a8 !important;
    color: #ffffff !important;
}

table.dataTable tfoot th, table.dataTable tfoot td {
    padding: 10px 18px;
    border-bottom: 1px solid #dee2e6;
    background-color:  #3485a8 !important;
    color: #ffffff !important;

}
.border_OG{
    border: 0.5px solid #0c202091 !important;
    background-color: #6d7277e8;
}

#btnExportXLS{
  height: 35px !important;
  margin-bottom: 20px !important;
}

</style>
{% endblock %}
{% block menutitle %}Lista de tickets actual{% endblock %}
{% block content %}

<div class="row">

    <div class="col-12">
        <div  class="card flex-fill">
            <div class="card-header">
           <button id="btnExportXLS" type="button" class="btn btn-sm btn-success w-20">
  <i class="fa-solid fa-file-excel mr-1"></i> Exportar a Excel
</button>

            </div>
            <div class="card-body table-responsive" id="cont">
                <table id="cash_invoices_table" class="table table-striped table-hover table-sm w-100">
                    <thead>
                        <tr>
                            <th>ID <i class="fas fa-arrow-up"></i><i class="fas fa-arrow-down"></i></th>
                            <th>Solicitante</th>
                            <th>Agente</th>
                            <th>Titulo</th>
                            <th>Estacion</th>
                            <th>Fecha Creacion</th>
                            <th>Fecha Cierre</th>
                            <th>Prioridad</th>
                            <th>Estatus</th>
                            <th>Horas Abierto</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in result %}
                            <tr>
                                <td>{{ ticket.id_mojo }}</td>
                                <td>{{ ticket.solicitante }}</td>
                                <td>{{ticket.assigned_to_name}}</td>
                                <td>{{ticket.titulo}}</td>
                                <td>{{ticket.departamento}}</td>
                                <td>{{ ticket.created_on }}</td>
                                <td>{{ ticket.solved_on }}</td>
                                <td>{{ ticket.prioridad }}</td>
                                <td>{{ ticket.estatus }}</td>
                                <td>{{ticket.hora_tot}}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block myjs %}
<script src="{{ JS }}administration.js"></script>
<script>
  $(document).ready(function() {
    const table = $('#cash_invoices_table').DataTable({
      searching: true,
      ordering: true,
      paging: true,
      info: true,
      dom: 'lfrtip',
      pageLength: 50, // Valor por defecto
      // Agrega el selector con opción "Todas"
      lengthMenu: [[25, 50, 100, 250, 500, -1], [25, 50, 100, 250, 500, 'Todas']],
      language: {
        lengthMenu: 'Mostrar _MENU_ entradas',
        info: 'Mostrando _START_ a _END_ de _TOTAL_ entradas',
        infoEmpty: 'Mostrando 0 a 0 de 0 entradas',
        infoFiltered: '(filtrado de _MAX_ entradas totales)',
        search: 'Buscar:',
        paginate: {
          first: 'Primero',
          last: 'Último',
          next: 'Siguiente',
          previous: 'Anterior'
        }
      }
    });

    // Búsqueda avanzada (si la usas)
    $('#advanced_search').on('keyup', function () {
      table.search(this.value).draw();
    });
  });
</script>


<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const btn = document.getElementById('btnExportXLS');
  if (!btn) return;

  btn.addEventListener('click', function () {
    const table = document.getElementById('cash_invoices_table');
    if (!table) return;

    // 1) Clonar la tabla para poder “limpiarla” sin afectar la vista
    const clone = table.cloneNode(true);

    // 2) Quitar columnas/filas marcadas con .no-export (opcional)
    clone.querySelectorAll('.no-export').forEach(el => el.remove());

    // 3) Convertir tabla a hoja
    const ws = XLSX.utils.table_to_sheet(clone, {
      raw: true // intenta respetar números/fechas
    });

    const rango = ws['!ref'];                // ej. "A1:F200"
ws['!autofilter'] = { ref: rango };      // agrega filtros a la 1a fila
ws['!cols'] = [{wch:28},{wch:14},{wch:14},{wch:16},{wch:18},{wch:20}]; // opcional

    // 4) (Opcional) Ajustar anchos de columnas automáticamente
    autosizeColumns(ws, clone);

    // 5) Crear libro y descargar
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Reporte');

    // Personaliza el nombre del archivo si usas Twig/variables
    const period  = "{{ period|default('now'|date('Y-m'))|default('') }}";
    const formId  = "{{ ticket_form_id|default('') }}";
    const agentId = "{{ assigned_to_id|default('0') }}";
    const filename = `Reporte-ECV_${period}_F${formId}_A${agentId}.xlsx`;

    XLSX.writeFile(wb, filename);
  });

  // ---- Helpers útiles ----

  // Calcula anchos de columna a partir del contenido del DOM clonado
  function autosizeColumns(ws, tableEl) {
    const colCount = (ws['!ref'] ? XLSX.utils.decode_range(ws['!ref']).e.c + 1 : 0);
    const widths = new Array(colCount).fill({wch: 10});

    // Recorre filas y columnas visibles del clone
    const rows = Array.from(tableEl.querySelectorAll('tr'));
    rows.forEach(row => {
      const cells = Array.from(row.children).filter(c => c.tagName === 'TH' || c.tagName === 'TD');
      cells.forEach((cell, idx) => {
        // longitud aproximada (texto plano)
        const len = (cell.innerText || '').trim().length;
        if (!widths[idx] || len + 2 > widths[idx].wch) {
          widths[idx] = { wch: Math.min(Math.max(len + 2, 8), 40) }; // min 8, max 40
        }
      });
    });

    ws['!cols'] = widths;
  }
});
</script>



{% endblock %}
