{% extends "views/layouts/base.html" %}
{% block title %}Facturas De Contado{% endblock %}
{% block mycss %}{% endblock %}
{% block menutitle %}Facturas De Contado{% endblock %}
{% block content %}
<style>
    tr.group,
tr.group:hover {
    background-color: rgba(0, 0, 0, 0.1) !important;
}
 
:root.dark tr.group,
:root.dark tr.group:hover {
    background-color: rgba(0, 0, 0, 0.75) !important;
}
.column_estation{
    background-color: #add5e6 !important;
    color: white !important;
}
.total_bg{
    background-color: #48A1C7 !important;
    color: white !important;
}
.total_bg2{
    background-color:#48A1C7 !important;
    color: white !important;

}

.border_center{
    border-top: 1px dotted  #358f92 !important;
    border-bottom: 1px dotted  #358f92 !important;
    border-left: 1px dotted #358f92 !important;
    border-right: 1px dotted  #358f92 !important;
}


table.dataTable thead th, table.dataTable thead td {
    padding: 10px 18px;
    border-bottom: 1px solid #dee2e6;
    background-color:  #3485a8 !important;
    color: #ffffff !important;

}

table.dataTable tfoot th, table.dataTable tfoot td {
    padding: 10px 18px;
    border-bottom: 1px solid #dee2e6;
    background-color:  #3485a8 !important;
    color: #ffffff !important;

}
.border_OG{
    border: 0.5px solid #0c202091 !important;
    background-color: #6d7277e8;
}
</style>
<ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link  active " id="clients_total_fac-tab" data-bs-toggle="tab" data-bs-target="#clients_total_fac" type="button" role="tab" aria-controls="clients_total_fac" aria-selected="true">Clientes Contado Total </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link   " id="clients_desp_fac-tab" data-bs-toggle="tab" data-bs-target="#clients_desp_fac" type="button" role="tab" aria-controls="clients_desp_fac" aria-selected="true">Clientes Facturas Contado</button>
    </li>
    <!-- <li class="nav-item" role="presentation">
        <button class="nav-link " id="resumen_payment-tab" data-bs-toggle="tab" data-bs-target="#resumen_payment" type="button" role="tab" aria-controls="resumen_payment" aria-selected="true">Resumen</button>
    </li> -->
</ul>

<div class="tab-content" >
    <div class="tab-pane active " id="clients_total_fac" role="tabpanel" aria-labelledby="clients_total_fac-tab">
        <div class="row">

            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-2 ">
                            <label class="col-form-label-sm" for="">Desde: </label>
                            <input type="date"  class="form-control form-control-sm" name="from" id="from" value="{{  'now'|date('Y-m-d') }}" required>
                        </div>
                        <div class="col-2 ">
                            <label class="col-form-label-sm" for="">Hasta: </label>
                            <input type="date" class="form-control form-control-sm" name="until" value="{{ (until != false) ? until : 'now'|date('Y-m-d') }}" id="until" required>
                        </div>
                        <div class="col-2 " >
                            <button id="search_cash_invoices_table" class="btn btn-sm btn-primary" style="width: 100%; margin-top: 15px;">Generar Reporte</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Facturas de contado</h5>
                </div>
            
                <div class="card-body table-responsive" id="cont">
                
                    <table id="cash_invoices_table" class="table table-striped table-hover table-sm w-100" >
                        <thead >
                        <tr>
                                <th>C.Cliente</th>
                                <th>Cliente</th>
                                <th>Monto</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                        <tfoot>
                            <tr>
                                <th>C.Cliente</th>
                                <th>Cliente</th>
                                <th>Monto</th>
                        </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        
    </div>

    <div class="tab-pane  " id="clients_desp_fac" role="tabpanel" aria-labelledby="clients_desp_fac-tab">
        <div class="row">
            <div class="card mt-3">
    <div class="card-header bg-primary text-white">
        <h5 class="card-title mb-0">An치lisis de Clientes</h5>
    </div>
    <div class="card-body">
        <!-- Primera fila: Cards de resumen -->
        <div class="row" id="client-stats-cards">
            <!-- Los cards se generar치n din치micamente aqu칤 -->
        </div>
        
        <!-- Segunda fila: Top 10 -->
        <div class="row mt-4">
            <!-- Top 10 por Cantidad de Facturas -->
            <div class="col-md-6 mb-3">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">游끥 Top 10 - Mayor Cantidad de Facturas</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-hover table-sm mb-0" id="top-facturas-table">
                                <thead class="sticky-top bg-light">
                                    <tr>
                                        <th class="text-center" style="width: 50px;">#</th>
                                        <th>C칩digo</th>
                                        <th>Cliente</th>
                                        <th class="text-end">Facturas</th>
                                        <th class="text-end">Monto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se llenar치 din치micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Top 10 por Monto -->
            <div class="col-md-6 mb-3">
                <div class="card shadow-sm">
                    <div class="card-header bg-warning text-white">
                        <h6 class="mb-0">游눑 Top 10 - Mayor Monto Facturado</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-hover table-sm mb-0" id="top-monto-table">
                                <thead class="sticky-top bg-light">
                                    <tr>
                                        <th class="text-center" style="width: 50px;">#</th>
                                        <th>C칩digo</th>
                                        <th>Cliente</th>
                                        <th class="text-end">Facturas</th>
                                        <th class="text-end">Monto</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Se llenar치 din치micamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-2 ">
                            <label class="col-form-label-sm" for="">Desde: </label>
                            <input type="date"  class="form-control form-control-sm" name="from2" id="from2" value="{{  'now'|date('Y-m-d') }}" required>
                        </div>
                        <div class="col-2 ">
                            <label class="col-form-label-sm" for="">Hasta: </label>
                            <input type="date" class="form-control form-control-sm" name="until2" value="{{ (until != false) ? until : 'now'|date('Y-m-d') }}" id="until2" required>
                        </div>
                        <div class="col-2 " >
                            <button id="search_invoice_client_desp" class="btn btn-sm btn-primary" style="width: 100%; margin-top: 15px;">Generar Reporte</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">Clientes Facturas Contado</h5>
                </div>
            
                <div class="card-body table-responsive" id="cont">
                
                    <table id="invoice_client_desp" class="table table-striped table-hover table-sm w-100" >
                        <thead >
                        <tr>
                                <th>Fecha</th>
                                <th>C.Cliente</th>
                                <th>Cliente</th>
                                <th>Monto</th>
                                <th>Estacion</th>
                                <th>Factura</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                        <tfoot>
                            <tr>
                               <th>Fecha</th>
                                <th>C.Cliente</th>
                                <th>Cliente</th>
                                <th>Monto</th>
                                <th>Estacion</th>
                                <th>Factura</th>
                        </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        
    </div>
</div>




<!-- Agregar despu칠s del card con los filtros de fecha en la secci칩n clients_desp_fac -->

<style>
.stat-card {
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: transform 0.2s;
    height: 100%;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.stat-icon {
    font-size: 2.5rem;
    opacity: 0.8;
}

.stat-value {
    font-size: 2rem;
    font-weight: bold;
    margin: 10px 0;
}

.stat-label {
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.client-detail {
    font-size: 0.85rem;
    margin-top: 5px;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.bg-gradient-success {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.bg-gradient-info {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

/* Estilos para las tablas de Top 10 */
#top-facturas-table tbody tr:hover,
#top-monto-table tbody tr:hover {
    background-color: #f8f9fa;
    cursor: pointer;
}

#top-facturas-table .rank-badge,
#top-monto-table .rank-badge {
    display: inline-block;
    width: 30px;
    height: 30px;
    line-height: 30px;
    border-radius: 50%;
    text-align: center;
    font-weight: bold;
    font-size: 0.85rem;
}

.rank-1 { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); color: #fff; }
.rank-2 { background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%); color: #fff; }
.rank-3 { background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%); color: #fff; }
.rank-other { background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%); color: #495057; }

.cliente-nombre {
    font-size: 0.85rem;
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 200px;
}

.sticky-top {
    position: sticky;
    top: 0;
    z-index: 10;
}
</style>

<script>
function generateClientStatsCards(tableData) {
    // Objeto para almacenar estad칤sticas por cliente
    const clientStats = {};
    
    // Procesar datos
    tableData.forEach(row => {
        const codcli = row.codcli;
        const cliente = row.cliente;
        const monto = parseFloat(row.monto) || 0;
        
        if (!clientStats[codcli]) {
            clientStats[codcli] = {
                nombre: cliente,
                facturas: 0,
                montoTotal: 0
            };
        }
        
        clientStats[codcli].facturas++;
        clientStats[codcli].montoTotal += monto;
    });
    
    // Convertir a array para ordenar
    const clientsArray = Object.keys(clientStats).map(codcli => ({
        codcli: codcli,
        nombre: clientStats[codcli].nombre,
        facturas: clientStats[codcli].facturas,
        montoTotal: clientStats[codcli].montoTotal
    }));
    
    // Ordenar por cantidad de facturas
    const topByFacturas = [...clientsArray].sort((a, b) => b.facturas - a.facturas);
    const top10Facturas = topByFacturas.slice(0, 10);
    
    // Ordenar por monto total
    const topByMonto = [...clientsArray].sort((a, b) => b.montoTotal - a.montoTotal);
    const top10Monto = topByMonto.slice(0, 10);
    
    // Total de clientes 칰nicos
    const totalClientes = clientsArray.length;
    
    // Total de facturas
    const totalFacturas = clientsArray.reduce((sum, c) => sum + c.facturas, 0);
    
    // Total general de monto
    const totalMonto = clientsArray.reduce((sum, c) => sum + c.montoTotal, 0);
    
    // Generar HTML de los cards de resumen
    const cardsHTML = `
        <!-- Total de Clientes -->
        <div class="col-md-3 mb-3">
            <div class="card stat-card bg-gradient-primary text-white">
                <div class="card-body text-center">
                    <div class="stat-icon">游논</div>
                    <div class="stat-value">${totalClientes}</div>
                    <div class="stat-label">Clientes 칔nicos</div>
                    <div class="client-detail">${totalFacturas} facturas totales</div>
                </div>
            </div>
        </div>
        
        <!-- Monto Total -->
        <div class="col-md-3 mb-3">
            <div class="card stat-card bg-gradient-info text-white">
                <div class="card-body text-center">
                    <div class="stat-icon">游눯</div>
                    <div class="stat-value">$${totalMonto.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div class="stat-label">Monto Total</div>
                    <div class="client-detail">Promedio: $${(totalMonto / totalClientes).toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
            </div>
        </div>
        
        <!-- Top Cliente por Facturas -->
        <div class="col-md-3 mb-3">
            <div class="card stat-card bg-gradient-success text-white">
                <div class="card-body text-center">
                    <div class="stat-icon">游끥</div>
                    <div class="stat-value">${topByFacturas[0].facturas}</div>
                    <div class="stat-label">M치s Facturas</div>
                    <div class="client-detail"><strong>${topByFacturas[0].codcli}</strong></div>
                    <div class="client-detail">${topByFacturas[0].nombre.substring(0, 25)}${topByFacturas[0].nombre.length > 25 ? '...' : ''}</div>
                </div>
            </div>
        </div>
        
        <!-- Top Cliente por Monto -->
        <div class="col-md-3 mb-3">
            <div class="card stat-card bg-gradient-warning text-white">
                <div class="card-body text-center">
                    <div class="stat-icon">游눑</div>
                    <div class="stat-value">$${topByMonto[0].montoTotal.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    <div class="stat-label">Mayor Monto</div>
                    <div class="client-detail"><strong>${topByMonto[0].codcli}</strong></div>
                    <div class="client-detail">${topByMonto[0].nombre.substring(0, 25)}${topByMonto[0].nombre.length > 25 ? '...' : ''}</div>
                </div>
            </div>
        </div>
    `;
    
    // Insertar cards de resumen
    $('#client-stats-cards').html(cardsHTML);
    
    // Generar tabla Top 10 por Facturas
    let topFacturasHTML = '';
    top10Facturas.forEach((cliente, index) => {
        const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
        topFacturasHTML += `
            <tr>
                <td class="text-center">
                    <span class="rank-badge ${rankClass}">${index + 1}</span>
                </td>
                <td><strong>${cliente.codcli}</strong></td>
                <td>
                    <span class="cliente-nombre" title="${cliente.nombre}">${cliente.nombre}</span>
                </td>
                <td class="text-end"><strong>${cliente.facturas}</strong></td>
                <td class="text-end text-muted">$${cliente.montoTotal.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
            </tr>
        `;
    });
    $('#top-facturas-table tbody').html(topFacturasHTML);
    
    // Generar tabla Top 10 por Monto
    let topMontoHTML = '';
    top10Monto.forEach((cliente, index) => {
        const rankClass = index === 0 ? 'rank-1' : index === 1 ? 'rank-2' : index === 2 ? 'rank-3' : 'rank-other';
        topMontoHTML += `
            <tr>
                <td class="text-center">
                    <span class="rank-badge ${rankClass}">${index + 1}</span>
                </td>
                <td><strong>${cliente.codcli}</strong></td>
                <td>
                    <span class="cliente-nombre" title="${cliente.nombre}">${cliente.nombre}</span>
                </td>
                <td class="text-end text-muted">${cliente.facturas}</td>
                <td class="text-end"><strong>$${cliente.montoTotal.toLocaleString('es-MX', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong></td>
            </tr>
        `;
    });
    $('#top-monto-table tbody').html(topMontoHTML);
}
</script>





{% endblock %}
{% block myjs %}
<script src="{{ JS }}income.js"></script>
<script>
$('#search_cash_invoices_table').on('click', async function() {
     cash_invoices_table();
});

$('#search_invoice_client_desp').on('click', async function() {
     invoice_client_desp();
});



</script>


{% endblock %}