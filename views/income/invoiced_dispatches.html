{% extends "views/layouts/base.html" %}
{% block title %}Despachos Facturados - An√°lisis de Anomal√≠as{% endblock %}
{% block menutitle %}Auditor√≠a de Despachos{% endblock %}

{% block content %}
<style>

  
    :root {
        --primary-color: #3485a8;
        --secondary-bg: #f8f9fa;
        --border-radius: 12px;
    }

    /* --- General Layout --- */
    .content-wrapper { background-color: #f4f6f9; }
    
    .card {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        transition: transform 0.2s ease-in-out;
    }

    /* --- Control Panel --- */
    .control-panel {
        background: #fff;
        padding: 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    .form-floating > label { padding-top: 0.6rem; padding-bottom: 0.6rem; }

    /* --- KPI Cards (Dise√±o Original con Gradientes) --- */
    .kpi-card {
        overflow: hidden;
        position: relative;
        color: #fff;
        min-height: 140px;
    }
    .kpi-card .card-body {
        z-index: 2;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    .kpi-bg-icon {
        position: absolute;
        right: -10px;
        bottom: -20px;
        font-size: 6rem;
        opacity: 0.15;
        transform: rotate(-15deg);
        z-index: 1;
    }
    .kpi-value { font-size: 2rem; font-weight: 700; margin-bottom: 0.2rem; }
    .kpi-label { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; }
    .kpi-sub {
        font-size: 0.8rem;
        background: rgba(0,0,0,0.2);
        padding: 2px 8px;
        border-radius: 10px;
        display: inline-block;
        margin-top: 5px;
        max-width: 100%;
    }
    
    .bg-gradient-info-dark { background: linear-gradient(45deg, #0ea5e9, #2563eb); }
    .bg-gradient-danger-dark { background: linear-gradient(45deg, #ef4444, #b91c1c); }
    .bg-gradient-success-dark { background: linear-gradient(45deg, #10b981, #059669); }
    .bg-gradient-warning-dark { background: linear-gradient(45deg, #f59e0b, #d97706); }

    /* --- Tablas --- */
    .table-card-header {
        background-color: #fff;
        border-bottom: 1px solid #eef2f7;
        padding: 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
    }

    /* Correcci√≥n cr√≠tica para evitar descuadres en DataTables */
    table.dataTable {
        width: 100% !important;
        border-collapse: collapse !important;
    }
    
    table.dataTable thead th {
        background-color: #f8f9fa !important;
        color: #495057 !important;
        border-bottom: 2px solid #dee2e6 !important;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.5px;
        padding-top: 15px;
        padding-bottom: 15px;
        white-space: nowrap; 
    }

    /* --- Pesta√±as (Tabs) Mejoradas --- */
    .nav-tabs { border-bottom: 1px solid #dee2e6; }
    .nav-tabs .nav-link {
        color: #495057;
        background-color: transparent;
        border: 1px solid transparent;
        border-top-left-radius: .25rem;
        border-top-right-radius: .25rem;
        font-weight: 600;
        padding: 10px 15px;
        transition: all 0.2s;
    }
    
    .nav-tabs .nav-link.active {
        color: var(--primary-color) !important;
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
        border-top: 3px solid var(--primary-color) !important;
        box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
    }
    
    .nav-tabs .nav-link:hover:not(.active) {
        background-color: #e9ecef;
        border-color: #e9ecef #e9ecef #dee2e6;
    }

    /* Links y Badges */
    a.link-client-summary { font-weight: 600; color: var(--primary-color); text-decoration: none; }
    a.link-client-summary:hover { text-decoration: underline; }
    
    .badge-anomalies {
        background-color: #fee2e2;
        color: #991b1b;
        padding: 0.4em 0.8em;
        border-radius: 20px;
        font-weight: 700;
        transition: background-color 0.2s;
    }
    .badge-anomalies:hover { background-color: #fca5a5; color: #7f1d1d; }

    /* Barra de Carga */
    #loadbar { 
        height: 4px; background-color: #e9ecef; display: none; 
        width: 100%; position: absolute; top: 0; left: 0; z-index: 10;
    }
    #loadbar .progress-bar { 
        height: 100%; background-color: var(--primary-color); 
        width: 0%; transition: width .2s ease;
    }

    /* Grupos en tabla de tickets */
    tr.group { background-color: #eef2f7 !important; cursor: pointer; }
    tr.group td { font-weight: 600; color: #495057; }

    #client_summary_eval,
#client_summary_m1,
#client_summary_m2,
#client_summary_m3 {
    table-layout: fixed;
}

</style>

<div class="container-fluid">

    <div class="control-panel d-flex flex-wrap align-items-center justify-content-between gap-3">
        <div class="d-flex align-items-center gap-3 flex-grow-1">
            <div class="d-flex align-items-center bg-light rounded p-2 border">
                <i class="fas fa-calendar-alt text-muted mx-2"></i>
                <div class="form-floating" style="min-width: 160px;">
                    <input type="date" id="from" class="form-control border-0 bg-transparent shadow-none" value="{{ 'now'|date('Y-m-01') }}">
                    <label for="from">Desde</label>
                </div>
                <span class="text-muted mx-2">‚ûú</span>
                <div class="form-floating" style="min-width: 160px;">
                    <input type="date" id="until" class="form-control border-0 bg-transparent shadow-none" value="{{ 'now'|date('Y-m-d') }}">
                    <label for="until">Hasta</label>
                </div>
            </div>
        </div>
        <div>
            <button id="btn-run" class="btn btn-primary btn-lg px-4 shadow-sm">
                <i class="fas fa-search me-2"></i> Analizar Despachos
            </button>
        </div>
    </div>

    <div class="row g-3 mb-4" id="summary-cards" style="display:none;">
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card kpi-card bg-gradient-info-dark">
                <div class="card-body">
                    <i class="fas fa-chart-line kpi-bg-icon"></i>
                    <div class="kpi-label">Mayor Prom. Z-Score</div>
                    <div class="kpi-value" id="kpi-zscore-value">‚Äî</div>
                    <div class="kpi-sub text-truncate" id="kpi-zscore-client">Sin datos</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card kpi-card bg-gradient-danger-dark">
                <div class="card-body">
                    <i class="fas fa-calendar-times kpi-bg-icon"></i>
                    <div class="kpi-label">M√°s D√≠as An√≥malos</div>
                    <div class="kpi-value" id="kpi-dias-value">‚Äî</div>
                    <div class="kpi-sub text-truncate" id="kpi-dias-client">Sin datos</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card kpi-card bg-gradient-success-dark">
                <div class="card-body">
                    <i class="fas fa-gas-pump kpi-bg-icon"></i>
                    <div class="kpi-label">M√°s Despachos</div>
                    <div class="kpi-value" id="kpi-despachos-value">‚Äî</div>
                    <div class="kpi-sub text-truncate" id="kpi-despachos-client">Sin datos</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3">
            <div class="card kpi-card bg-gradient-warning-dark">
                <div class="card-body">
                    <i class="fas fa-file-invoice-dollar kpi-bg-icon"></i>
                    <div class="kpi-label">M√°s Facturas/D√≠a</div>
                    <div class="kpi-value" id="kpi-facturasdia-value">‚Äî</div>
                    <div class="kpi-sub text-truncate" id="kpi-facturasdia-client">Sin datos</div>
                </div>
            </div>
        </div>
        
         <div class="col-12 mt-3">
             <div class="card border-0 shadow-sm" style="background: #e2e8f0;">
                 <div class="card-body d-flex align-items-center justify-content-between">
                     <div class="d-flex align-items-center">
                         <div class="bg-white p-2 rounded-circle me-3 shadow-sm">
                             <i class="fas fa-industry text-secondary fs-4"></i>
                         </div>
                         <div>
                             <h6 class="mb-0 text-muted text-uppercase" style="font-size: 0.75rem; letter-spacing: 1px;">Estaci√≥n con m√°s tickets an√≥malos</h6>
                             <h5 class="mb-0 fw-bold text-dark" id="kpi-estacion-name">Pendiente de c√°lculo</h5>
                         </div>
                     </div>
                     <div class="text-end">
                         <div class="fs-4 fw-bold text-dark" id="kpi-estacion-value">‚Äî</div>
                         <small class="text-muted">Tickets</small>
                     </div>
                 </div>
             </div>
         </div>
    </div>

    <div class="card position-relative overflow-hidden">
        <div id="loadbar"><div class="progress-bar"></div></div>

        <div class="table-card-header">
            <h5 class="mb-0 fw-bold text-dark"><i class="fas fa-list-alt me-2 text-primary"></i>Anomal√≠as por Cliente</h5>
            
            <div class="d-flex align-items-center bg-light rounded px-3 py-2">
                <span class="filter-group-label"><i class="fas fa-filter me-1"></i> Filtrar:</span>
                <div class="btn-group" role="group">
                    <input type="checkbox" class="btn-check" id="chk-10plus" autocomplete="off">
                    <label class="btn btn-sm btn-outline-secondary" for="chk-10plus">‚â• 10 Tickets/D√≠a</label>
                    
                    <input type="checkbox" class="btn-check" id="chk-multi-prod" autocomplete="off">
                    <label class="btn btn-sm btn-outline-secondary" for="chk-multi-prod"><i class="fas fa-cubes me-1"></i> Multi-Prod</label>
                    
                    <input type="checkbox" class="btn-check" id="chk-multi-montos" autocomplete="off">
                    <label class="btn btn-sm btn-outline-secondary" for="chk-multi-montos"><i class="fas fa-dollar-sign me-1"></i> Montos Distintos</label>
                </div>
            </div>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="anomalies_table" class="table table-hover w-100 mb-0" style="width:100% !important;">
                    <thead>
                        <tr>
                            <th>Cod. Cliente</th>
                            <th>Cliente</th>
                            <th class="text-center">D√≠as An√≥malos</th>
                            <th class="text-end">Prom. Z-Score</th>
                            <th class="text-end">Despachos</th>
                            <th class="text-end">Facturas</th>
                            <th class="text-end">Monto Total</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot class="bg-light">
                        <tr>
                            <th colspan="2" class="text-end">Totales Generales:</th>
                            <th id="ft_dias" class="text-center fw-bold"></th>
                            <th id="ft_prom_z" class="text-end fw-bold"></th>
                            <th id="ft_desp" class="text-end fw-bold"></th>
                            <th id="ft_fact" class="text-end fw-bold"></th>
                            <th id="ft_mto" class="text-end fw-bold"></th>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

</div>

<div class="modal fade" id="modal-client-summary" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header">
        <div>
            <h5 class="modal-title fw-bold">Resumen de Cliente</h5>
            <small class="text-muted">C√≥digo: <span id="sum-codopr" class="fw-bold text-dark"></span> | Nombre: <span id="sum-cliente" class="fw-bold text-dark"></span></small>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body bg-light">
        
        <div class="card mb-3 border-0 shadow-sm">
            <div class="card-header bg-white fw-bold text-primary border-bottom-0">
                <i class="fas fa-clock me-2"></i> Periodo Evaluado: <span id="sum-periodo-eval" class="text-dark"></span>
            </div>
            <div class="card-body p-0">
                <table id="client_summary_eval" class="table table-sm table-striped mb-0 w-100">
                    <thead class="table-light"><tr><th>Cod.</th><th>Cliente</th><th>Despachos</th><th>Facturas</th><th>Fact x Est</th><th>Cant</th><th>Monto</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

     <div class="row">
    <div class="col-md-12">
         <h6 class="text-muted text-uppercase fs-7 mb-3 mt-2 fw-bold">Historial Reciente</h6>
    </div>
    
    <div class="col-12 mb-3">
        <div class="card border-0 shadow-sm">
            <div class="card-header py-1 px-3 bg-white border-bottom-0">
                <small class="fw-bold text-muted">Mes Anterior: <span id="sum-m3-label"></span></small>
            </div>
            <div class="card-body p-0">
                 <table id="client_summary_m3" class="table table-sm table-hover mb-0 w-100">
                    <thead class="bg-light">
                        <tr>
                            <th>Cod</th>
                            <th>Cliente</th>
                            <th class="text-end">Desp</th>
                            <th class="text-end">Fac</th>
                            <th class="text-end">FxE</th> <th class="text-end">Cant</th>
                            <th class="text-end">Monto</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                 </table>
            </div>
        </div>
    </div>

    <div class="col-12 mb-3">
        <div class="card border-0 shadow-sm">
            <div class="card-header py-1 px-3 bg-white border-bottom-0">
                <small class="fw-bold text-muted">Mes -2: <span id="sum-m2-label"></span></small>
            </div>
            <div class="card-body p-0">
                 <table id="client_summary_m2" class="table table-sm table-hover mb-0 w-100">
                    <thead class="bg-light">
                        <tr><th>Cod</th><th>Cliente</th><th class="text-end">Desp</th><th class="text-end">Fac</th><th class="text-end">FxE</th><th class="text-end">Cant</th><th class="text-end">Monto</th></tr>
                    </thead>
                    <tbody></tbody>
                 </table>
            </div>
        </div>
    </div>

    <div class="col-12 mb-3">
        <div class="card border-0 shadow-sm">
            <div class="card-header py-1 px-3 bg-white border-bottom-0">
                <small class="fw-bold text-muted">Mes -3: <span id="sum-m1-label"></span></small>
            </div>
            <div class="card-body p-0">
                 <table id="client_summary_m1" class="table table-sm table-hover mb-0 w-100">
                    <thead class="bg-light">
                        <tr><th>Cod</th><th>Cliente</th><th class="text-end">Desp</th><th class="text-end">Fac</th><th class="text-end">FxE</th><th class="text-end">Cant</th><th class="text-end">Monto</th></tr>
                    </thead>
                    <tbody></tbody>
                 </table>
            </div>
        </div>
    </div>
</div>

      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modal-client-days" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header">
        <div>
            <h5 class="modal-title fw-bold"><i class="fas fa-search-plus me-2"></i>Detalle de Anomal√≠as</h5>
            <small class="text-muted">Cliente: <span id="mdl-cliente" class="fw-bold text-dark"></span> (<span id="mdl-codopr"></span>)</small>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-0">
        <div class="bg-light px-3 pt-3 border-bottom">
            <ul class="nav nav-tabs border-0" id="clientTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-days-tab" data-bs-toggle="tab" data-bs-target="#tab-days" type="button" role="tab">
                    <i class="fas fa-calendar-day me-2 text-danger"></i>D√≠as An√≥malos
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-tickets-tab" data-bs-toggle="tab" data-bs-target="#tab-tickets" type="button" role="tab">
                    <i class="fas fa-receipt me-2 text-secondary"></i>Lista de Tickets
                </button>
              </li>
            </ul>
        </div>

        <div class="tab-content p-3" id="clientTabsContent">
          <div class="tab-pane fade show active" id="tab-days" role="tabpanel">
            <div class="table-responsive rounded border">
                <table id="client_days_table" class="table table-striped table-hover w-100 mb-0" style="width:100% !important;">
                  <thead class="bg-light">
                    <tr>
                      <th>Fecha</th>
                      <th class="text-end">Facturas d√≠a</th>
                      <th class="text-end">Media hist.</th>
                      <th class="text-end">Desv. hist.</th>
                      <th class="text-end">Z-score</th>
                      <th class="text-end">Inc. % vs hist.</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
            </div>
          </div>

          <div class="tab-pane fade" id="tab-tickets" role="tabpanel">
            <div class="d-flex justify-content-end mb-2 gap-2">
              <button type="button" class="btn btn-sm btn-light border" id="btn-collapse-all-tickets"><i class="fas fa-compress-alt me-1"></i> Colapsar Todo</button>
              <button type="button" class="btn btn-sm btn-light border" id="btn-expand-all-tickets"><i class="fas fa-expand-alt me-1"></i> Expandir Todo</button>
            </div>
            <div class="table-responsive rounded border">
                <table id="client_tickets_table" class="table table-sm table-hover w-100 mb-0" style="width:100% !important;">
                  <thead class="bg-light">
                    <tr>
                      <th>Fecha</th><th>Hora</th><th>Trn</th><th>Fac</th><th>Folio</th><th>Serie</th><th>Concepto</th><th>Estaci√≥n</th>
                      <th>Producto</th><th>Cant</th><th>Monto</th><th>Cliente</th><th>Turno</th><th>Isla</th><th>Resp.</th><th>UUID</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block myjs %}
<script>
// ==========================================
// VARIABLES & UTILIDADES
// ==========================================
let filterRegistered = false;
let dtClientDays = null;
let dtClientTickets = null;
let ticketGroupsCollapsed = {};

// Formateador de hora
function formatHratrnTo12(data, type) {
  if (type !== 'display' && type !== 'filter') return data;
  if (data == null) return '';
  var n = parseInt(data, 10);
  if (isNaN(n)) return data;
  var h24 = Math.floor(n / 100);
  var m   = n % 100;
  var ampm = h24 >= 12 ? 'PM' : 'AM';
  var h12  = h24 % 12;
  if (h12 === 0) h12 = 12;
  return h12.toString().padStart(2, '0') + ':' + m.toString().padStart(2, '0') + ' ' + ampm;
}

// Barra de Carga
let progressTimer = null;
let startTs = 0;
let durationMs = 20000;

function startLoadBar() {
  stopLoadBar(true);
  $('#loadbar').show();
  $('#loadbar .progress-bar').css('width', '0%');
  startTs = performance.now();
  progressTimer = setInterval(function() {
    const elapsed = performance.now() - startTs;
    const pct = Math.min(95, (elapsed / durationMs) * 95);
    $('#loadbar .progress-bar').css('width', pct + '%');
  }, 100);
}
function finishLoadBar() {
  $('#loadbar .progress-bar').css('width', '100%');
  stopLoadBar(false);
  setTimeout(function() { $('#loadbar').fadeOut(150); }, 180);
}
function failLoadBar() { finishLoadBar(); }
function stopLoadBar(resetToZero) {
  if (progressTimer) { clearInterval(progressTimer); progressTimer = null; }
  if (resetToZero) $('#loadbar .progress-bar').css('width','0%');
}

// Filtros DataTables
function registerTenPlusFilter(){
  if (filterRegistered) return;
  $.fn.dataTable.ext.search.push(function(settings, data, dataIndex){
    if (settings.nTable && settings.nTable.id !== 'anomalies_table') return true;
    const api = new $.fn.dataTable.Api(settings);
    const row = api.row(dataIndex).data() || {};
    
    const only10         = $('#chk-10plus').prop('checked');
    const onlyMultiProd  = $('#chk-multi-prod').prop('checked');
    const onlyMultiMonto = $('#chk-multi-montos').prop('checked');

    const maxDia         = Number(row.max_facturas_dia || 0);
    const hasMultiProd   = Number(row.tiene_factura_multi_prod || 0) > 0;
    const hasMultiMontos = Number(row.tiene_factura_montos_diferentes || 0) > 0;

    if (only10 && maxDia < 10) return false;
    if (onlyMultiProd && !hasMultiProd) return false;
    if (onlyMultiMonto && !hasMultiMontos) return false;
    return true;
  });
  filterRegistered = true;
}

// ==========================================
// KPIS & FOOTERS
// ==========================================
function updateHighlightCards(rows){
  if (!rows || !rows.length){ $('#summary-cards').hide(); return; }
  $('#summary-cards').show();

  let bestZ = null, bestZVal = -Infinity;
  let bestDias = null, bestDiasVal = -Infinity;
  let bestDesp = null, bestDespVal = -Infinity;
  let bestFactDia = null, bestFactDiaVal = -Infinity;

  rows.forEach(r => {
    const z    = parseFloat(r.prom_zscore ?? 0)       || 0;
    const dias = parseInt(r.dias_anomalos ?? 0, 10)   || 0;
    const desp = parseInt(r.n_despachos ?? 0, 10)     || 0;
    const maxF = parseInt(r.max_facturas_dia ?? 0,10) || 0;

    if (z > bestZVal)           { bestZVal = z;       bestZ = r; }
    if (dias > bestDiasVal)     { bestDiasVal = dias; bestDias = r; }
    if (desp > bestDespVal)     { bestDespVal = desp; bestDesp = r; }
    if (maxF > bestFactDiaVal)  { bestFactDiaVal = maxF; bestFactDia = r; }
  });

  const fmtNum = (n) => n.toLocaleString('es-MX');
  const fmtDec = (n) => n.toLocaleString('es-MX',{minimumFractionDigits:2, maximumFractionDigits:2});
  const setTxt = (id, val) => $(id).text(val);

  setTxt('#kpi-zscore-value', bestZ ? fmtDec(bestZVal) : '‚Äî');
  setTxt('#kpi-zscore-client', bestZ ? `${bestZ.cliente || 'Sin nombre'} (${bestZ.codopr})` : 'Sin datos');

  setTxt('#kpi-dias-value', bestDias ? fmtNum(bestDiasVal) : '‚Äî');
  setTxt('#kpi-dias-client', bestDias ? `${bestDias.cliente || 'Sin nombre'} (${bestDias.codopr})` : 'Sin datos');

  setTxt('#kpi-despachos-value', bestDesp ? fmtNum(bestDespVal) : '‚Äî');
  setTxt('#kpi-despachos-client', bestDesp ? `${bestDesp.cliente || 'Sin nombre'} (${bestDesp.codopr})` : 'Sin datos');

  setTxt('#kpi-facturasdia-value', bestFactDia ? fmtNum(bestFactDiaVal) : '‚Äî');
  setTxt('#kpi-facturasdia-client', bestFactDia ? `${bestFactDia.cliente || 'Sin nombre'} (${bestFactDia.codopr})` : 'Sin datos');
}

function updateFooters(api){
  const rows = api.rows({ search: 'applied' }).data().toArray();
  const sum = (arr, sel) => arr.reduce((s, r) => s + (parseFloat(sel(r)) || 0), 0);
  const n = rows.length || 1;

  const totalDias   = sum(rows, r => r.dias_anomalos);
  const totalDesp   = sum(rows, r => r.n_despachos);
  const totalFact   = sum(rows, r => r.facturas_unicas);
  const totalMonto  = sum(rows, r => r.total_mto);
  const promZ       = sum(rows, r => r.prom_zscore) / n;

  $('#ft_dias').text(totalDias.toLocaleString('es-MX'));
  $('#ft_prom_z').text(promZ.toLocaleString('es-MX', {minimumFractionDigits:2}));
  $('#ft_desp').text(totalDesp.toLocaleString('es-MX'));
  $('#ft_fact').text(totalFact.toLocaleString('es-MX'));
  $('#ft_mto').text(totalMonto.toLocaleString('es-MX', {minimumFractionDigits:2}));

  updateHighlightCards(rows);
}

function loadTopStation(from, until) {
  $('#kpi-estacion-value').text('‚Ä¶');
  $('#kpi-estacion-name').text('Calculando...');
  $.post('/income/anomalies_top_station', { from: from, until: until }, function (resp) {
    if (!resp || !resp.data || !resp.data.length) {
      $('#kpi-estacion-value').text('‚Äî');
      $('#kpi-estacion-name').text('Sin datos');
      return;
    }
    const top = resp.data[0];
    $('#kpi-estacion-value').text((top.tickets_anomalos || 0).toLocaleString('es-MX'));
    $('#kpi-estacion-name').text((top.estacion || 'Sin nombre'));
  }, 'json').fail(function () {
    $('#kpi-estacion-value').text('‚Äî'); $('#kpi-estacion-name').text('Error');
  });
}

// ==========================================
// CARGA DE MODALES (L√≥gica Original)
// ==========================================

// Modal 1: Detalle (Days/Tickets)
function loadClientDetail(codopr, cliente) {
  const from  = $('#from').val();
  const until = $('#until').val();
  ticketGroupsCollapsed = {}; 

  $('#mdl-codopr').text(codopr);
  $('#mdl-cliente').text(cliente || '');

  if ($.fn.DataTable.isDataTable('#client_days_table')) $('#client_days_table').DataTable().destroy();
  if ($.fn.DataTable.isDataTable('#client_tickets_table')) $('#client_tickets_table').DataTable().destroy();

  // TAB 1
  dtClientDays = $('#client_days_table').DataTable({
    order: [[0, "asc"]],
    dom: 't',
    paging: false,
    ajax: {
      type: 'POST', url: '/income/anomalies_client_days',
      data: { from, until, codopr }
    },
    columns: [
      { data: 'fecha', className: 'text-nowrap' },
      { data: 'facturas_dia', className: 'text-end', render: $.fn.dataTable.render.number(',','.',0) },
      { data: 'baseline_media_hist', className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) },
      { data: 'baseline_desv_hist', className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) },
      { data: 'zscore_hist', className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) },
      { data: 'incremento_pct_vs_hist', className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) }
    ]
  });

  // TAB 2
  dtClientTickets = $('#client_tickets_table').DataTable({
    order: [[4, "asc"], [0, "asc"], [1, "asc"]],
    dom: '<"d-flex justify-content-between mb-2"Bf>rt<"d-flex justify-content-between mt-2"ip>',
    pageLength: 10,
    lengthMenu: [[10,25,50,-1],[10,25,50,"Todos"]],
    buttons: [{ extend: 'excel', className: 'btn btn-sm btn-success', text: 'Excel' }],
    ajax: {
      type: 'POST', url: '/income/anomalies_client_tickets',
      data: { from, until, codopr }
    },
    columns: [
      { data: 'fecha', className: 'text-nowrap' },
      { data: 'hratrn', className: 'text-nowrap', render: formatHratrnTo12 },
      { data: 'nrotrn', className: 'text-end' },
      { data: 'nrofac', className: 'text-end' },
      { data: 'factura', className: 'text-end' },
      { data: 'serie', className: 'text-center' },
      { data: 'conceptofac' },
      { data: 'estacion' },
      { data: 'nomPrd' },
      { data: 'can', className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) },
      { data: 'mto', className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) },
      { data: 'nombreCliente' },
      { data: 'turno', className: 'text-center' },
      { data: 'isla' },
      { data: 'responsable' },
      { data: 'satuid' }
    ],
    drawCallback: function (settings) {
      var api  = this.api();
      var rows = api.rows({ page: 'current' }).nodes();
      var lastFactura = null;
      api.column(4, { page: 'current' }).data().each(function (factura, i) {
        var key = factura == null ? '' : String(factura);
        if (!(key in ticketGroupsCollapsed)) { ticketGroupsCollapsed[key] = true; }
        var collapsed = ticketGroupsCollapsed[key] === true;
        var icon = collapsed ? '<i class="fas fa-caret-right text-muted"></i>' : '<i class="fas fa-caret-down text-primary"></i>';
        if (lastFactura !== key) {
          $(rows).eq(i).before('<tr class="group" data-factura="'+ key.replace(/"/g,'&quot;') +'"><td colspan="16" class="py-2"><span class="me-2">'+ icon +'</span><strong>Factura: ' + (key || '(sin folio)') + '</strong></td></tr>');
          lastFactura = key;
        }
        collapsed ? $(rows).eq(i).addClass('d-none') : $(rows).eq(i).removeClass('d-none');
      });
    }
  });

  var modalEl = document.getElementById('modal-client-days');
  var modal = new bootstrap.Modal(modalEl);
  modal.show();
}

// Modal 2: Resumen (Historical)
function initSummaryTable($table, rows) {
  if ($.fn.DataTable.isDataTable($table)) {
    $table.DataTable().destroy();
  }
  $table.find('tbody').empty();

  $table.DataTable({
    data: rows || [],
    paging: false,
    searching: false,
    info: false,
    ordering: false,
    dom: 't',
    autoWidth: false, // üëà importante

    columns: [
      { // Cod
        data: 'codopr',
        className: 'text-end text-muted',
        width: '8%'
      },
      { // Cliente
        data: 'nombreCliente',
        className: 'fw-bold',
        width: '32%'
      },
      { // Despachos
        data: 'n_despachos',
        className: 'text-end',
        render: $.fn.dataTable.render.number(',', '.', 0),
        width: '12%'
      },
      { // Facturas
        data: 'facturas_unicas',
        className: 'text-end',
        render: $.fn.dataTable.render.number(',', '.', 0),
        width: '12%'
      },
      { // Fact x Est (oculta)
        data: 'facturas_codgas_unicas',
        className: 'text-end',
        visible: false
      },
      { // Cant
        data: 'total_cant',
        className: 'text-end',
        render: $.fn.dataTable.render.number(',', '.', 2),
        width: '18%'
      },
      { // Monto
        data: 'total_mto',
        className: 'text-end fw-bold text-primary',
        render: $.fn.dataTable.render.number(',', '.', 2),
        width: '18%'
      }
    ]
  });
}



function loadClientSummary(codopr, cliente) {
  const from  = $('#from').val();
  const until = $('#until').val();

  $('#sum-codopr').text(codopr);
  $('#sum-cliente').text(cliente || '');
  $('#sum-periodo-eval').text(from + ' al ' + until);
  $('#sum-m1-label').text(''); $('#sum-m2-label').text(''); $('#sum-m3-label').text('');

  ['#client_summary_eval','#client_summary_m1','#client_summary_m2','#client_summary_m3'].forEach(sel => {
      $(sel).find('tbody').html('<tr><td colspan="7" class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm text-primary" role="status"></div> Cargando...</td></tr>');
  });

$.post('/income/anomalies_client_summary', { from: from, until: until, codopr: codopr }, function(resp) {
  initSummaryTable($('#client_summary_eval'), resp.data_eval || []);
  initSummaryTable($('#client_summary_m1'),   resp.data_m1   || []);
  initSummaryTable($('#client_summary_m2'),   resp.data_m2   || []);
  initSummaryTable($('#client_summary_m3'),   resp.data_m3   || []);

  if (resp.m1_label) $('#sum-m1-label').text(resp.m1_label);
  if (resp.m2_label) $('#sum-m2-label').text(resp.m2_label);
  if (resp.m3_label) $('#sum-m3-label').text(resp.m3_label);
}, 'json');


  const modalEl = document.getElementById('modal-client-summary');
  const modal   = new bootstrap.Modal(modalEl);
  modal.show();
}

// ==========================================
// CARGA PRINCIPAL
// ==========================================
function loadAnomalies(){
  if ($.fn.DataTable.isDataTable('#anomalies_table')) { $('#anomalies_table').DataTable().destroy(); }
  registerTenPlusFilter();
  const from  = $('#from').val();
  const until = $('#until').val();

  loadTopStation(from, until);

  const dt = $('#anomalies_table').DataTable({
  order: [[3, "desc"], [0, "asc"]],
  // Agregamos B (Buttons) al dom, junto al filtro
  dom: '<"row mb-2"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6 d-flex justify-content-end"Bf>>rt<"row mt-2"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
  paging: true, pageLength: 50,
  lengthMenu: [[10,25,50,100,-1],[10,25,50,100,"Todos"]],
  deferRender: true,
  language: { 
    search: "_INPUT_", 
    searchPlaceholder: "Buscar cliente..." 
  },

  // üîπ Botones
  buttons: [
    {
      extend: 'excelHtml5',
      text: '<i class="fas fa-file-excel me-1"></i> Excel',
      titleAttr: 'Exportar a Excel',
      className: 'btn btn-sm btn-outline-success',
      exportOptions: {
        // ajusta columnas seg√∫n lo que quieras exportar
        columns: ':visible'
      }
    }
  ],
    ajax: {
      type: 'POST', url: '/income/anomalies_clients_table',
      data: { from, until },
      beforeSend: startLoadBar, complete: finishLoadBar, error: failLoadBar
    },
    columns: [
      { data: 'codopr', className: 'text-muted text-nowrap' },
      { 
        data: 'cliente',
        render: function(data, type, row){
          if (type !== 'display') return data;
          // LINK 1: Resumen (Historical)
          return `<a href="#" class="link-client-summary text-decoration-none" data-codopr="${row.codopr}" data-cliente="${(data||'').replace(/"/g,'&quot;')}">
                    <i class="fas fa-user-tie me-1 text-secondary opacity-50"></i> ${data || 'Sin nombre'}
                  </a>`;
        }
      },
      {
        data: 'dias_anomalos', className: 'text-center',
        render: function(data, type, row){
          if (type === 'display') {
            var val = data || 0;
            if (val > 0) {
              // LINK 2: Detalle (Days/Tickets)
              return `<a href="#" class="link-dias-anom badge-anomalies text-decoration-none" data-codopr="${row.codopr}" data-cliente="${(row.cliente||'').replace(/"/g, '&quot;')}">
                        ${val} <i class="fas fa-exclamation-circle ms-1"></i>
                      </a>`;
            }
            return '<span class="text-muted">-</span>';
          }
          return data;
        }
      },
      { data: 'prom_zscore', className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) },
      { data: 'n_despachos', className: 'text-end', render: $.fn.dataTable.render.number(',','.',0) },
      { data: 'facturas_unicas', className: 'text-end', render: $.fn.dataTable.render.number(',','.',0) },
      { data: 'total_mto', className: 'text-end fw-bold', render: $.fn.dataTable.render.number(',','.',2) }
    ],
    initComplete: function(){ updateFooters(this.api()); }
  });

  $('#chk-10plus, #chk-multi-prod, #chk-multi-montos').off('change').on('change', function(){ dt.draw(); });
  dt.on('draw', function(){ updateFooters(dt); });

  // Event listeners para los dos tipos de link en la tabla
  $('#anomalies_table tbody').off('click', 'a.link-dias-anom').on('click', 'a.link-dias-anom', function(e){
    e.preventDefault();
    loadClientDetail($(this).data('codopr'), $(this).data('cliente'));
  });

  $('#anomalies_table tbody').off('click', 'a.link-client-summary').on('click', 'a.link-client-summary', function(e){
    e.preventDefault();
    loadClientSummary($(this).data('codopr'), $(this).data('cliente'));
  });
}

// ==========================================
// EVENTOS GLOBALES Y CORRECCIONES DE UI
// ==========================================
$(document).ready(function() {
    $('#btn-run').on('click', loadAnomalies);

    // --- CORRECCI√ìN: Ajustar columnas al cambiar de pesta√±a ---
    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        $($.fn.dataTable.tables(true)).DataTable().columns.adjust();
    });
    
    // --- CORRECCI√ìN: Ajustar columnas al abrir modales ---
    $('#modal-client-days').on('shown.bs.modal', function () {
        if(dtClientDays) dtClientDays.columns.adjust();
        if(dtClientTickets) dtClientTickets.columns.adjust();
    });

// Evento para ajustar columnas SOLO cuando el modal termina de abrirse
$('#modal-client-summary').on('shown.bs.modal', function () {
    // Lista de las 4 tablas dentro de este modal
    const tables = [
        '#client_summary_eval', 
        '#client_summary_m1', 
        '#client_summary_m2', 
        '#client_summary_m3'
    ];

    tables.forEach(selector => {
        // Solo ajustamos si la tabla es un DataTable activo
        if ($.fn.DataTable.isDataTable(selector)) {
            $(selector).DataTable().columns.adjust();
        }
    });
  });

});

// Helpers de UI para Tickets
$('#client_tickets_table tbody').on('click', 'tr.group', function () {
  var factura = $(this).data('factura') || '';
  var key = String(factura);
  ticketGroupsCollapsed[key] = !ticketGroupsCollapsed[key];
  var api = $('#client_tickets_table').DataTable();
  
  var $icon = $(this).find('span').first();
  $icon.html(ticketGroupsCollapsed[key] ? '<i class="fas fa-caret-right text-muted"></i>' : '<i class="fas fa-caret-down text-primary"></i>');

  api.rows({ page: 'current' }).every(function () {
      var d = this.data();
      if(d && String(d.factura) === key) {
          ticketGroupsCollapsed[key] ? $(this.node()).addClass('d-none') : $(this.node()).removeClass('d-none');
      }
  });
});

$('#btn-collapse-all-tickets').on('click', function () {
  if (!dtClientTickets) return;
  dtClientTickets.column(4).data().each(function (factura) { ticketGroupsCollapsed[String(factura)] = true; });
  dtClientTickets.draw(false);
});

$('#btn-expand-all-tickets').on('click', function () {
  if (!dtClientTickets) return;
  dtClientTickets.column(4).data().each(function (factura) { ticketGroupsCollapsed[String(factura)] = false; });
  dtClientTickets.draw(false);
});
</script>
{% endblock %}