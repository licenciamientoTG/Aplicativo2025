{% extends "views/layouts/base.html" %}
{% block title %}Anomal√≠as por Cliente{% endblock %}
{% block mycss %}{% endblock %}
{% block menutitle %}Anomal√≠as por Cliente{% endblock %}

{% block content %}
<style>

    /* Que cabecera y celdas de la lista de tickets no se rompan en varias l√≠neas */
  #client_tickets_table th,
  #client_tickets_table td {
    white-space: nowrap;
  }
  tr.group, tr.group:hover { background-color: rgba(0,0,0,0.1) !important; }
  :root.dark tr.group, :root.dark tr.group:hover { background-color: rgba(0,0,0,0.75) !important; }
  .column_estation{ background-color:#add5e6 !important; color:#fff !important; }
  .total_bg{ background-color:#48A1C7 !important; color:#fff !important; }
  .total_bg2{ background-color:#48A1C7 !important; color:#fff !important; }
  .border_center{
    border-top:1px dotted #358f92 !important; border-bottom:1px dotted #358f92 !important;
    border-left:1px dotted #358f92 !important; border-right:1px dotted #358f92 !important;
  }
  table.dataTable thead th, table.dataTable thead td{
    padding:10px 18px; border-bottom:1px solid #dee2e6; background-color:#3485a8 !important; color:#fff !important;
  }
  table.dataTable tfoot th, table.dataTable tfoot td{
    padding:10px 18px; border-bottom:1px solid #dee2e6; background-color:#3485a8 !important; color:#fff !important;
  }
  .border_OG{ border:0.5px solid #0c202091 !important; background-color:#6d7277e8; }

  /* Barra de progreso (ancho de la tabla) */
  #loadbar { height: 6px; background-color: rgba(52,133,168,0.2); display: none; overflow: hidden; }
  #loadbar .progress-bar { height: 100%; background-color: #3485a8; transition: width .2s ease; width: 0%; }

    /* Grupos clickeables en lista de tickets */
  #client_tickets_table tr.group {
    cursor: pointer;
    font-weight: bold;
  }

</style>

<!-- Filtros de fecha -->
<div class="card mb-3">
  <div class="card-body">
    <div class="row g-2 align-items-end">
      <div class="col-12 col-sm-3">
        <label class="col-form-label-sm">Desde</label>
        <input type="date" id="from" class="form-control form-control-sm" value="{{ 'now'|date('Y-m-01') }}" required>
      </div>
      <div class="col-12 col-sm-3">
        <label class="col-form-label-sm">Hasta</label>
        <input type="date" id="until" class="form-control form-control-sm" value="{{ 'now'|date('Y-m-d') }}" required>
      </div>
      <div class="col-12 col-sm-3">
        <button id="btn-run" class="btn btn-sm btn-primary w-100" style="margin-top: 15px;">Generar</button>
      </div>
    </div>
  </div>
</div>

<!-- Tabla principal + filtros de anomal√≠as -->
<div class="card">

  <!-- Filtros en una sola fila -->
  <div class="card-body pb-0">
    <div class="d-flex flex-wrap align-items-center mb-3">

      <div class="form-check form-switch me-4 mt-2">
        <input class="form-check-input ms-1" type="checkbox" id="chk-10plus">
        <label class="form-check-label ms-2" for="chk-10plus">
          ‚â• 10 tickets en un d√≠a
        </label>
      </div>

      <!-- filtro por facturas con varios productos -->
      <div class="form-check form-switch me-4 mt-2">
        <input class="form-check-input ms-1" type="checkbox" id="chk-multi-prod">
        <label class="form-check-label ms-2" for="chk-multi-prod">
          Factura con varios productos
        </label>
      </div>

      <!-- filtro por facturas con montos distintos -->
      <div class="form-check form-switch me-4 mt-2">
        <input class="form-check-input ms-1" type="checkbox" id="chk-multi-montos">
        <label class="form-check-label ms-2" for="chk-multi-montos">
          Factura con montos distintos
        </label>
      </div>

    </div>
  </div>

  <div class="card-header"><h5 class="mb-0">Anomal√≠as por Cliente</h5></div>
  <div class="card-body table-responsive">
    <!-- Barra de progreso -->
    <div id="loadbar" class="mb-2">
      <div class="progress-bar" role="progressbar"></div>
    </div>

    <table id="anomalies_table" class="table table-striped table-hover table-sm w-100">
      <thead>
        <tr class="titles">
          <th>Cod. Cliente (codopr)</th>
          <th>Cliente</th>
          <th>D√≠as an√≥malos</th>
          <th>Prom. z-score</th>
          <th>Despachos</th>
          <th>Facturas</th>
          <th>Monto</th>
        </tr>
      </thead>

      <tbody></tbody>
        <tfoot>
          <tr>
            <th colspan="2" class="text-end">Totales:</th>
            <th id="ft_dias"    class="text-end"></th>
            <th id="ft_prom_z"  class="text-end"></th>
            <th id="ft_desp"    class="text-end"></th>
            <th id="ft_fact"    class="text-end"></th>
            <th id="ft_mto"     class="text-end"></th>
          </tr>
        </tfoot>

    </table>
  </div>
</div>

<!-- MODAL: detalle por cliente (tabs: d√≠as an√≥malos / lista de tickets) -->
<div class="modal fade" id="modal-client-days" tabindex="-1" aria-labelledby="modalClientDaysLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalClientDaysLabel">
          Detalle - Cliente <span id="mdl-codopr"></span>
          <small class="text-muted">(<span id="mdl-cliente"></span>)</small>
        </h5>

        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">

        <!-- NAV TABS -->
        <ul class="nav nav-tabs" id="clientTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-days-tab"
                    data-bs-toggle="tab" data-bs-target="#tab-days"
                    type="button" role="tab" aria-controls="tab-days" aria-selected="true">
              D√≠as an√≥malos
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-tickets-tab"
                    data-bs-toggle="tab" data-bs-target="#tab-tickets"
                    type="button" role="tab" aria-controls="tab-tickets" aria-selected="false">
              Lista de tickets
            </button>
          </li>
        </ul>

        <div class="tab-content pt-3" id="clientTabsContent">

          <!-- TAB 1: D√≠as an√≥malos -->
          <div class="tab-pane fade show active" id="tab-days" role="tabpanel" aria-labelledby="tab-days-tab">
            <table id="client_days_table" class="table table-striped table-hover table-sm w-100">
              <thead>
                <tr class="titles">
                  <th>Fecha</th>
                  <th>Facturas d√≠a</th>
                  <th>Media hist.</th>
                  <th>Desv. hist.</th>
                  <th>Q1</th>
                  <th>Q3</th>
                  <th>Z-score</th>
                  <th>Inc. % vs hist.</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

<!-- TAB 2: Lista de tickets -->
<div class="tab-pane fade" id="tab-tickets" role="tabpanel" aria-labelledby="tab-tickets-tab">

  <div class="mb-2 d-flex flex-wrap gap-2">
    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-collapse-all-tickets">
      Colapsar todas las facturas
    </button>
    <button type="button" class="btn btn-sm btn-outline-secondary" id="btn-expand-all-tickets">
      Expandir todas las facturas
    </button>
  </div>

  <table id="client_tickets_table" class="table table-striped table-hover table-sm w-100">
    <thead>
      <tr class="titles">
        <th>Fecha</th>
        <th>Hora</th>
        <th>Transacci√≥n</th>
        <th>Factura</th>
        <th>Folio</th>
        <th>Serie</th>
        <th>Concepto</th>
        <th>Cod. gas</th>
        <th>Estaci√≥n</th>
        <th>C√≥d. prod.</th>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Monto</th>
        <th>C√≥d. cliente (D)</th>
        <th>Nombre cliente</th>
        <th>Codopr (F)</th>
        <th>Isla</th>
        <th>Responsable</th>
        <th>Tipo trn</th>
        <th>Referencia</th>
        <th>UUID</th>
        <th>RFC facturaci√≥n</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


        </div>

      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block myjs %}
<script>

// --- Filtro global (registrar una sola vez) ---
let filterRegistered = false;
function registerTenPlusFilter(){
  if (filterRegistered) return;

  $.fn.dataTable.ext.search.push(function(settings, data, dataIndex){
    if (settings.nTable && settings.nTable.id !== 'anomalies_table') return true;

    const api = new $.fn.dataTable.Api(settings);
    const row = api.row(dataIndex).data() || {};

    const only10         = $('#chk-10plus').prop('checked');
    const onlyMultiProd  = $('#chk-multi-prod').prop('checked');
    const onlyMultiMonto = $('#chk-multi-montos').prop('checked');

    const maxDia         = Number(row.max_facturas_dia || 0);
    const hasMultiProd   = Number(row.tiene_factura_multi_prod || 0) > 0;
    const hasMultiMontos = Number(row.tiene_factura_montos_diferentes || 0) > 0;

    // ‚â• 10 tickets en un d√≠a
    if (only10 && maxDia < 10) return false;

    // factura con varios productos
    if (onlyMultiProd && !hasMultiProd) return false;

    // factura con montos distintos
    if (onlyMultiMonto && !hasMultiMontos) return false;

    return true;
  });

  filterRegistered = true;
}

/* ===== Barra de progreso ===== */
let progressTimer = null;
let startTs = 0;
let durationMs = 8000;

function startLoadBar() {
  stopLoadBar(true);
  const $wrap = $('#loadbar');
  const $bar  = $('#loadbar .progress-bar');
  startTs = performance.now();
  $bar.css('width', '0%');
  $wrap.show();
  progressTimer = setInterval(function() {
    const elapsed = performance.now() - startTs;
    const pct = Math.min(95, (elapsed / durationMs) * 95);
    $bar.css('width', pct + '%');
  }, 100);
}
function finishLoadBar() {
  const $bar = $('#loadbar .progress-bar');
  $bar.css('width', '100%');
  stopLoadBar(false);
  setTimeout(function() { $('#loadbar').fadeOut(150); }, 180);
}
function failLoadBar() { finishLoadBar(); }
function stopLoadBar(resetToZero) {
  if (progressTimer) { clearInterval(progressTimer); progressTimer = null; }
  if (resetToZero) $('#loadbar .progress-bar').css('width','0%');
}

/* ===== Totales ===== */
function updateFooters(api){
  const rows = api.rows({ search: 'applied' }).data().toArray();
  const sum = function(arr, sel) { 
    return arr.reduce(function(s, r) { 
      return s + (parseFloat(sel(r)) || 0); 
    }, 0); 
  };
  const n = rows.length || 1;

  const totalDias   = sum(rows, r => r.dias_anomalos);
  const totalDesp   = sum(rows, r => r.n_despachos);
  const totalFact   = sum(rows, r => r.facturas_unicas);
  const totalMonto  = sum(rows, r => r.total_mto);
  const promZ       = sum(rows, r => r.prom_zscore) / n;

  $('#ft_dias').text(totalDias.toLocaleString('es-MX'));
  $('#ft_prom_z').text(promZ.toLocaleString('es-MX', {minimumFractionDigits:2, maximumFractionDigits:2}));
  $('#ft_desp').text(totalDesp.toLocaleString('es-MX'));
  $('#ft_fact').text(totalFact.toLocaleString('es-MX'));
  $('#ft_mto').text(totalMonto.toLocaleString('es-MX', {minimumFractionDigits:2, maximumFractionDigits:2}));
}


/* ===== Detalles por cliente: d√≠as an√≥malos + tickets ===== */
let dtClientDays = null;
let dtClientTickets = null;

let ticketGroupsCollapsed = {}; 

function formatHratrnTo12(data, type) {
  if (type !== 'display' && type !== 'filter') return data;
  if (data == null) return '';

  // hratrn llega como n√∫mero tipo 935, 1430, etc.
  var n = parseInt(data, 10);
  if (isNaN(n)) return data;

  // Mismo c√°lculo que en SQL:
  // DATEADD(MINUTE, hratrn % 100, DATEADD(HOUR, hratrn / 100, 0))
  var h24 = Math.floor(n / 100);  // horas
  var m   = n % 100;              // minutos

  // Convertir a 12h
  var ampm = h24 >= 12 ? 'PM' : 'AM';
  var h12  = h24 % 12;
  if (h12 === 0) h12 = 12;

  return h12.toString().padStart(2, '0') + ':' +
         m.toString().padStart(2, '0') + ' ' + ampm;
}


function loadClientDetail(codopr, cliente) {
  const from  = $('#from').val();
  const until = $('#until').val();

   ticketGroupsCollapsed = {}; // reset por cliente

  $('#mdl-codopr').text(codopr);
  $('#mdl-cliente').text(cliente || '');

  // Destruir si ya existen
  if ($.fn.DataTable.isDataTable('#client_days_table')) {
    $('#client_days_table').DataTable().destroy();
  }
  if ($.fn.DataTable.isDataTable('#client_tickets_table')) {
    $('#client_tickets_table').DataTable().destroy();
  }

  // TAB 1: d√≠as an√≥malos
  dtClientDays = $('#client_days_table').DataTable({
  order: [[6, "desc"], [0, "asc"]],
  dom: '<"top"Bf>rt', 
  paging: false,
  info: false,
  lengthChange: false,
  buttons: [{ extend: 'excel', className: 'btn btn-success', text: 'Excel', exportOptions: {
    columns: ':visible'   // solo columnas visibles
  } }],
  searchDelay: 350,
  scrollX: true,
  deferRender: true,
  ajax: {
    type: 'POST',
    url: '/income/anomalies_client_days',
    data: { from: from, until: until, codopr: codopr }
  },
  columns: [
    { data: 'fecha',                className: 'text-nowrap' },
    { data: 'facturas_dia',         className: 'text-end', render: $.fn.dataTable.render.number(',','.',0) },
    { data: 'baseline_media_hist',  className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) },
    { data: 'baseline_desv_hist',   className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) },
    { data: 'q1_hist',              className: 'text-end', render: $.fn.dataTable.render.number(',','.',2), visible: false },
    { data: 'q3_hist',              className: 'text-end', render: $.fn.dataTable.render.number(',','.',2), visible: false },
    { data: 'zscore_hist',          className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) },
    { data: 'incremento_pct_vs_hist', className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) }
  ]
});


 // TAB 2: lista de tickets
dtClientTickets = $('#client_tickets_table').DataTable({
  // orden: primero por Factura (col 4), luego fecha/hora
  order: [[4, "asc"], [0, "asc"], [1, "asc"]],
  dom: '<"top"Bf>rt<"bottom"ip>',  // ‚Üê aqu√≠ entra la B
  pageLength: 25,
  lengthMenu: [[10,25,50,100,-1],[10,25,50,100,"Todos"]],
  buttons: [{ extend: 'excel', className: 'btn btn-success', text: 'Excel',  exportOptions: {
    columns: ':visible'   // solo columnas visibles
  } }],
  searchDelay: 350,
  scrollX: true,
  deferRender: true,
  ajax: {
    type: 'POST',
    url: '/income/anomalies_client_tickets',
    data: { from: from, until: until, codopr: codopr }
  },
  columns: [
    { data: 'fecha',   className: 'text-nowrap' },

    {
      data: 'hratrn',
      className: 'text-nowrap',
      render: function (data, type, row) {
        return formatHratrnTo12(data, type); // usando tu helper
      }
    },

    { data: 'nrotrn',  className: 'text-end' },
    { data: 'nrofac',  className: 'text-end' },
    { data: 'factura', className: 'text-end' },          // agrupamos por esta
    { data: 'serie',   className: 'text-center' },
    { data: 'conceptofac' },

    { data: 'codgas',  className: 'text-end', visible: false },
    { data: 'estacion' },
    { data: 'codprd',  className: 'text-end', visible: false },
    { data: 'nomPrd' },
    { data: 'can',     className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) },
    { data: 'mto',     className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) },
    { data: 'codcli_d',    className: 'text-end', visible: false },
    { data: 'nombreCliente' },
    { data: 'codopr_f',    className: 'text-end', visible: false },
    { data: 'isla' },
    { data: 'responsable' },
    { data: 'tiptrn',  visible: false },
    { data: 'datref',  visible: false },
    { data: 'satuid' },
    { data: 'satrfc',  visible: false }
  ],

  // === Agrupar por Factura y hacer grupos plegables ===
drawCallback: function (settings) {
  var api  = this.api();
  var rows = api.rows({ page: 'current' }).nodes();
  var lastFactura = null;

  api.column(4, { page: 'current' }).data().each(function (factura, i) {
    var key = factura == null ? '' : String(factura);

    // üö© Si no tenemos estado guardado, por defecto: colapsado = true
    if (!(key in ticketGroupsCollapsed)) {
      ticketGroupsCollapsed[key] = true;
    }

    var collapsed = ticketGroupsCollapsed[key] === true;
    var icon = collapsed ? '&#x25B6;' : '&#x25BC;'; // ‚ñ∂ si colapsado, ‚ñº si expandido

    if (lastFactura !== key) {
      $(rows).eq(i).before(
        '<tr class="group" data-factura="'+ key.replace(/"/g,'&quot;') +'">' +
          '<td colspan="22">' +
            '<span class="me-2">'+ icon +'</span>' +
            'Factura: ' + (key || '(sin folio)') +
          '</td>' +
        '</tr>'
      );
      lastFactura = key;
    }

    // ocultar/mostrar filas seg√∫n el estado del grupo
    if (collapsed) {
      $(rows).eq(i).addClass('d-none');
    } else {
      $(rows).eq(i).removeClass('d-none');
    }
  });
}
});

  // Abrir modal
  var modalEl = document.getElementById('modal-client-days');
  var modal = new bootstrap.Modal(modalEl);
  modal.show();

  // Siempre arrancar en la primera pesta√±a al abrir
  var firstTabTrigger = document.querySelector('#tab-days-tab');
  if (firstTabTrigger) {
    var tab = new bootstrap.Tab(firstTabTrigger);
    tab.show();
  }
}

/* ===== DataTable principal ===== */
function loadAnomalies(){
  if ($.fn.DataTable.isDataTable('#anomalies_table')) {
    $('#anomalies_table').DataTable().destroy();
  }

  registerTenPlusFilter(); // ‚Üê asegurar filtro registrado

  const from  = $('#from').val();
  const until = $('#until').val();

const dt = $('#anomalies_table').DataTable({
  order: [[3, "desc"], [0, "asc"]],
    colReorder: true,
    dom: '<"top"Bfl>rt<"bottom"lip>',
    searchDelay: 350,
    scrollX: true,
    scrollY: '60vh',
    scrollCollapse: true,
    paging: true,
    pageLength: 50,
    lengthMenu: [[10,25,50,100,250,500,-1],[10,25,50,100,250,500,"Todos"]],
    deferRender: true,
    buttons: [{ extend: 'excel', className: 'btn btn-success', text: 'Excel',
      exportOptions: {
        columns: ':visible'   // solo columnas visibles
      }
    }],
    ajax: {
      type: 'POST',
      url: '/income/anomalies_clients_table',
      data: { from: from, until: until },
      beforeSend: function(){ startLoadBar(); },
      complete:    function(){ finishLoadBar(); },
      error:       function(){ failLoadBar(); }
    },
   columns: [
  { data: 'codopr', className: 'text-nowrap' },
  { data: 'cliente' },
  {
    data: 'dias_anomalos',
    className: 'text-end',
    render: function(data, type, row){
      if (type === 'display') {
        var val = data || 0;
        if (val > 0) {
          var cliente = row.cliente || '';
          return '<a href="#" class="link-dias-anom" ' +
                'data-codopr="'+ row.codopr +'" ' +
                'data-cliente="'+ cliente.replace(/"/g, '&quot;') +'">' +
                val + '</a>';
        }
      }
      return $.fn.dataTable.render.number(',','.',0).display(data);
    }
  },
  { data: 'prom_zscore',   className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) },
  { data: 'n_despachos',   className: 'text-end', render: $.fn.dataTable.render.number(',','.',0) },
  { data: 'facturas_unicas', className: 'text-end', render: $.fn.dataTable.render.number(',','.',0) },
  { data: 'total_mto',     className: 'text-end', render: $.fn.dataTable.render.number(',','.',2) } // pesos MXN
],

    initComplete: function(){ updateFooters(this.api()); }
  });

  // Redibuja al cambiar los checkboxes
  $('#chk-10plus, #chk-multi-prod, #chk-multi-montos').off('change').on('change', function(){
    dt.draw();
  });

  dt.on('draw', function(){ updateFooters(dt); });

  // Click en d√≠as an√≥malos para abrir modal (tabs)
  $('#anomalies_table tbody').off('click', 'a.link-dias-anom').on('click', 'a.link-dias-anom', function(e){
    e.preventDefault();
    const codopr  = $(this).data('codopr');
    const cliente = $(this).data('cliente') || '';
    if (codopr) {
      loadClientDetail(codopr, cliente);
    }
  });
}

$('#btn-run').on('click', loadAnomalies);
// $(document).ready(loadAnomalies);

// Ajustar columnas cuando se muestre el modal
$('#modal-client-days').on('shown.bs.modal', function () {
  if (dtClientDays) {
    dtClientDays.columns.adjust();
  }
  if (dtClientTickets) {
    dtClientTickets.columns.adjust();
  }
});

// Ajustar columnas cuando cambies a la pesta√±a "Lista de tickets"
$('button[data-bs-target="#tab-tickets"]').on('shown.bs.tab', function () {
  if (dtClientTickets) {
    dtClientTickets.columns.adjust();
  }
});

// Toggle de grupos por factura en Lista de tickets
$('#client_tickets_table tbody').on('click', 'tr.group', function () {
  var factura = $(this).data('factura') || '';
  var key = String(factura);

  // cambiar estado
  ticketGroupsCollapsed[key] = !ticketGroupsCollapsed[key];

  var api = $('#client_tickets_table').DataTable();

  // mostrar/ocultar todas las filas con esa factura en la p√°gina actual
  api.rows({ page: 'current' }).every(function () {
    var data = this.data();
    var f = data && (data.factura == null ? '' : String(data.factura));
    if (f === key) {
      var node = this.node();
      if (ticketGroupsCollapsed[key]) {
        $(node).addClass('d-none');
      } else {
        $(node).removeClass('d-none');
      }
    }
  });

  // actualizar icono
  var $icon = $(this).find('span').first();
  if (ticketGroupsCollapsed[key]) {
    $icon.html('&#x25B6;'); // ‚ñ∂
  } else {
    $icon.html('&#x25BC;'); // ‚ñº
  }
});

// Colapsar todas las facturas en Lista de tickets
$('#btn-collapse-all-tickets').on('click', function () {
  if (!dtClientTickets) return;

  var api = dtClientTickets;

  // marcar todas las facturas como colapsadas
  api.column(4).data().each(function (factura) {
    var key = factura == null ? '' : String(factura);
    ticketGroupsCollapsed[key] = true;
  });

  // redibujar respetando el estado de ticketGroupsCollapsed
  api.draw(false);
});

// Expandir todas las facturas en Lista de tickets
$('#btn-expand-all-tickets').on('click', function () {
  if (!dtClientTickets) return;

  var api = dtClientTickets;

  api.column(4).data().each(function (factura) {
    var key = factura == null ? '' : String(factura);
    ticketGroupsCollapsed[key] = false;
  });

  api.draw(false);
});


</script>
{% endblock %}
