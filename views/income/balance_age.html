{% extends "views/layouts/base.html" %}
{% block title %}Balance por Cliente / Estaci√≥n (filtros){% endblock %}

{% block mycss %}
<style>

/* ===== Estilos espec√≠ficos del modal de correo (scopeados) ===== */
#mailModalBA .client-search {
  position: sticky;
  top: 0;
  z-index: 2;
  background: #fff;
  padding-bottom: .5rem;
  margin-bottom: .5rem;
  border-bottom: 1px solid #f1f3f5;
}
#mailModalBA #clientListWrap {
  max-height: 45vh;
  overflow: auto;
  border: 1px solid #e9ecef;
  border-radius: .5rem;
  padding: .5rem;
}

/* Cada fila de cliente */
#mailModalBA .form-check {
  padding: .25rem .4rem;
  border-radius: .5rem;
  transition: background-color .15s ease;
}
#mailModalBA .form-check:hover {
  background: #f8f9fa;
}

/* Ajuste de alineaci√≥n del checkbox */
#mailModalBA .form-check-input {
  margin-top: .35rem; /* centra verticalmente con el texto */
}

/* Contenedor de textos (cliente/correo) que se truncan correctamente */
#mailModalBA .client-text {
  min-width: 0;           /* clave para que text-overflow funcione en flex */
  overflow: hidden;
}
#mailModalBA .client-name {
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#mailModalBA .client-email {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: .8rem;
  opacity: .85;
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

/* Espaciado y truncado en la etiqueta completa */
#mailModalBA .form-check-label {
  display: flex;
  align-items: center;
  gap: .5rem;
  width: 100%;
}
#mailModalBA .client-right {
  flex: 0 0 auto; /* evita que esta parte se trunque */
  display: inline-flex;
  align-items: center;
}
#mailModalBA .client-chip {
  font-size: .7rem;
  padding: .15rem .4rem;
  border-radius: 999px;
  border: 1px solid #e5e7eb;
  background: #f8fafc;
  color: #475569;
}
#mailModalBA .client-chip--danger {
  border-color: #f1c0c0;
  background: #fff5f5;
  color: #b42318;
}

.ba-client-list{
  max-height:45vh; overflow:auto;
  border:1px solid #e9ecef; border-radius:.5rem; padding:.5rem;
  background:#fff;
}
.ba-client-item{
  display:flex; gap:.5rem; align-items:flex-start;
  padding:.45rem .4rem; border-bottom:1px solid #f1f3f5;
}
.ba-client-item:last-child{ border-bottom:none; }
.ba-client-item:hover{ background:#fafafa; }
.ba-client-item .form-check-input{ margin-top:.35rem; }
.ba-client-item .client-text{ min-width:0; }
.truncate-1{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.client-name{ font-weight:600; line-height:1.2; }
.client-email{ font-size:.875rem; line-height:1.2; }
.ba-client-item.no-email .client-name{ color:#c0392b; }  /* rojo si no tiene correo */

/* Bot√≥n Consultar alto 60px y centrado del texto */
.btn-consultar{
  height: 60px;
  width: 200px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0 1rem;
}

/* -----------------------------
   Estilos DataTables (skin)
------------------------------ */
table.dataTable thead th,
table.dataTable thead td{
  padding: 10px 18px;
  border-bottom: 1px solid #dee2e6;
  background-color: #3485a8 !important;
  color: #ffffff !important;
}
table.dataTable tfoot th,
table.dataTable tfoot td{
  padding: 10px 18px;
  border-top: 1px solid #dee2e6;
  background-color: #3485a8 !important;
  color: #ffffff !important;
}

/* -----------------------------
   Solo la tabla scrollea
------------------------------ */
.table-wrap{
  position: relative;
  max-height: 60vh;
  overflow: auto;
  border-top: 1px solid #e9ecef;
  -webkit-overflow-scrolling: touch;
}
.table-wrap table{
  border-collapse: separate;
  border-spacing: 0;
}

/* Select2 del filtro de cliente: m√≠nimo 400px */
#clientFilter + .select2-container{
  min-width: 400px !important;
}

/* -----------------------------
   THEAD fijo
------------------------------ */
.table-wrap thead{
  position: sticky !important;
  top: 0;
  z-index: 4;
}
.table-wrap thead tr{ position: sticky !important; top: 0; z-index: 5; }
.table-wrap thead th,
.table-wrap thead td{
  position: sticky !important;
  top: 0;
  z-index: 6;
  background-color: #3485a8 !important;
  background-clip: padding-box;
}
.table-wrap thead th{ box-shadow: 0 2px 0 rgba(0,0,0,.05); }

/* (TFOOT no fijo) */
.table-wrap tfoot th,
.table-wrap tfoot td{ position: static !important; }

/* -----------------------------
   Configuraci√≥n de las tablas
------------------------------ */
#balance_age_table,
#balance_age_table_det{
  width: auto !important;
  table-layout: auto !important;
  white-space: nowrap;
  text-align: center;
}

/* Colores para % (solo tabla Totales) */
.pct-green  { background:#c6efce !important; color:#006100 !important; }
.pct-yellow { background:#fff2cc !important; color:#7f6000 !important; }
.pct-red    { background:#f8cbad !important; color:#9c0006 !important; }
td.pct-green, td.pct-yellow, td.pct-red{ border-radius:2px; }

/* Controles de DataTables fijos */
#dt-controls-top, #dt-controls-bottom,
#dt-controls-top-det, #dt-controls-bottom-det{
  position: relative; overflow: visible; background: transparent; gap: .75rem;
}
.dataTables_length label{
  display: inline-flex; align-items: center; gap: .5rem; white-space: nowrap; margin: 0;
}
.dataTables_length select{ width: auto !important; min-width: 72px; }
.dataTables_filter{ margin-left: auto; }
#dt-controls-bottom .dataTables_info,
#dt-controls-bottom-det .dataTables_info{ white-space: nowrap; }
#dt-controls-bottom .dataTables_paginate,
#dt-controls-bottom-det .dataTables_paginate{ margin-left: auto; }

/* Extras (pesta√±a Facturas) */
tr.group-start { background:#c6efce !important; font-weight:600; }
tr.group-total { background:#e2f0d9 !important; font-weight:700; }

/* Columna oculta de cliente (para evitar parpadeo antes de DT) */
.col-cliente-oculto{ display:none; }

.table-wrap .dropdown-menu{ z-index: 1040; }
.table-wrap::-webkit-scrollbar{ height:10px; width:10px; }
.table-wrap::-webkit-scrollbar-thumb{ background-color: rgba(0,0,0,.2); border-radius: 8px; }
.table-wrap::-webkit-scrollbar-track{ background: transparent; }

/* M√°s separaci√≥n entre 'Mostrar' y 'Buscar' */
#dt-controls-top, #dt-controls-top-det{ gap: 4rem; }
.dataTables_filter label{
  display: inline-flex !important; align-items: center; gap:.5rem; white-space: nowrap; margin: 0;
}
.dataTables_filter input[type="search"]{ width: 260px; }

/* --------- Modal de correo --------- */
#clientListWrap{
  max-height: 260px; overflow: auto; border: 1px solid #e9ecef; border-radius: .5rem; padding:.5rem;
}
#mailModeBadge{ font-size: .8rem; }

/* === FIX: layout del √≠tem de cliente para que el checkbox nunca quede debajo === */
#mailModalBA .ba-client-item.form-check{
  padding-left: 0 !important;
  margin: 0;
  display: grid;
  grid-template-columns: 22px 1fr;
  align-items: start;
  gap: .5rem;
  padding: .45rem .4rem;
  border-bottom: 1px solid #f1f3f5;
}
#mailModalBA .ba-client-item.form-check:last-child{ border-bottom: 0; }
#mailModalBA .ba-client-item .form-check-input{
  margin: 0 !important;
  float: none;
  position: static;
  transform: none;
}
#mailModalBA .ba-client-item .form-check-label{
  margin: 0;
  width: 100%;
  min-width: 0;
  display: block;
  cursor: pointer;
}
#mailModalBA .ba-client-item .client-text{ min-width: 0; }
#mailModalBA .ba-client-item .client-name,
#mailModalBA .ba-client-item .client-email{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#mailModalBA .ba-client-item.no-email .client-name{ color: #c0392b; }
#mailModalBA .ba-client-item.no-email .form-check-input{ cursor: not-allowed; }
#mailModalBA .ba-client-item.no-email .form-check-input:disabled{ opacity: .45; }
#mailModalBA .ba-client-item:hover{ background: #fafafa; }

</style>
{% endblock %}

{% block menutitle %}Cartera de clientes{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card flex-fill">

      <!-- Header con filtros -->
      <div class="card-header py-3">
        <form id="baFilterForm" method="get" class="row gy-3 gx-3 align-items-end">
          <!-- Cuenta -->
          <div class="col-12 col-md-6 col-lg-3">
            <label for="cta" class="form-label mb-1">Cuenta</label>
            <select id="cta" name="cta" class="form-select form-select-sm" required>
              <option value="" {{ cta_sel is null ? 'selected' : '' }} disabled>Selecciona una cuenta‚Ä¶</option>
              {% for val, label in cuentas %}
                <option value="{{ val }}" {{ val == cta_sel ? 'selected' : '' }}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Estaci√≥n -->
          <div class="col-12 col-md-6 col-lg-3">
            <label for="gas" class="form-label mb-1">Estaci√≥n</label>
            <select id="gas" name="gas" class="form-select form-select-sm" required>
              <option value="" {{ gas_sel is null ? 'selected' : '' }} disabled>Selecciona una estaci√≥n‚Ä¶</option>
              {% for g in gasolineras %}
                <option value="{{ g.cod }}" {{ g.cod == gas_sel ? 'selected' : '' }}>{{ g.den }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Mostrar todas (switch) -->
          <div class="col-12 col-lg-4 d-flex align-items-center">
            <div class="form-check form-switch mt-2 mt-lg-0">
              <input class="form-check-input" type="checkbox" id="show_all" checked>
              <label class="form-check-label" for="show_all">Mostrar todas</label>
            </div>
          </div>

          <!-- Bot√≥n Consultar -->
          <div class="col-12 col-lg-2 ms-auto text-end">
            <div class="d-grid d-sm-flex justify-content-end">
              <button type="submit" class="btn btn-primary btn-consultar">
                <i class="fa fa-search me-1"></i> Consultar
              </button>
            </div>
          </div>
        </form>
      </div>

      {% if submitted %}
      <!-- Tabs -->
      <div class="card-body pb-2 pt-0 px-0">
        <ul class="nav nav-tabs px-3" id="baTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="totales-tab" data-bs-toggle="tab" data-bs-target="#totales-pane" type="button" role="tab" aria-controls="totales-pane" aria-selected="true">
              Totales
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="facturas-tab" data-bs-toggle="tab" data-bs-target="#facturas-pane" type="button" role="tab" aria-controls="facturas-pane" aria-selected="false">
              Facturas
            </button>
          </li>
        </ul>
      </div>

      <div class="tab-content">
        <!-- ===== TAB 1: TOTALES ===== -->
        <div class="tab-pane fade show active" id="totales-pane" role="tabpanel" aria-labelledby="totales-tab" tabindex="0">
          <div class="d-flex flex-wrap justify-content-between align-items-center mt-4 mb-0 px-3">
            <div id="dt-controls-top" class="d-flex flex-wrap justify-content-between align-items-center"></div>
            <div class="d-flex gap-2 mt-4 ">
              <button id="btnExportXLS" type="button" class="btn btn-success btn-sm">
                <i class="fa-solid fa-file-excel me-1"></i> Exportar a Excel (Totales)
              </button>
              <button id="btnMailTotales" type="button" class="btn btn-danger btn-sm">
                <i class="fa-solid fa-envelope me-1"></i> Enviar por correo
              </button>
            </div>
          </div>

          <div class="table-wrap">
            <table id="balance_age_table" class="table table-striped table-hover table-sm">
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Estaci√≥n</th>
                  <th>Ult. D√©b.</th>
                  <th>Ult. Cr√©d.</th>
                  <th>Cr√©dito</th>
                  <th>Dias Cr√©dito</th>
                  <th>Saldo actual</th>
                  <th>Por vencer</th>
                  <th>1-15</th>
                  <th>16-30</th>
                  <th>31-45</th>
                  <th>45+</th>
                  <th>Total vencido</th>
                  <th>% de vencimiento</th>
                </tr>
              </thead>
              <tbody>
                {% for r in rows %}
                <tr>
                  <td style="text-align:left !important;">{{ r.Cliente }}</td>
                  <td>{{ r.Estacion }}</td>
                  <td>{{ r['ult. deb.'] }}</td>
                  <td>{{ r['ult. cred.'] }}</td>
                  <td class="text-end">{{ r.Credito is not null ? r.Credito|number_format(2,'.',',') : '' }}</td>
                  <td>{{ r['cond. pago'] }}</td>
                  <td class="text-end">{{ r['Saldo actual']|number_format(2,'.',',') }}</td>
                  <td class="text-end">{{ r['Por vencer']|number_format(2,'.',',') }}</td>
                  <td class="text-end">{{ r['1-15']|number_format(2,'.',',') }}</td>
                  <td class="text-end">{{ r['16-30']|number_format(2,'.',',') }}</td>
                  <td class="text-end">{{ r['31-45']|number_format(2,'.',',') }}</td>
                  <td class="text-end">{{ r['45+']|number_format(2,'.',',') }}</td>
                  <td class="text-end">{{ r['Total vencido']|number_format(2,'.',',') }}</td>
                  <td class="text-end">{{ r['% de vencimiento'] is not null ? (r['% de vencimiento']|number_format(2,'.',',')) ~ '%' : '' }}</td>
                </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr>
                  <th class="text-end">Totales</th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum="6"></th>
                  <th class="text-end" data-colsum="7"></th>
                  <th class="text-end" data-colsum="8"></th>
                  <th class="text-end" data-colsum="9"></th>
                  <th class="text-end" data-colsum="10"></th>
                  <th class="text-end" data-colsum="11"></th>
                  <th class="text-end" data-colsum="12"></th>
                  <th class="text-end" data-colpct="13"></th>
                </tr>
              </tfoot>
            </table>
          </div>

          <div id="dt-controls-bottom" class="d-flex flex-wrap justify-content-between align-items-center gap-2 py-2 px-3"></div>
        </div>

        <!-- ===== TAB 2: FACTURAS ===== -->
        <div class="tab-pane fade" id="facturas-pane" role="tabpanel" aria-labelledby="facturas-tab" tabindex="0">

          <div class="d-flex flex-wrap justify-content-between align-items-center mt-4 mb-4 px-3">
            <div id="dt-controls-top-det" class="d-flex flex-wrap justify-content-between align-items-center"></div>

            <div class="d-flex flex-wrap align-items-center gap-2 mt-4" style="min-width:50%;">
              {% set clientes_list = [] %}
              {% for r in rows_det %}
                {% if r.Cliente is defined and r.Cliente is not empty and (r.Cliente not in clientes_list) %}
                  {% set clientes_list = clientes_list|merge([r.Cliente]) %}
                {% endif %}
              {% endfor %}

              <label for="clientFilter" class="form-label mb-0">Cliente:</label>
              <select id="clientFilter" class="form-select form-select-sm" style="min-width:400px;">
                <option value="">(Todos)</option>
                {% for c in clientes_list|sort %}
                  <option value="{{ c|e }}">{{ c }}</option>
                {% endfor %}
              </select>

              <div class="d-flex gap-2">
                <button id="btnExportXLS_det" type="button" class="btn btn-success btn-sm">
                  <i class="fa-solid fa-file-excel me-1"></i> Exportar a Excel (Facturas)
                </button>
                <button id="btnMailFacturas" type="button" class="btn btn-danger btn-sm">
                  <i class="fa-solid fa-envelope me-1"></i> Enviar por correo
                </button>
              </div>
            </div>
          </div>

          <div class="table-wrap mt-4">
            <table id="balance_age_table_det" class="table table-striped table-hover table-sm">
              <thead>
                <tr>
                  <th>Clientes</th>
                  <th>Estaci√≥n</th>
                  <th>Fecha</th>
                  <th>Vencimiento</th>
                  <th>Saldo Actual</th>
                  <th>Por Vencer</th>
                  <th>Vencido 1-15</th>
                  <th>Vencido 16-30</th>
                  <th>Vencido 31-45</th>
                  <th>Vencido 45+</th>
                  <th>Total Vencido</th>
                  <th>Cliente (hidden)</th> {# √≠ndice 11 oculto #}
                </tr>
              </thead>
              <tbody>
                {% if rows_det|length > 0 %}
                  {% set cliente_actual = null %}
                  {% set ts = 0 %}{% set tpv = 0 %}{% set t115 = 0 %}{% set t1630 = 0 %}{% set t3145 = 0 %}{% set t45 = 0 %}{% set ttv = 0 %}

                  {% for r in rows_det %}
                    {% set cliente = r.Cliente %}
                    {% if cliente_actual is not same as(cliente) %}
                      {% if cliente_actual is not null %}
                        <tr class="group-total">
                          <td class="text-end">Totales {{ cliente_actual }}</td>
                          <td></td><td></td><td></td>
                          <td class="text-end">{{ ts|number_format(2,'.',',') }}</td>
                          <td class="text-end">{{ tpv|number_format(2,'.',',') }}</td>
                          <td class="text-end">{{ t115|number_format(2,'.',',') }}</td>
                          <td class="text-end">{{ t1630|number_format(2,'.',',') }}</td>
                          <td class="text-end">{{ t3145|number_format(2,'.',',') }}</td>
                          <td class="text-end">{{ t45|number_format(2,'.',',') }}</td>
                          <td class="text-end">{{ ttv|number_format(2,'.',',') }}</td>
                          <td class="col-cliente-oculto">{{ cliente_actual }}</td>
                        </tr>
                        {% set ts = 0 %}{% set tpv = 0 %}{% set t115 = 0 %}{% set t1630 = 0 %}{% set t3145 = 0 %}{% set t45 = 0 %}{% set ttv = 0 %}
                      {% endif %}

                      <tr class="group-start">
                        <td style="text-align:left !important;">C-{{ r.Cliente }}{% if r['cond. pago'] %} ({{ r['cond. pago'] }}){% endif %}</td>
                        <td>{{ r.Estacion }}</td>
                        <td></td><td></td>
                        <td class="text-end"></td><td class="text-end"></td><td class="text-end"></td>
                        <td class="text-end"></td><td class="text-end"></td><td class="text-end"></td>
                        <td class="text-end"></td>
                        <td class="col-cliente-oculto">{{ r.Cliente }}</td>
                      </tr>

                      {% set cliente_actual = cliente %}
                    {% endif %}

                    {% set factura_num = (r.nroope is defined and r.nroope is not null) ? (r.nroope - 1700000000) : null %}
                    <tr>
                      <td style="text-align:left !important;">- Factura {{ factura_num is not null ? factura_num : '' }}</td>
                      <td>{{ r.Estacion }}</td>
                      <td>{{ r.fchope_dt is not null ? (r.fchope_dt|date('d/m/Y')) : '' }}</td>
                      <td>{{ r.fchvto_dt is not null ? (r.fchvto_dt|date('d/m/Y')) : '' }}</td>
                      <td class="text-end">{{ r['Saldo actual']|number_format(2,'.',',') }}</td>
                      <td class="text-end">{{ r['Por vencer']|number_format(2,'.',',') }}</td>
                      <td class="text-end">{{ r['1-15']|number_format(2,'.',',') }}</td>
                      <td class="text-end">{{ r['16-30']|number_format(2,'.',',') }}</td>
                      <td class="text-end">{{ r['31-45']|number_format(2,'.',',') }}</td>
                      <td class="text-end">{{ r['45+']|number_format(2,'.',',') }}</td>
                      <td class="text-end">{{ r['Total vencido']|number_format(2,'.',',') }}</td>
                      <td class="col-cliente-oculto">{{ r.Cliente }}</td>
                    </tr>

                    {% set ts    = ts    + (r['Saldo actual']  ?? 0) %}
                    {% set tpv   = tpv   + (r['Por vencer']    ?? 0) %}
                    {% set t115  = t115  + (r['1-15']          ?? 0) %}
                    {% set t1630 = t1630 + (r['16-30']         ?? 0) %}
                    {% set t3145 = t3145 + (r['31-45']         ?? 0) %}
                    {% set t45   = t45   + (r['45+']           ?? 0) %}
                    {% set ttv   = ttv   + (r['Total vencido'] ?? 0) %}
                  {% endfor %}

                  <tr class="group-total">
                    <td class="text-end">Totales {{ cliente_actual }}</td>
                    <td></td><td></td><td></td>
                    <td class="text-end">{{ ts|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ tpv|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ t115|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ t1630|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ t3145|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ t45|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ ttv|number_format(2,'.',',') }}</td>
                    <td class="col-cliente-oculto">{{ cliente_actual }}</td>
                  </tr>
                {% endif %}
              </tbody>
              <tfoot>
                <tr>
                  <th class="text-end">Totales</th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum="4"></th>
                  <th class="text-end" data-colsum="5"></th>
                  <th class="text-end" data-colsum="6"></th>
                  <th class="text-end" data-colsum="7"></th>
                  <th class="text-end" data-colsum="8"></th>
                  <th class="text-end" data-colsum="9"></th>
                  <th class="text-end" data-colsum="10"></th>
                  <th class="text-end" data-colsum=""></th>
                </tr>
              </tfoot>
            </table>
          </div>

          <div id="dt-controls-bottom-det" class="d-flex flex-wrap justify-content-between align-items-center gap-2 py-2 px-3"></div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>

{% if submitted %}
<!-- ===== Modal de correo ===== -->
<div class="modal fade" id="mailModalBA" tabindex="-1" aria-labelledby="mailModalBALabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="mailModalBALabel">
          Enviar Excel por correo
          <span id="mailModeBadge" class="badge bg-secondary ms-2">Totales</span>
        </h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <form id="mail_form_ba">
        <div class="modal-body">
          <!-- Enviar a (solo Totales) -->
          <div id="sendToWrap" class="mb-3">
            <label for="sentTo_ba" class="form-label">Enviar a:</label>
            <input type="text" class="form-control" id="sentTo_ba" name="sentTo_ba"
                   placeholder="correo1@totalgas.com; correo2@totalgas.com"
                   value="{{ user_email }}">
            <small class="text-muted">Puedes agregar varios correos separados por <b>;</b>.</small>
          </div>

          <!-- Selecci√≥n de clientes (solo Facturas) -->
       <div id="clientListSection" class="mb-3" style="display:none;">

  <!-- Encabezado + bot√≥n Filtros -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <label class="form-label mb-0">Clientes a enviar (se usa el correo del cliente):</label>

    <div class="d-flex align-items-center gap-2">
      <!-- Bot√≥n que muestra/oculta los filtros -->
      <button type="button"
              class="btn btn-outline-secondary btn-sm"
              data-bs-toggle="collapse"
              data-bs-target="#clientFiltersCollapse"
              aria-expanded="false"
              aria-controls="clientFiltersCollapse">
        <i class="fa fa-filter me-1"></i> Filtros
      </button>

      <div class="btn-group btn-group-sm">
        <button type="button" id="btnSelAllClients" class="btn btn-outline-secondary">Seleccionar todos</button>
        <button type="button" id="btnSelNoneClients" class="btn btn-outline-secondary">Limpiar</button>
      </div>
    </div>
  </div>

  <!-- Panel colapsable con los filtros -->
  <div id="clientFiltersCollapse" class="collapse">
    <div class="card card-body p-2 mb-2">

      <!-- Selecci√≥n por % de adeudo -->
      <div class="input-group input-group-sm mb-2">
        <span class="input-group-text">Seleccionar clientes con % de adeudo ‚â•</span>
        <input type="number" id="pctThreshold" class="form-control" min="0" max="100" step="1" placeholder="50">
        <span class="input-group-text">%</span>
        <button type="button" id="btnSelByPct" class="btn btn-outline-primary">Aplicar</button>
      </div>

      <!-- Selecci√≥n por Total vencido -->
      <div class="input-group input-group-sm mb-2">
        <span class="input-group-text">Seleccionar clientes con Total vencido ‚â•</span>
        <input type="number" id="totVencThreshold" class="form-control" min="0" step="0.01" placeholder="100000">
        <button type="button" id="btnSelByTotVenc" class="btn btn-outline-primary">Aplicar</button>
      </div>

    </div>
  </div>

  <!-- üîé Buscador -->
  <div class="input-group input-group-sm mb-6">
    <span class="input-group-text"><i class="fa fa-search"></i></span>
    <input type="text" id="clientSearch" class="form-control" placeholder="Buscar cliente o correo‚Ä¶">
  </div>
  <div class="small text-muted mb-2">
    <span id="clientCount">Mostrando 0 de 0</span>
  </div>

  <!-- Listado -->
  <div id="clientListWrap" class="ba-client-list">
    {% set clientes_unicos = [] %}
    {% for r in rows_det %}
      {% if r.Cliente is defined and r.Cliente is not empty and (r.Cliente not in clientes_unicos) %}
        {% set clientes_unicos = clientes_unicos|merge([r.Cliente]) %}
      {% endif %}
    {% endfor %}
    {% for c in clientes_unicos|sort %}
      {% set c_mail = '' %}
      {% for r in rows_det %}
        {% if r.Cliente == c and r.correo is defined and r.correo is not empty %}
          {% set c_mail = r.correo %}
        {% endif %}
      {% endfor %}
      <div class="form-check ba-client-item {{ c_mail ? '' : 'no-email' }}"
           data-idx="{{ loop.index }}"
           data-client-name="{{ c|lower }}"
           data-client-email="{{ (c_mail|lower) }}">
        <input class="form-check-input chk-client" type="checkbox"
               value="{{ c|e }}" id="cli_{{ loop.index }}"
               data-email="{{ c_mail }}" {{ c_mail ? '' : 'disabled' }}>
        <label class="form-check-label w-100" for="cli_{{ loop.index }}">
          <div class="client-text">
            <div class="client-name truncate-1" title="{{ c }}">{{ c }}</div>
            {% if c_mail %}
              <div class="client-email truncate-1 text-muted" title="{{ c_mail }}">{{ c_mail }}</div>
            {% endif %}
          </div>
        </label>
      </div>
    {% endfor %}
  </div>

  <small class="text-muted d-block mt-2">
    Se enviar√° un correo <b>individual</b> por cada cliente seleccionado, adjuntando su Excel filtrado.
  </small>
</div>

          <!-- Mensaje -->
          <div class="mb-2">
            <label for="mailBody_ba" class="form-label">Mensaje (opcional):</label>
            <textarea id="mailBody_ba" class="form-control form-control-sm" rows="3"
                      placeholder="Escribe un mensaje breve para el destinatario..."></textarea>
          </div>

          <div id="mailProgress" class="small text-muted" style="display:none;">Enviando‚Ä¶</div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary btn-sm">Enviar</button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endif %}


{% endblock %}

{% block myjs %}

<!-- ===== Helpers de "loading" ===== -->
<script>
/* Agrega/quita la clase global "loading" al <body> y marca aria-busy */
function baSetLoading(on){
  document.body.classList.toggle('loading', !!on);
  document.body.setAttribute('aria-busy', on ? 'true' : 'false');
}

/* Mostrar loading cuando se consulta (GET del formulario) */
document.addEventListener('DOMContentLoaded', function(){
  const form = document.getElementById('baFilterForm');
  if (form){
    form.addEventListener('submit', function(){
      baSetLoading(true);
      const btn = form.querySelector('button[type="submit"]');
      if (btn){ btn.disabled = true; }
    });
  }
});
</script>

<script>
/** Filtro + selecci√≥n del modal (Facturas) */
document.addEventListener('DOMContentLoaded', function () {
  const search   = document.getElementById('clientSearch');
  const wrap     = document.getElementById('clientListWrap');
  const count    = document.getElementById('clientCount');
  const btnAll   = document.getElementById('btnSelAllClients');
  const btnNone  = document.getElementById('btnSelNoneClients');
  const modalEl  = document.getElementById('mailModalBA');

  // Selecci√≥n por % y por Total Vencido
  const btnByPct      = document.getElementById('btnSelByPct');
  const pctInput      = document.getElementById('pctThreshold');
  const btnByTotVenc  = document.getElementById('btnSelByTotVenc');
  const totVencInput  = document.getElementById('totVencThreshold');

  if (!wrap || !count) return;

  // --- helpers locales ---
  function stripHTMLLocal(s){ const d=document.createElement('div'); d.innerHTML = s || ''; return (d.textContent||'').trim(); }
  function parsePercentLocal(txt){
    if (txt == null) return NaN;
    const s = (txt+'').replace('%','').replace(/[^0-9.\-]/g,'');
    const v = parseFloat(s);
    return isNaN(v) ? NaN : v;
  }
  function parseMoneyLocal(txt){
    if (txt == null) return NaN;
    const s = (txt+'').replace(/[^0-9,.\-]/g,'').replace(/,/g,''); // quita $ y comas
    const v = parseFloat(s);
    return isNaN(v) ? NaN : v;
  }

  // --- Reordenar: seleccionados primero (luego alfab√©tico, luego data-idx) ---
  function reorderListSelectedFirst(){
    const items = Array.from(wrap.querySelectorAll('.ba-client-item'));
    items.sort((a, b) => {
      const ac = a.querySelector('.chk-client')?.checked ? 0 : 1;
      const bc = b.querySelector('.chk-client')?.checked ? 0 : 1;
      if (ac !== bc) return ac - bc;

      const an = (a.getAttribute('data-client-name') || '');
      const bn = (b.getAttribute('data-client-name') || '');
      if (an < bn) return -1;
      if (an > bn) return 1;

      const ai = parseInt(a.getAttribute('data-idx') || '0', 10);
      const bi = parseInt(b.getAttribute('data-idx') || '0', 10);
      return ai - bi;
    });
    const frag = document.createDocumentFragment();
    items.forEach(it => frag.appendChild(it));
    wrap.appendChild(frag);
  }
  window.baReorderClientList = reorderListSelectedFirst;

  function updateCount() {
    const total = wrap.querySelectorAll('.ba-client-item').length;
    const visible = wrap.querySelectorAll('.ba-client-item:not([data-hidden="1"])').length;
    count.textContent = `Mostrando ${visible} de ${total}`;
  }

  function filterList(q) {
    const ql = (q || '').trim().toLowerCase();
    wrap.querySelectorAll('.ba-client-item').forEach(it => {
      const name  = it.getAttribute('data-client-name')  || '';
      const email = it.getAttribute('data-client-email') || '';
      const match = !ql || name.includes(ql) || email.includes(ql);
      it.style.display = match ? '' : 'none';
      it.setAttribute('data-hidden', match ? '0' : '1');
    });
    updateCount();
    reorderListSelectedFirst();
  }

  // Mapas construidos desde pesta√±a Totales (usando DataTables de Totales)
  function buildPctMapFromTotales(useFiltered=true){
    const dt = window.dtBalance;
    if (!dt || !dt.rows) return null;
    const src = useFiltered ? dt.rows({search:'applied'}) : dt.rows();
    const map = {};
    src.every(function(){
      const data = this.data();
      const cli  = stripHTMLLocal(data?.[0] || '');
      const pct  = parsePercentLocal(data?.[13] || '');
      if (!cli || isNaN(pct)) return;
      const key = cli.toLowerCase();
      if (!(key in map) || pct > map[key]) map[key] = pct; // nos quedamos con el mayor %
    });
    return map;
  }
  function buildTotVencMapFromTotales(useFiltered=true){
    const dt = window.dtBalance;
    if (!dt || !dt.rows) return null;
    const src = useFiltered ? dt.rows({search:'applied'}) : dt.rows();
    const map = {};
    src.every(function(){
      const data = this.data();
      const cli  = stripHTMLLocal(data?.[0] || '');
      const tv   = parseMoneyLocal(data?.[12] || ''); // col 12 = Total vencido
      if (!cli || isNaN(tv)) return;
      const key = cli.toLowerCase();
      map[key] = (map[key] || 0) + tv; // SUMA por cliente
    });
    return map;
  }

  // Debounce para el input de b√∫squeda
  if (search) {
    let t;
    search.addEventListener('input', function () {
      clearTimeout(t);
      t = setTimeout(() => filterList(search.value), 120);
    });
  }

  // Seleccionar/Limpiar solo visibles y habilitados
  if (btnAll) {
    btnAll.addEventListener('click', function(){
      wrap.querySelectorAll('.ba-client-item:not([data-hidden="1"]) .chk-client:not(:disabled)')
          .forEach(chk => { chk.checked = true; });
      reorderListSelectedFirst();
    });
  }
  if (btnNone) {
    btnNone.addEventListener('click', function(){
      wrap.querySelectorAll('.ba-client-item:not([data-hidden="1"]) .chk-client:not(:disabled)')
          .forEach(chk => { chk.checked = false; });
      reorderListSelectedFirst();
    });
  }

  // Selecci√≥n por % de adeudo (‚â• umbral)
  if (btnByPct) {
    btnByPct.addEventListener('click', function(){
      const thr = parseFloat((pctInput?.value || '').replace(',','.'));
      if (isNaN(thr)){
        if (window.toastr) toastr.warning('Ingresa un porcentaje v√°lido (0 a 100).', 'Atenci√≥n');
        return;
      }
      const map = buildPctMapFromTotales(true) || {};
      let selected = 0;
      wrap.querySelectorAll('.chk-client').forEach(chk=>{
        const key = (chk.value || '').toLowerCase();
        const pct = map[key];
        if (typeof pct === 'number' && pct >= thr && !chk.disabled){
          chk.checked = true;
          selected++;
        }
      });
      reorderListSelectedFirst();
      if (window.toastr){
        toastr.info(`Seleccionados ${selected} cliente(s) con % ‚â• ${thr}%`, 'Filtro por %');
      }
    });
  }

  // NUEVO: Selecci√≥n por Total vencido (‚â• umbral)
  if (btnByTotVenc) {
    btnByTotVenc.addEventListener('click', function(){
      const raw = (totVencInput?.value || '').toString().replace(/[, ]/g,'');
      const thr = parseFloat(raw);
      if (isNaN(thr)){
        if (window.toastr) toastr.warning('Ingresa un monto v√°lido para Total vencido.', 'Atenci√≥n');
        return;
      }
      const map = buildTotVencMapFromTotales(true) || {};
      let selected = 0;
      wrap.querySelectorAll('.chk-client').forEach(chk=>{
        const key = (chk.value || '').toLowerCase();
        const tv = map[key];
        if (typeof tv === 'number' && tv >= thr && !chk.disabled){
          chk.checked = true;
          selected++;
        }
      });
      reorderListSelectedFirst();
      if (window.toastr){
        toastr.info(
          `Seleccionados ${selected} cliente(s) con Total vencido ‚â• ${thr.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2})}`,
          'Filtro por Total vencido'
        );
      }
    });
  }

  // Reordenar cuando se marque/desmarque manualmente
  wrap.addEventListener('change', function(e){
    if (e.target.classList.contains('chk-client')) {
      reorderListSelectedFirst();
    }
  });

  // Reset + reorden al abrir el modal
  if (modalEl) {
    modalEl.addEventListener('shown.bs.modal', function(){
      if (search) { search.value = ''; }
      if (pctInput && !pctInput.value) pctInput.value = '50'; // default ejemplo
      if (totVencInput && !totVencInput.value) totVencInput.value = ''; // vac√≠o por defecto
      filterList('');
      reorderListSelectedFirst();
    });
  }

  // Primera cuenta al cargar
  updateCount();
});
</script>


<script src="{{ JS }}administration.js"></script>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>

<script>
function parsePercentCellText(txt){
  if (txt == null) return NaN;
  const s = (txt+'').replace('%','').replace(/[^0-9.\-]/g,'');
  const v = parseFloat(s);
  return isNaN(v) ? NaN : v;
}
function colorizePctCells(dt){
  const colPct = 13;
  if (!dt?.cells) return;
  dt.cells(null, colPct, {page:'current'}).every(function(){
    const td = this.node();
    const val = parsePercentCellText(this.data());
    td.classList.remove('pct-green','pct-yellow','pct-red');
    if (isNaN(val)) return;
    if (val <= 10) td.classList.add('pct-green');
    else if (val <= 40) td.classList.add('pct-yellow');
    else td.classList.add('pct-red');
  });
  const $cell = $(dt.table().footer()).find('[data-colpct="13"]');
  if ($cell.length){
    const val = parsePercentCellText($cell.text());
    $cell.removeClass('pct-green pct-yellow pct-red');
    if (!isNaN(val)){
      if (val <= 10) $cell.addClass('pct-green');
      else if (val <= 40) $cell.addClass('pct-yellow');
      else $cell.addClass('pct-red');
    }
  }
}
function sumColumn(api, colIdx) {
  return api.column(colIdx, { page: 'current' }).data().reduce((acc, val) => {
    const n = (val+'').replace(/[^0-9.\-]/g,'');
    const parsed = parseFloat(n);
    return acc + (isNaN(parsed) ? 0 : parsed);
  }, 0);
}
</script>

<!-- ===== Inicializaci√≥n TOTALES ===== -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const tbl = document.getElementById('balance_age_table');
  if (!tbl) return;

  const dt = $('#balance_age_table').DataTable({
    autoWidth:false, ordering:true, order:[],
    searching:true, paging:true, info:true, dom:'lfrtip',
    pageLength: -1,
    lengthMenu:[[25,50,100,250,500,-1],[25,50,100,250,500,'Todas']],
    language:{
      lengthMenu:'Mostrar _MENU_ entradas',
      info:'Mostrando _START_ a _END_ de _TOTAL_ entradas',
      infoEmpty:'Mostrando 0 a 0 de 0 entradas',
      infoFiltered:'(filtrado de _MAX_ entradas totales)',
      search:'Buscar:',
      paginate:{ first:'Primero', last:'√öltimo', next:'Siguiente', previous:'Anterior' }
    },
footerCallback:function(){
  const api = this.api();

  // Sumas visibles
  [6,7,8,9,10,11,12].forEach(idx=>{
    const total = sumColumn(api, idx);
    $(api.table().footer()).find(`[data-colsum="${idx}"]`)
      .text(total.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}));
  });

  // % de vencimiento en Totales: DEJAR VAC√çO
  const $pctCell = $(api.table().footer()).find('[data-colpct="13"]');
  $pctCell.text(''); // <-- vac√≠o
}

  });
  window.dtBalance = dt;

  dt.on('draw', function(){ colorizePctCells(dt); });
  colorizePctCells(dt);

  const $wrap = $(dt.table().container());
  $('#dt-controls-top').append($wrap.find('.dataTables_length')).append($wrap.find('.dataTables_filter'));
  $('#dt-controls-bottom').append($wrap.find('.dataTables_info')).append($wrap.find('.dataTables_paginate'));

  const showAll = document.getElementById('show_all');
  const toggleCols = () => {
    const visible = showAll.checked;
    [1,2,3].forEach(i => dt.column(i).visible(visible, false));
    dt.columns.adjust().draw(false);
  };
  if (showAll){ toggleCols(); showAll.addEventListener('change', toggleCols); }

  document.querySelectorAll('#baTabs button[data-bs-toggle="tab"]').forEach(el =>
    el.addEventListener('shown.bs.tab', () => { dt.columns.adjust(); })
  );
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const btn = document.getElementById('btnExportXLS');
  if (!btn) return;

  function buildVisibleOnlyTable(origTable, visibleIdx) {
    const tmp = document.createElement('table'); tmp.className = origTable.className;
    const sections = [
      {src: origTable.tHead, dst: tmp.createTHead()},
      {src: origTable.tBodies[0], dst: tmp.createTBody()},
      {src: origTable.tFoot, dst: tmp.createTFoot()}
    ];
    sections.forEach(({src, dst}) => {
      if (!src) return;
      for (const srcRow of src.rows) {
        const dstRow = dst.insertRow(-1);
        visibleIdx.forEach((i) => {
          const cell = srcRow.cells[i]; if (!cell) return;
          const newCell = cell.tagName.toLowerCase() === 'th' ? document.createElement('th') : document.createElement('td');
          newCell.innerHTML = cell.innerHTML; newCell.className = cell.className;
          dstRow.appendChild(newCell);
        });
      }
    });
    return tmp;
  }
  function getHeaderTextsByIndex(table) {
    const headers = [];
    if (table.tHead && table.tHead.rows.length) {
      const row = table.tHead.rows[0];
      for (let i = 0; i < row.cells.length; i++) headers.push((row.cells[i].innerText || row.cells[i].textContent || '').trim());
    }
    return headers;
  }
  function parseNumber(v){
    const s = (v==null?'':String(v)).replace(/[^0-9.\-]/g,'');
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }
  function sumApplied(dt, colIdx){
    if (!dt) return 0;
    const data = dt.column(colIdx, {search:'applied'}).data();
    let acc = 0;
    for (let i = 0; i < data.length; i++) acc += parseNumber(data[i]);
    return acc;
  }

  btn.addEventListener('click', function () {
    const orig = document.getElementById('balance_age_table'); if (!orig) return;
    const dt = window.dtBalance;
    const visibleIdx = dt && typeof dt.columns === 'function'
      ? dt.columns(':visible').indexes().toArray()
      : Array.from({length: (orig.tHead?.rows[0]?.cells.length || 0)}, (_,i)=>i);

    const mini = buildVisibleOnlyTable(orig, visibleIdx);
    const headersExport = getHeaderTextsByIndex(mini);

    const ws = XLSX.utils.table_to_sheet(mini, { raw: true });
    ws['!autofilter'] = { ref: ws['!ref'] };
    const widthMap = {
      'Cliente':28,'Estaci√≥n':24,'Ult. D√©b.':12,'Ult. Cr√©d.':12,'Cr√©dito':14,'Dias Cr√©dito':12,
      'Saldo actual':16,'Por vencer':16,'1-15':10,'16-30':10,'31-45':10,'45+':10,'Total vencido':14,'% de vencimiento':16
    };
    ws['!cols'] = headersExport.map(h => ({ wch: widthMap[h] || 14 }));

    // Convertir % a n√∫mero + estilos (data)
    const HEADER_PCT = '% de vencimiento';
    const colPctExport = headersExport.findIndex(h => h === HEADER_PCT);
    if (colPctExport >= 0 && ws['!ref']) {
      const range = XLSX.utils.decode_range(ws['!ref']);
      const firstDataRow = range.s.r + 1;
      const lastDataRow  = range.e.r; // antes de agregar totales
      for (let r = firstDataRow; r <= lastDataRow; r++){
        const addr = XLSX.utils.encode_cell({ r, c: colPctExport });
        const cell = ws[addr]; if (!cell) continue;
        const raw = (cell.v ?? '').toString();
        const theVal100 = parseFloat(raw.replace('%','').replace(/[^0-9.\-]/g,'')); if (isNaN(theVal100)) continue;
        ws[addr] = { t: 'n', v: theVal100/100, z: '0.00%' };
        let fg='C6EFCE', fontColor='006100'; if (theVal100>40){fg='F8CBAD';fontColor='9C0006';} else if (theVal100>10){fg='FFF2CC';fontColor='7F6000';}
        ws[addr].s = { fill:{patternType:"solid",fgColor:{rgb:fg}}, font:{color:{rgb:fontColor}} };
      }
    }

    // <<< TOTALS ROW ADDED >>> (Totales: sobre filas filtradas)
    if (ws['!ref']) {
      const range = XLSX.utils.decode_range(ws['!ref']);
      const totalsRowIndex = range.e.r + 1;
      const makeAddr = (c) => XLSX.utils.encode_cell({ r: totalsRowIndex, c });
      const boldCell = (cell) => { ws[cell] = ws[cell] || {}; ws[cell].s = Object.assign({}, ws[cell].s||{}, { font:{ bold:true } }); };

      // Texto en primera visible
      const firstColAddr = makeAddr(0);
      ws[firstColAddr] = { t:'s', v:'Totales' };
      boldCell(firstColAddr);

      const sumCols = new Set([6,7,8,9,10,11,12]); // columnas num√©ricas
      let totalVencido = 0, totalCredito = 0;

      visibleIdx.forEach((origColIdx, pos) => {
        if (pos === 0) return;
        const addr = makeAddr(pos);

        if (sumCols.has(origColIdx)) {
          const s = sumApplied(dt, origColIdx);
          ws[addr] = { t:'n', v:s, z:'#,##0.00' };
          boldCell(addr);
          if (origColIdx === 12) totalVencido = s;
        } else if (origColIdx === 4) {
          const s = sumApplied(dt, 4);
          ws[addr] = { t:'n', v:s, z:'#,##0.00' };
          boldCell(addr);
          totalCredito = s;
       } else if (origColIdx === 13) {
  // % de vencimiento en Totales (Excel): vac√≠o
  ws[addr] = { t:'s', v:'' };
}

      });

      // Expandir rango
      ws['!ref'] = XLSX.utils.encode_range({
        s:{ r: range.s.r, c: range.s.c },
        e:{ r: totalsRowIndex, c: range.e.c }
      });
    }
    // <<< /TOTALS ROW ADDED >>>

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Balance');
    const cta = "{{ cta_sel is not null ? cta_sel : '' }}";
    const gas = "{{ gas_sel is not null ? gas_sel : '' }}";
    XLSX.writeFile(wb, `Antiguedad_De_Saldos_${cta}_${gas}_${new Date().toISOString().slice(0,10)}.xlsx`);
  });
});
</script>


<!-- ===== Inicializaci√≥n y export (Facturas) ===== -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const tbl2 = document.getElementById('balance_age_table_det');
  if (!tbl2) return;

 const dt2 = $('#balance_age_table_det').DataTable({
  autoWidth:false,
  ordering:true,
  order:[],                 // el usuario sigue pudiendo ordenar por cualquier columna
  orderFixed: { pre: [[11, 'asc']] },  // <-- agrupa por cliente (columna oculta 11)
  searching:true,
  paging:true,
  dom:'lfrtip',
  info:true,
  pageLength:50,
  lengthMenu:[[25,50,100,250,500,-1],[25,50,100,250,500,'Todas']],
  language:{
    lengthMenu:'Mostrar _MENU_ entradas',
    info:'Mostrando _START_ a _END_ de _TOTAL_ entradas',
    infoEmpty:'Mostrando 0 a 0 de 0 entradas',
    infoFiltered:'(filtrado de _MAX_ entradas totales)',
    search:'Buscar:',
    paginate:{ first:'Primero', last:'√öltimo', next:'Siguiente', previous:'Anterior' }
  },
  columnDefs:[ { targets:[11], visible:false, searchable:true } ],
  footerCallback:function(){
    const api = this.api();
    [4,5,6,7,8,9,10].forEach(idx => {
      const total = api.column(idx, { page:'current' }).data().reduce((acc, val) => {
        const n = (val+'').replace(/[^0-9.\-]/g,'');
        const parsed = parseFloat(n);
        return acc + (isNaN(parsed) ? 0 : parsed);
      }, 0);
      $(api.table().footer()).find(`[data-colsum="${idx}"]`)
        .text(total.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}));
    });
  }
});

  window.dtBalanceDet = dt2;

  const $wrap2 = $(dt2.table().container());
  $('#dt-controls-top-det').append($wrap2.find('.dataTables_length')).append($wrap2.find('.dataTables_filter'));
  $('#dt-controls-bottom-det').append($wrap2.find('.dataTables_info')).append($wrap2.find('.dataTables_paginate'));

  const showAll = document.getElementById('show_all');
  const toggleCols2 = () => {
    const visible = showAll && showAll.checked;
    [1].forEach(i => dt2.column(i).visible(visible, false));
    dt2.columns.adjust().draw(false);
  };
  toggleCols2();
  if (showAll) showAll.addEventListener('change', toggleCols2);

  document.querySelectorAll('#baTabs button[data-bs-toggle="tab"]').forEach(el =>
    el.addEventListener('shown.bs.tab', () => { dt2.columns.adjust(); })
  );

  // Select2 cliente (filtro visual)
  (function initSelect2(){
    const $sel = $('#clientFilter');
    if (!$sel.length) return;
    $sel.select2({
      placeholder: '(Todos)', allowClear:true, width:'resolve',
      language:{ noResults: function(){ return 'Sin resultados'; } }
    });
    function escapeRegex(text){ return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    $sel.on('change', function(){
      const val = $(this).val() || '';
      if (val) dt2.column(11).search('^' + escapeRegex(val) + '$', true, false);
      else dt2.column(11).search('');
      dt2.draw();
    });
  })();

  // Exportar Excel (Facturas - todo lo visible)
    // Exportar Excel (Facturas - todo lo visible)
  const btn2 = document.getElementById('btnExportXLS_det');
  if (btn2){
    function buildVisibleOnlyTable2(origTable, visibleIdx) {
      const tmp = document.createElement('table'); tmp.className = origTable.className;
      const sections = [
        {src: origTable.tHead,      dst: tmp.createTHead()},
        {src: origTable.tBodies[0], dst: tmp.createTBody()},
        {src: origTable.tFoot,      dst: tmp.createTFoot()}
      ];
      sections.forEach(({src, dst}) => {
        if (!src) return;
        for (const srcRow of src.rows) {
          const dstRow = dst.insertRow(-1);
          visibleIdx.forEach((i) => {
            const cell = srcRow.cells[i]; if (!cell) return;
            const newCell = cell.tagName.toLowerCase() === 'th' ? document.createElement('th') : document.createElement('td');
            newCell.innerHTML = cell.innerHTML; newCell.className = cell.className;
            dstRow.appendChild(newCell);
          });
        }
      });
      return tmp;
    }
    function getHeaderTextsByIndex2(table) {
      const headers = [];
      if (table.tHead && table.tHead.rows.length) {
        const row = table.tHead.rows[0];
        for (let i = 0; i < row.cells.length; i++) headers.push((row.cells[i].innerText || row.cells[i].textContent || '').trim());
      }
      return headers;
    }
    function parseNumber2(v){
      const s = (v==null?'':String(v)).replace(/[^0-9.\-]/g,'');
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }
    function sumApplied2(dt, colIdx){
      if (!dt) return 0;
      const data = dt.column(colIdx, {search:'applied'}).data();
      let acc = 0;
      for (let i = 0; i < data.length; i++) acc += parseNumber2(data[i]);
      return acc;
    }

    btn2.addEventListener('click', function () {
      const orig = document.getElementById('balance_age_table_det'); if (!orig) return;
      const dt2 = window.dtBalanceDet;
      const visibleIdx = dt2 && typeof dt2.columns === 'function'
        ? dt2.columns(':visible').indexes().toArray()
        : Array.from({length: (orig.tHead?.rows[0]?.cells.length || 0)}, (_,i)=>i);

      const mini = buildVisibleOnlyTable2(orig, visibleIdx);
      const headersExport = getHeaderTextsByIndex2(mini);

      const ws = XLSX.utils.table_to_sheet(mini, { raw: true });
      ws['!autofilter'] = { ref: ws['!ref'] };
      const widthMap = {
        'Clientes':28,'Estaci√≥n':24,'Fecha':12,'Vencimiento':12,
        'Saldo Actual':16,'Por Vencer':16,'Vencido 1-15':12,'Vencido 16-30':12,
        'Vencido 31-45':12,'Vencido 45+':12,'Total Vencido':14,'Cliente (hidden)':28
      };
      ws['!cols'] = headersExport.map(h => ({ wch: widthMap[h] || 14 }));

      // <<< TOTALS ROW ADDED >>> (Facturas: suma 4..10 en todo lo filtrado)
      if (ws['!ref']) {
        const range = XLSX.utils.decode_range(ws['!ref']);
        const totalsRowIndex = range.e.r + 1;
        const makeAddr = (c) => XLSX.utils.encode_cell({ r: totalsRowIndex, c });
        const boldCell = (cell) => { ws[cell] = ws[cell] || {}; ws[cell].s = Object.assign({}, ws[cell].s||{}, { font:{ bold:true } }); };

        // Primera visible: "Totales"
        const firstColAddr = makeAddr(0);
        ws[firstColAddr] = { t:'s', v:'Totales' };
        boldCell(firstColAddr);

        const sumCols = new Set([4,5,6,7,8,9,10]);
        visibleIdx.forEach((origColIdx, pos) => {
          if (pos === 0) return;
          const addr = makeAddr(pos);
          if (sumCols.has(origColIdx)) {
            const s = sumApplied2(dt2, origColIdx);
            ws[addr] = { t:'n', v:s, z:'#,##0.00' };
            boldCell(addr);
          } else {
            ws[addr] = { t:'s', v:'' };
          }
        });

        // Expandir rango
        ws['!ref'] = XLSX.utils.encode_range({
          s:{ r: range.s.r, c: range.s.c },
          e:{ r: totalsRowIndex, c: range.e.c }
        });
      }
      // <<< /TOTALS ROW ADDED >>>

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Facturas');

      const cta = "{{ cta_sel is not null ? cta_sel : '' }}";
      const gas = "{{ gas_sel is not null ? gas_sel : '' }}";
      XLSX.writeFile(wb, `Balance_Facturas_${cta}_${gas}_${new Date().toISOString().slice(0,10)}.xlsx`);
    });
  }

});
</script>

{% if submitted %}
<!-- ===== Env√≠o por correo (Totales / Facturas por cliente) ===== -->
<script>
/* Utilidades comunes */
function ba_getHeaders(table) {
  const headers = [];
  if (table.tHead && table.tHead.rows.length) {
    const row = table.tHead.rows[0];
    for (let i = 0; i < row.cells.length; i++) headers.push((row.cells[i].innerText || row.cells[i].textContent || '').trim());
  }
  return headers;
}
function ba_sanitizeFilenamePart(s){
  return (s||'').toString().normalize('NFKD').replace(/[^\w\s.-]/g,'').replace(/\s+/g,'_').slice(0,80);
}
function ba_buildWorkbookBase64(opt){
  const { tableId, dtInstance, widthMap, sheetName, filePrefix, paintPct } = opt;
  const orig = document.getElementById(tableId);
  if (!orig) return null;

  const visibleIdx = dtInstance?.columns ? dtInstance.columns(':visible').indexes().toArray()
                                         : Array.from({length: (orig.tHead?.rows[0]?.cells.length || 0)}, (_,i)=>i);

  const tmp = document.createElement('table'); tmp.className = orig.className;

  // Header
  if (orig.tHead){
    const dstHead = tmp.createTHead();
    const srcRow = orig.tHead.rows[0];
    const dstRow = dstHead.insertRow(-1);
    visibleIdx.forEach(i=>{
      const cell = srcRow.cells[i]; if (!cell) return;
      const c = document.createElement('th'); c.innerHTML = cell.innerHTML; c.className = cell.className;
      dstRow.appendChild(c);
    });
  }

  // Body (todo lo visible)
  const dstBody = tmp.createTBody();
  const srcBody = orig.tBodies[0];
  if (srcBody){
    for (const srcRow of srcBody.rows){
      const dstRow = dstBody.insertRow(-1);
      visibleIdx.forEach(i=>{
        const cell = srcRow.cells[i]; if (!cell) return;
        const c = document.createElement('td'); c.innerHTML = cell.innerHTML; c.className = cell.className;
        dstRow.appendChild(c);
      });
    }
  }

  const headersExport = ba_getHeaders(tmp);
  const ws = XLSX.utils.table_to_sheet(tmp, { raw:true });
  if (ws['!ref']) ws['!autofilter'] = { ref: ws['!ref'] };
  ws['!cols'] = headersExport.map(h => ({ wch: widthMap[h] || 14 }));

  // Pintar % (si aplica)
  if (paintPct && ws['!ref']) {
    const HEADER_PCT = '% de vencimiento';
    const colPctExport = headersExport.findIndex(h => h === HEADER_PCT);
    if (colPctExport >= 0) {
      const range = XLSX.utils.decode_range(ws['!ref']);
      const firstDataRow = range.s.r + 1;
      for (let r = firstDataRow; r <= range.e.r; r++){
        const addr = XLSX.utils.encode_cell({ r, c: colPctExport });
        const cell = ws[addr]; if (!cell) continue;
        const raw = (cell.v ?? '').toString();
        const val100 = parseFloat(raw.replace('%','').replace(/[^0-9.\-]/g,'')); if (isNaN(val100)) continue;
        ws[addr] = { t: 'n', v: val100/100, z: '0.00%' };
        let fg='C6EFCE', fontColor='006100'; if (val100>40){fg='F8CBAD';fontColor='9C0006';} else if (val100>10){fg='FFF2CC';fontColor='7F6000';}
        ws[addr].s = { fill:{patternType:"solid",fgColor:{rgb:fg}}, font:{color:{rgb:fontColor}} };
      }
    }
  }

  // <<< TOTALS ROW ADDED >>> (para env√≠o por correo - Totales / Facturas)
  (function appendTotalsRow(){
    if (!dtInstance || !ws['!ref']) return;
    const range = XLSX.utils.decode_range(ws['!ref']);
    const totalsRowIndex = range.e.r + 1;
    const makeAddr = (c) => XLSX.utils.encode_cell({ r: totalsRowIndex, c });
    const boldCell = (addr) => { ws[addr] = ws[addr] || {}; ws[addr].s = Object.assign({}, ws[addr].s||{}, { font:{ bold:true } }); };

    // "Totales" en la primera columna visible
    const firstAddr = makeAddr(0);
    ws[firstAddr] = { t:'s', v:'Totales' };
    boldCell(firstAddr);

    // Funciones de suma con filtro aplicado
    const parseNumber = (v)=>{ const s=(v==null?'':String(v)).replace(/[^0-9.\-]/g,''); const n=parseFloat(s); return isNaN(n)?0:n; };
    const sumApplied = (col)=>{ const data = dtInstance.column(col,{search:'applied'}).data(); let acc=0; for (let i=0;i<data.length;i++) acc+=parseNumber(data[i]); return acc; };

    // Totales para TOTALES (cols 6..12) y FACTURAS (cols 4..10)
    const visibleSet = new Set(visibleIdx);
    const isTotales = visibleSet.has(13) || visibleSet.has(6); // heur√≠stica simple
    const sumColsTotales = new Set([6,7,8,9,10,11,12]);
    const sumColsFacturas = new Set([4,5,6,7,8,9,10]);

    let totalVencido = 0, totalCredito = 0;

    visibleIdx.forEach((origColIdx, pos) => {
      if (pos === 0) return;
      const addr = makeAddr(pos);

      if (isTotales) {
        if (sumColsTotales.has(origColIdx)) {
          const s = sumApplied(origColIdx);
          ws[addr] = { t:'n', v:s, z:'#,##0.00' }; boldCell(addr);
          if (origColIdx === 12) totalVencido = s;
        } else if (origColIdx === 4) {
          const s = sumApplied(4);
          ws[addr] = { t:'n', v:s, z:'#,##0.00' }; boldCell(addr);
          totalCredito = s;
      } else if (origColIdx === 13) {
  // % de vencimiento en Totales (Excel): vac√≠o
  ws[addr] = { t:'s', v:'' };
}

      } else {
        // FACTURAS
        if (sumColsFacturas.has(origColIdx)) {
          const s = sumApplied(origColIdx);
          ws[addr] = { t:'n', v:s, z:'#,##0.00' }; boldCell(addr);
        } else {
          ws[addr] = { t:'s', v:'' };
        }
      }
    });

    // Expand range
    ws['!ref'] = XLSX.utils.encode_range({
      s:{ r: range.s.r, c: range.s.c },
      e:{ r: totalsRowIndex, c: range.e.c }
    });
  })();
  // <<< /TOTALS ROW ADDED >>>

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, sheetName || 'Hoja1');

  const cta = "{{ cta_sel is not null ? cta_sel : '' }}";
  const gas = "{{ gas_sel is not null ? gas_sel : '' }}";
  const filename = `${filePrefix || 'Balance'}_${cta}_${gas}_${new Date().toISOString().slice(0,10)}.xlsx`;
  const file_b64 = XLSX.write(wb, { bookType:'xlsx', type:'base64' });
  return { filename, file_b64 };
}


/* Construye workbook SOLO para un cliente (pesta√±a Facturas) */
function stripHTML(s){ const d=document.createElement('div'); d.innerHTML = s || ''; return (d.textContent||'').trim(); }
function parseNumberLike(txt){
  const t = stripHTML(txt);
  if (!/[0-9]/.test(t)) return null;
  const n = parseFloat(t.replace(/,/g,''));
  return isNaN(n) ? null : n;
}

/**
 * Construye un workbook S√ìLO con filas del cliente indicado,
 * usando DataTables (no el DOM) para que incluya todas las p√°ginas.
 */
function ba_buildClientWorkbookBase64({ tableId, dtInstance, widthMap, clientName, sheetName, filePrefix }){
  const orig = document.getElementById(tableId);
  if (!orig || !dtInstance) return null;

  const visibleIdx = dtInstance.columns(':visible').indexes().toArray();
  const thead = orig.tHead && orig.tHead.rows.length ? orig.tHead.rows[0] : null;
  const headers = visibleIdx.map(i => thead ? (thead.cells[i]?.innerText || '').trim() : '');

  const NUM_HEADERS = new Set([
    'Saldo Actual','Por Vencer','Vencido 1-15','Vencido 16-30',
    'Vencido 31-45','Vencido 45+','Total Vencido'
  ]);

  function stripHTML(s){ const d=document.createElement('div'); d.innerHTML = s || ''; return (d.textContent||'').trim(); }
  function parseNumberLike(txt){
    const t = stripHTML(txt);
    if (!/[0-9]/.test(t)) return null;
    const n = parseFloat(t.replace(/,/g,'')); // simple
    return isNaN(n) ? null : n;
  }

  const rows = [];
  dtInstance.rows({ search:'applied' }).every(function(){
    const data = this.data();
    const cliHidden = stripHTML(data[11] || '');
    if (cliHidden !== clientName) return;

    const row = visibleIdx.map((idx, j) => {
      const raw = data[idx];
      if (NUM_HEADERS.has(headers[j])) {
        const n = parseNumberLike(raw);
        return (n === null) ? stripHTML(raw) : n;
      }
      return stripHTML(raw);
    });
    rows.push(row);
  });

  if (!rows.length) return null;

  // <<< TOTALS ROW ADDED (cliente) >>>
  const totalsRow = headers.map((h, j) => {
    if (j === 0) return `Totales ${clientName}`;
    if (NUM_HEADERS.has(h)) {
      let s = 0;
      for (const r of rows) {
        const v = r[j];
        if (typeof v === 'number' && !isNaN(v)) s += v;
      }
      return s;
    }
    return '';
  });
  // <<< /TOTALS ROW ADDED >>>

  const aoa = [ headers, ...rows, totalsRow ];
  const ws  = XLSX.utils.aoa_to_sheet(aoa);

  // Autofiltro solo sobre los datos (sin incluir la fila Totales)
  if (ws['!ref']) {
    ws['!autofilter'] = {
      ref: XLSX.utils.encode_range({
        s:{ r:0, c:0 },
        e:{ r: rows.length, c: headers.length-1 }
      })
    };
  }

  ws['!cols'] = headers.map(h => ({ wch: (widthMap[h] || 14) }));

  // Negritas + formato num√©rico en fila de totales del cliente
  const totalsRowIndex = rows.length + 1;
  for (let c = 0; c < headers.length; c++) {
    const addr = XLSX.utils.encode_cell({ r: totalsRowIndex, c });
    if (!ws[addr]) continue;
    ws[addr].z = NUM_HEADERS.has(headers[c]) ? '#,##0.00' : ws[addr].z;
    ws[addr].s = Object.assign({}, ws[addr].s||{}, { font:{ bold:true } });
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, sheetName || 'Facturas');

  const cta = "{{ cta_sel is not null ? cta_sel : '' }}";
  const gas = "{{ gas_sel is not null ? gas_sel : '' }}";
  const safeCli = (clientName||'').toString().normalize('NFKD').replace(/[^\w\s.-]/g,'').replace(/\s+/g,'_').slice(0,80);
  const filename = `${filePrefix || 'Balance_Facturas'}_${cta}_${gas}_${safeCli}_${new Date().toISOString().slice(0,10)}.xlsx`;
  const file_b64  = XLSX.write(wb, { bookType:'xlsx', type:'base64' });

  return { filename, file_b64 };
}


/* -------- Modal & env√≠o -------- */
let ba_mailMode = 'totales';   // 'totales' | 'facturas'

document.addEventListener('DOMContentLoaded', function(){
  const modalEl = document.getElementById('mailModalBA');
  const modal   = new bootstrap.Modal(modalEl);
  const badge   = document.getElementById('mailModeBadge');
  const sendToWrap = document.getElementById('sendToWrap');
  const clientListSection = document.getElementById('clientListSection');
  const mailProgress = document.getElementById('mailProgress');

  function openModal(mode){
    ba_mailMode = mode;
    if (mode === 'totales'){
      badge.textContent = 'Totales'; badge.className = 'badge bg-secondary ms-2';
      sendToWrap.style.display = '';
      clientListSection.style.display = 'none';
      // pre-armar archivo de Totales
      const widthMap = {
        'Cliente':28,'Estaci√≥n':24,'Ult. D√©b.':12,'Ult. Cr√©d.':12,'Cr√©dito':14,'Dias Cr√©dito':12,
        'Saldo actual':16,'Por vencer':16,'1-15':10,'16-30':10,'31-45':10,'45+':10,'Total vencido':14,'% de vencimiento':16
      };
      const res = ba_buildWorkbookBase64({
        tableId: 'balance_age_table',
        dtInstance: window.dtBalance,
        widthMap,
        sheetName: 'Balance',
        filePrefix: 'Balance_Age',
        paintPct: true
      });
      window.__ba_totales_file = res;  // cache
    } else {
      badge.textContent = 'Facturas por cliente'; badge.className = 'badge bg-info ms-2';
      sendToWrap.style.display = 'none';
      clientListSection.style.display = '';
      // Pre-seleccionar el cliente del filtro (si hay)
      const current = $('#clientFilter').val();
      if (current){
        document.querySelectorAll('#clientListSection .chk-client').forEach(chk=>{
          chk.checked = (chk.value === current);
        });
      }
      // Reordenar seleccionados al inicio
      if (window.baReorderClientList) window.baReorderClientList();
    }
    document.getElementById('mailBody_ba').value = '';
    mailProgress.style.display = 'none';
    modal.show();
  }

  const btnTot = document.getElementById('btnMailTotales');
  if (btnTot) btnTot.addEventListener('click', ()=> openModal('totales'));

  const btnFact = document.getElementById('btnMailFacturas');
  if (btnFact) btnFact.addEventListener('click', ()=> openModal('facturas'));

  // Seleccionar todos / ninguno (clientes) - reordenar despu√©s
  const btnAll = document.getElementById('btnSelAllClients');
  const btnNone = document.getElementById('btnSelNoneClients');
  if (btnAll) btnAll.addEventListener('click', ()=>{
    document.querySelectorAll('#clientListSection .chk-client').forEach(chk=>chk.checked=true);
    window.baReorderClientList && window.baReorderClientList();
  });
  if (btnNone) btnNone.addEventListener('click', ()=>{
    document.querySelectorAll('#clientListSection .chk-client').forEach(chk=>chk.checked=false);
    window.baReorderClientList && window.baReorderClientList();
  });

  // Env√≠o
  const frm = document.getElementById('mail_form_ba');
  if (!frm) return;
  frm.addEventListener('submit', function(e){
    e.preventDefault();
    const cta = "{{ cta_sel is not null ? cta_sel : '' }}";
    const gas = "{{ gas_sel is not null ? gas_sel : '' }}";
    const bodyText = (document.getElementById('mailBody_ba').value || ' ');

    if (ba_mailMode === 'totales'){
      const file = window.__ba_totales_file;
      const sentTo = (document.getElementById('sentTo_ba').value || '').trim();
      if (!file){ toastr.error('No fue posible preparar el Excel.', 'Error'); return; }
      if (!sentTo){ toastr.warning('Indica al menos un destinatario.', 'Atenci√≥n'); return; }

      baSetLoading(true);
      $.ajax({
        url:'/income/balance_age_send_mail',
        method:'POST',
        data:{
          sentTo: sentTo,
          subject: `Balance por Cliente/Estaci√≥n - Totales (${new Date().toISOString().slice(0,10)})`,
          body: bodyText,
          filename: file.filename,
          file_b64: file.file_b64,
          cta: cta, gas: gas
        },
        success:function(resp){
          try{
            const r = (typeof resp === 'string') ? JSON.parse(resp) : resp;
            if (r.status === 'success'){
              toastr.success(r.message || 'Correo enviado.', '√âxito');
              const modal = bootstrap.Modal.getInstance(document.getElementById('mailModalBA'));
              modal && modal.hide();
            } else {
              toastr.error(r.message || 'No se pudo enviar el correo.', 'Error');
            }
          }catch(_){ toastr.error('Respuesta inesperada del servidor.','Error'); }
        },
        error:function(){ toastr.error('Error de red o del servidor.','Error'); },
        complete:function(){ baSetLoading(false); }
      });

    } else {
      // FACTURAS: enviar un correo por cliente seleccionado
      const chks = Array.from(document.querySelectorAll('#clientListSection .chk-client:checked'));
      if (!chks.length){ toastr.warning('Selecciona al menos un cliente.','Atenci√≥n'); return; }

      const widthMap = {
        'Clientes':28,'Estaci√≥n':24,'Fecha':12,'Vencimiento':12,
        'Saldo Actual':16,'Por Vencer':16,'Vencido 1-15':12,'Vencido 16-30':12,
        'Vencido 31-45':12,'Vencido 45+':12,'Total Vencido':14
      };
      let idx = 0, ok = 0, fail = 0;
      const modal = bootstrap.Modal.getInstance(document.getElementById('mailModalBA'));
      document.getElementById('mailProgress').style.display = '';
      document.getElementById('mailProgress').textContent = `Enviando 0/${chks.length}‚Ä¶`;

      baSetLoading(true);

      (function sendNext(){
        if (idx >= chks.length){
          toastr[fail ? 'warning' : 'success'](`Env√≠o finalizado. OK: ${ok}, Error: ${fail}`);
          modal && modal.hide();
          baSetLoading(false);
          return;
        }
        const chk = chks[idx++];
        const cliente = chk.value;
        const email = (chk.dataset.email || '').trim();
        if (!email){
          fail++; document.getElementById('mailProgress').textContent = `(${idx}/${chks.length}) Sin correo para "${cliente}". Saltando‚Ä¶`;
          setTimeout(sendNext, 300);
          return;
        }

        const file = ba_buildClientWorkbookBase64({
          tableId:'balance_age_table_det',
          dtInstance: window.dtBalanceDet,
          widthMap,
          clientName: cliente,
          sheetName:'Facturas',
          filePrefix:'Balance_Facturas'
        });
        if (!file){
          fail++; document.getElementById('mailProgress').textContent = `(${idx}/${chks.length}) Error al generar Excel de "${cliente}".`;
          setTimeout(sendNext, 300);
          return;
        }

        $.ajax({
          url:'/income/balance_age_send_mail',
          method:'POST',
          data:{
            CharSet: 'UTF-8',
            Encoding : 'base64',
            sentTo: email,
            subject: `Balance por Cliente/Estaci√≥n - Facturas (${cliente}) (${new Date().toISOString().slice(0,10)})`,
            body: bodyText || `Adjuntamos el Excel con el detalle de facturas del cliente ${cliente}.`,
            filename: file.filename,
            file_b64: file.file_b64,
            cta: cta, gas: gas
          },
          success:function(resp){
            try{
              const r = (typeof resp === 'string') ? JSON.parse(resp) : resp;
              if (r.status === 'success'){ ok++; }
              else { fail++; toastr.error(r.message || `Error al enviar a ${email}`, 'Error'); }
            }catch(_){ fail++; }
          },
          error:function(){ fail++; },
          complete:function(){
            document.getElementById('mailProgress').textContent = `Enviando ${idx}/${chks.length}‚Ä¶ (OK: ${ok} / Error: ${fail})`;
            setTimeout(sendNext, 200);
          }
        });
      })();
    }
  });
});
</script>
{% endif %}
{% endblock %}
