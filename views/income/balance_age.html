{% extends "views/layouts/base.html" %}
{% block title %}Balance por Cliente / Estación (filtros){% endblock %}

{% block mycss %}
<style>

/* Botón Consultar alto 100px y centrado del texto */
.btn-consultar{
  height: 60px;
  width: 200px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0 1rem; /* conserva padding horizontal */
  
}
/* -----------------------------
   Estilos DataTables (skin)
------------------------------ */
table.dataTable thead th,
table.dataTable thead td{
  padding: 10px 18px;
  border-bottom: 1px solid #dee2e6;
  background-color: #3485a8 !important;
  color: #ffffff !important;
}
table.dataTable tfoot th,
table.dataTable tfoot td{
  padding: 10px 18px;
  border-top: 1px solid #dee2e6;
  background-color: #3485a8 !important;
  color: #ffffff !important;
}

/* -----------------------------
   Solo la tabla scrollea (slide)
------------------------------ */
.table-wrap{
  position: relative;
  max-height: 60vh;
  overflow: auto;
  border-top: 1px solid #e9ecef;
  -webkit-overflow-scrolling: touch;
}
.table-wrap table{
  border-collapse: separate; /* sticky + table */
  border-spacing: 0;
}

/* Select2 del filtro de cliente: mínimo 500px */
#clientFilter + .select2-container{
  min-width: 400px !important;
}

/* -----------------------------
   THEAD fijo
------------------------------ */
.table-wrap thead{
  position: sticky !important;
  top: 0;
  z-index: 4;
}
.table-wrap thead tr{
  position: sticky !important;
  top: 0;
  z-index: 5;
}
.table-wrap thead th,
.table-wrap thead td{
  position: sticky !important;
  top: 0;
  z-index: 6;
  background-color: #3485a8 !important;
  background-clip: padding-box;
}
.table-wrap thead th{ box-shadow: 0 2px 0 rgba(0,0,0,.05); }

/* (TFOOT no fijo) */
.table-wrap tfoot th,
.table-wrap tfoot td{ position: static !important; }

/* -----------------------------
   Configuración de las tablas
------------------------------ */
#balance_age_table,
#balance_age_table_det{
  width: auto !important;
  table-layout: auto !important;
  white-space: nowrap;
  text-align: center;
}

/* Colores para % (solo tabla Totales) */
.pct-green  { background: #c6efce !important; color: #006100 !important; }
.pct-yellow { background: #fff2cc !important; color: #7f6000 !important; }
.pct-red    { background: #f8cbad !important; color: #9c0006 !important; }
td.pct-green, td.pct-yellow, td.pct-red{ border-radius: 2px; }

/* -----------------------------
   Controles de DataTables fijos
------------------------------ */
#dt-controls-top, #dt-controls-bottom,
#dt-controls-top-det, #dt-controls-bottom-det{
  position: relative; overflow: visible; background: transparent; gap: .75rem;
}
#dt-controls-top .dataTables_length label,
#dt-controls-bottom .dataTables_length label,
#dt-controls-top-det .dataTables_length label,
#dt-controls-bottom-det .dataTables_length label,
.dataTables_length label{
  display: inline-flex; align-items: center; gap: .5rem; white-space: nowrap; margin: 0;
}
#dt-controls-top .dataTables_length select,
#dt-controls-bottom .dataTables_length select,
#dt-controls-top-det .dataTables_length select,
#dt-controls-bottom-det .dataTables_length select,
.dataTables_length select{
  width: auto !important; display: inline-block; min-width: 72px;
}
.dataTables_filter{ margin-left: auto; }
#dt-controls-bottom .dataTables_info,
#dt-controls-bottom-det .dataTables_info{ white-space: nowrap; }
#dt-controls-bottom .dataTables_paginate,
#dt-controls-bottom-det .dataTables_paginate{ margin-left: auto; }

/* -----------------------------
   Extras (pestaña Facturas)
------------------------------ */
tr.group-start { background: #c6efce !important; font-weight: 600; }
tr.group-total { background: #e2f0d9 !important; font-weight: 700; }

/* Columna oculta de cliente (para evitar parpadeo antes de DT) */
.col-cliente-oculto{ display:none; }

.table-wrap .dropdown-menu{ z-index: 1040; }
.table-wrap::-webkit-scrollbar{ height: 10px; width: 10px; }
.table-wrap::-webkit-scrollbar-thumb{ background-color: rgba(0,0,0,.2); border-radius: 8px; }
.table-wrap::-webkit-scrollbar-track{ background: transparent; }

/* Más separación entre 'Mostrar _ entradas' y 'Buscar' */
#dt-controls-top,
#dt-controls-top-det{
  gap: 4rem; /* aumenta la separación general */
}

/* Poner "Buscar:" e input en una sola línea y centrados verticalmente */
.dataTables_filter label,
#dt-controls-top .dataTables_filter label,
#dt-controls-top-det .dataTables_filter label,
#dt-controls-bottom .dataTables_filter label,
#dt-controls-bottom-det .dataTables_filter label{
  display: inline-flex !important;
  align-items: center;
  gap: .5rem;           /* espacio entre texto e input */
  white-space: nowrap;  /* evita que el label salte de línea */
  margin: 0;
}

/* (opcional) ancho del input de búsqueda */
.dataTables_filter input[type="search"]{
  width: 260px;         /* ajusta a gusto */
  display: inline-block;
}

</style>


{% endblock %}

{% block menutitle %}Balance por Cliente / Estación{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="card flex-fill">

      <!-- Header con filtros -->
      <div class="card-header py-3">
        <form method="get" class="row gy-3 gx-3 align-items-end">
          <!-- Cuenta -->
          <div class="col-12 col-md-6 col-lg-3">
            <label for="cta" class="form-label mb-1">Cuenta</label>
            <select id="cta" name="cta" class="form-select form-select-sm" required>
              <option value="" {{ cta_sel is null ? 'selected' : '' }} disabled>Selecciona una cuenta…</option>
              {% for val, label in cuentas %}
                <option value="{{ val }}" {{ val == cta_sel ? 'selected' : '' }}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Estación -->
          <div class="col-12 col-md-6 col-lg-3">
            <label for="gas" class="form-label mb-1">Estación</label>
            <select id="gas" name="gas" class="form-select form-select-sm" required>
              <option value="" {{ gas_sel is null ? 'selected' : '' }} disabled>Selecciona una estación…</option>
              {% for g in gasolineras %}
                <option value="{{ g.cod }}" {{ g.cod == gas_sel ? 'selected' : '' }}>{{ g.den }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Mostrar todas (switch) -->
          <div class="col-12 col-lg-4 d-flex align-items-center">
            <div class="form-check form-switch mt-2 mt-lg-0">
              <input class="form-check-input" type="checkbox" id="show_all" checked>
              <label class="form-check-label" for="show_all">Mostrar todas</label>
            </div>
          </div>

         <!-- Botón Consultar alineado a la derecha -->
          <div class="col-12 col-lg-2 ms-auto text-end">
            <div class="d-grid d-sm-flex justify-content-end">
              <button type="submit" class="btn btn-primary btn-consultar">
                <i class="fa fa-search me-1"></i> Consultar
              </button>
            </div>
          </div>

        </form>
      </div>

      {% if submitted %}
      <!-- Tabs -->
      <div class="card-body pb-2 pt-0 px-0">
        <ul class="nav nav-tabs px-3" id="baTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="totales-tab" data-bs-toggle="tab" data-bs-target="#totales-pane" type="button" role="tab" aria-controls="totales-pane" aria-selected="true">
              Totales
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="facturas-tab" data-bs-toggle="tab" data-bs-target="#facturas-pane" type="button" role="tab" aria-controls="facturas-pane" aria-selected="false">
              Facturas
            </button>
          </li>
        </ul>
      </div>

      <div class="tab-content">
        <!-- ===== TAB 1: TOTALES (original) ===== -->
        <div class="tab-pane fade show active" id="totales-pane" role="tabpanel" aria-labelledby="totales-tab" tabindex="0">

          <!-- Controles superiores (estáticos) + Excel Totales + ENVIAR MAIL -->
          <div class="d-flex flex-wrap justify-content-between align-items-center mt-4 mb-0 px-3">
            <div id="dt-controls-top" class="d-flex flex-wrap justify-content-between align-items-center"></div>

            <div class="d-flex gap-2">
              <button id="btnExportXLS" type="button" class="btn btn-success btn-sm">
                <i class="fa-solid fa-file-excel me-1"></i> Exportar a Excel (Totales)
              </button>
              <!-- NUEVO: enviar por correo (Totales) -->
              <button id="btnMailTotales" type="button" class="btn btn-danger btn-sm">
                <i class="fa-solid fa-envelope me-1"></i> Enviar por correo
              </button>
            </div>
          </div>

          <div class="table-wrap">
            <table id="balance_age_table" class="table table-striped table-hover table-sm">
              <thead>
                <tr>
                  <th>Cliente</th>
                  <th>Estación</th>
                  <th>Ult. Déb.</th>
                  <th>Ult. Créd.</th>
                  <th>Crédito</th>
                  <th>Dias Crédito</th>
                  <th>Saldo actual</th>
                  <th>Por vencer</th>
                  <th>1-15</th>
                  <th>16-30</th>
                  <th>31-45</th>
                  <th>45+</th>
                  <th>Total vencido</th>
                  <th>% de vencimiento</th>
                </tr>
              </thead>
              <tbody>
                {% for r in rows %}
                  <tr>
                    <td style="text-align: left !important;">{{ r.Cliente }}</td>
                    <td>{{ r.Estacion }}</td>
                    <td>{{ r['ult. deb.'] }}</td>
                    <td>{{ r['ult. cred.'] }}</td>
                    <td class="text-end">{{ r.Credito is not null ? r.Credito|number_format(2,'.',',') : '' }}</td>
                    <td>{{ r['cond. pago'] }}</td>
                    <td class="text-end">{{ r['Saldo actual']|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ r['Por vencer']|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ r['1-15']|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ r['16-30']|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ r['31-45']|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ r['45+']|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ r['Total vencido']|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ r['% de vencimiento'] is not null ? (r['% de vencimiento']|number_format(2,'.',',')) ~ '%' : '' }}</td>
                  </tr>
                {% endfor %}
              </tbody>
              <tfoot>
                <tr>
                  <th class="text-end">Totales</th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum="6"></th>
                  <th class="text-end" data-colsum="7"></th>
                  <th class="text-end" data-colsum="8"></th>
                  <th class="text-end" data-colsum="9"></th>
                  <th class="text-end" data-colsum="10"></th>
                  <th class="text-end" data-colsum="11"></th>
                  <th class="text-end" data-colsum="12"></th>
                  <th class="text-end" data-colpct="13"></th>
                </tr>
              </tfoot>
            </table>
          </div>

          <div id="dt-controls-bottom" class="d-flex flex-wrap justify-content-between align-items-center gap-2 py-2 px-3"></div>
        </div>

        <!-- ===== TAB 2: FACTURAS (detalle agrupado + filtro de cliente) ===== -->
        <div class="tab-pane fade" id="facturas-pane" role="tabpanel" aria-labelledby="facturas-tab" tabindex="0">

          <!-- Top bar: controles DT + Select cliente + Excel + ENVIAR MAIL -->
          <div class="d-flex flex-wrap justify-content-between align-items-center mt-4 mb-0 px-3">
            <div id="dt-controls-top-det" class="d-flex flex-wrap justify-content-between align-items-center"></div>

            <div class="d-flex flex-wrap align-items-center gap-2" style="min-width: 50%;">
              {% set clientes_list = [] %}
              {% for r in rows_det %}
                {% if r.Cliente is defined and r.Cliente is not empty and (r.Cliente not in clientes_list) %}
                  {% set clientes_list = clientes_list|merge([r.Cliente]) %}
                {% endif %}
              {% endfor %}
              <label for="clientFilter" class="form-label mb-0">Cliente:</label>
              <select id="clientFilter" class="form-select form-select-sm" style="min-width:400px;">
                <option value="">(Todos)</option>
                {% for c in clientes_list|sort %}
                  <option value="{{ c|e }}">{{ c }}</option>
                {% endfor %}
              </select>

              <div class="d-flex gap-2">
                <button id="btnExportXLS_det" type="button" class="btn btn-success btn-sm">
                  <i class="fa-solid fa-file-excel me-1"></i> Exportar a Excel (Facturas)
                </button>
                <!-- NUEVO: enviar por correo (Facturas) -->
                <button id="btnMailFacturas" type="button" class="btn btn-danger btn-sm">
                  <i class="fa-solid fa-envelope me-1"></i> Enviar por correo
                </button>
              </div>
            </div>
          </div>

          <div class="table-wrap">
            <table id="balance_age_table_det" class="table table-striped table-hover table-sm">
              <thead>
                <tr>
                  <th>Clientes</th>      {# 0: C-Cliente / - Factura #}
                  <th>Estación</th>      {# 1 (toggle) #}
                  <th>Fecha</th>         {# 2 #}
                  <th>Vencimiento</th>   {# 3 #}
                  <th>Saldo Actual</th>  {# 4 (sum) #}
                  <th>Por Vencer</th>    {# 5 (sum) #}
                  <th>Vencido 1-15</th>  {# 6 (sum) #}
                  <th>Vencido 16-30</th> {# 7 (sum) #}
                  <th>Vencido 31-45</th> {# 8 (sum) #}
                  <th>Vencido 45+</th>   {# 9 (sum) #}
                  <th>Total Vencido</th> {# 10 (sum) #}
                  <th>Cliente (hidden)</th> {# 11 (oculta, usada para búsqueda) #}
                </tr>
              </thead>
              <tbody>
                {% if rows_det|length > 0 %}
                  {% set cliente_actual = null %}
                  {% set ts = 0 %}{% set tpv = 0 %}{% set t115 = 0 %}{% set t1630 = 0 %}{% set t3145 = 0 %}{% set t45 = 0 %}{% set ttv = 0 %}

                  {% for r in rows_det %}
                    {% set cliente = r.Cliente %}
                    {% if cliente_actual is not same as(cliente) %}
                      {% if cliente_actual is not null %}
                        <tr class="group-total">
                          <td class="text-end">Totales {{ cliente_actual }}</td>
                          <td></td><td></td><td></td>
                          <td class="text-end">{{ ts|number_format(2,'.',',') }}</td>
                          <td class="text-end">{{ tpv|number_format(2,'.',',') }}</td>
                          <td class="text-end">{{ t115|number_format(2,'.',',') }}</td>
                          <td class="text-end">{{ t1630|number_format(2,'.',',') }}</td>
                          <td class="text-end">{{ t3145|number_format(2,'.',',') }}</td>
                          <td class="text-end">{{ t45|number_format(2,'.',',') }}</td>
                          <td class="text-end">{{ ttv|number_format(2,'.',',') }}</td>
                          <td class="col-cliente-oculto">{{ cliente_actual }}</td>
                        </tr>
                        {% set ts = 0 %}{% set tpv = 0 %}{% set t115 = 0 %}{% set t1630 = 0 %}{% set t3145 = 0 %}{% set t45 = 0 %}{% set ttv = 0 %}
                      {% endif %}

                      <tr class="group-start">
                        <td style="text-align:left !important;">C-{{ r.Cliente }}{% if r['cond. pago'] %} ({{ r['cond. pago'] }}){% endif %}</td>
                        <td>{{ r.Estacion }}</td>
                        <td></td><td></td>
                        <td class="text-end"></td><td class="text-end"></td><td class="text-end"></td>
                        <td class="text-end"></td><td class="text-end"></td><td class="text-end"></td>
                        <td class="text-end"></td>
                        <td class="col-cliente-oculto">{{ r.Cliente }}</td>
                      </tr>

                      {% set cliente_actual = cliente %}
                    {% endif %}

                    {% set factura_num = (r.nroope is defined and r.nroope is not null) ? (r.nroope - 1700000000) : null %}
                    <tr>
                      <td style="text-align:left !important;">- Factura #{{ factura_num is not null ? factura_num : '' }}</td>
                      <td>{{ r.Estacion }}</td>
                      <td>{{ r.fchope_dt is not null ? (r.fchope_dt|date('d/m/Y')) : '' }}</td>
                      <td>{{ r.fchvto_dt is not null ? (r.fchvto_dt|date('d/m/Y')) : '' }}</td>
                      <td class="text-end">{{ r['Saldo actual']|number_format(2,'.',',') }}</td>
                      <td class="text-end">{{ r['Por vencer']|number_format(2,'.',',') }}</td>
                      <td class="text-end">{{ r['1-15']|number_format(2,'.',',') }}</td>
                      <td class="text-end">{{ r['16-30']|number_format(2,'.',',') }}</td>
                      <td class="text-end">{{ r['31-45']|number_format(2,'.',',') }}</td>
                      <td class="text-end">{{ r['45+']|number_format(2,'.',',') }}</td>
                      <td class="text-end">{{ r['Total vencido']|number_format(2,'.',',') }}</td>
                      <td class="col-cliente-oculto">{{ r.Cliente }}</td>
                    </tr>

                    {% set ts    = ts    + (r['Saldo actual']  ?? 0) %}
                    {% set tpv   = tpv   + (r['Por vencer']    ?? 0) %}
                    {% set t115  = t115  + (r['1-15']          ?? 0) %}
                    {% set t1630 = t1630 + (r['16-30']         ?? 0) %}
                    {% set t3145 = t3145 + (r['31-45']         ?? 0) %}
                    {% set t45   = t45   + (r['45+']           ?? 0) %}
                    {% set ttv   = ttv   + (r['Total vencido'] ?? 0) %}
                  {% endfor %}

                  <tr class="group-total">
                    <td class="text-end">Totales {{ cliente_actual }}</td>
                    <td></td><td></td><td></td>
                    <td class="text-end">{{ ts|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ tpv|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ t115|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ t1630|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ t3145|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ t45|number_format(2,'.',',') }}</td>
                    <td class="text-end">{{ ttv|number_format(2,'.',',') }}</td>
                    <td class="col-cliente-oculto">{{ cliente_actual }}</td>
                  </tr>
                {% endif %}
              </tbody>
              <tfoot>
                <tr>
                  <th class="text-end">Totales</th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum=""></th>
                  <th class="text-end" data-colsum="4"></th>
                  <th class="text-end" data-colsum="5"></th>
                  <th class="text-end" data-colsum="6"></th>
                  <th class="text-end" data-colsum="7"></th>
                  <th class="text-end" data-colsum="8"></th>
                  <th class="text-end" data-colsum="9"></th>
                  <th class="text-end" data-colsum="10"></th>
                  <th class="text-end" data-colsum=""></th> {# col oculta #}
                </tr>
              </tfoot>
            </table>
          </div>

          <div id="dt-controls-bottom-det" class="d-flex flex-wrap justify-content-between align-items-center gap-2 py-2 px-3"></div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>

{% if submitted %}
<!-- ===== NUEVO: Modal para enviar por correo (reutilizable) ===== -->
<div class="modal fade" id="mailModalBA" tabindex="-1" aria-labelledby="mailModalBALabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="mailModalBALabel">Enviar Excel por correo</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <form id="mail_form_ba">
        <div class="modal-body">
          <div class="mb-3">
            <label for="sentTo_ba" class="form-label">Enviar a:</label>
            <input type="text" class="form-control" id="sentTo_ba" name="sentTo_ba" placeholder="correo1@totalgas.com; correo2@totalgas.com">
            <hr>
            <small class="text-primary d-block">Se enviará el archivo Excel generado de la pestaña activa.</small>
            <small class="text-primary d-block">Puedes agregar varios correos separados por <b>;</b> (punto y coma). Solo se aceptan dominios @totalgas.com.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary btn-sm">Enviar</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block myjs %}
<script src="{{ JS }}administration.js"></script>

<!-- Select2 (para buscador dentro del select de cliente) -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Helpers % y sumas -->
<script>
function parsePercentCellText(txt){
  if (txt == null) return NaN;
  const s = (txt+'').replace('%','').replace(/[^0-9.\-]/g,'');
  const v = parseFloat(s);
  return isNaN(v) ? NaN : v;
}
function colorizePctCells(dt){
  const colPct = 13;
  if (!dt?.cells) return;
  dt.cells(null, colPct, {page:'current'}).every(function(){
    const td = this.node();
    const val = parsePercentCellText(this.data());
    td.classList.remove('pct-green','pct-yellow','pct-red');
    if (isNaN(val)) return;
    if (val <= 10)        td.classList.add('pct-green');
    else if (val <= 40)   td.classList.add('pct-yellow');
    else                  td.classList.add('pct-red');
  });
  const $cell = $(dt.table().footer()).find('[data-colpct="13"]');
  if ($cell.length){
    const val = parsePercentCellText($cell.text());
    $cell.removeClass('pct-green pct-yellow pct-red');
    if (!isNaN(val)){
      if (val <= 10)        $cell.addClass('pct-green');
      else if (val <= 40)   $cell.addClass('pct-yellow');
      else                  $cell.addClass('pct-red');
    }
  }
}
function sumColumn(api, colIdx) {
  return api.column(colIdx, { page: 'current' }).data().reduce((acc, val) => {
    const n = (val+'').replace(/[^0-9.\-]/g,'');
    const parsed = parseFloat(n);
    return acc + (isNaN(parsed) ? 0 : parsed);
  }, 0);
}
</script>

<!-- ===== Inicialización TOTALES (sin cambios) ===== -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const tbl = document.getElementById('balance_age_table');
  if (!tbl) return;

  const dt = $('#balance_age_table').DataTable({
    autoWidth: false, ordering: true, order: [],
    searching: true, paging: true, info: true, dom: 'lfrtip',
    pageLength: 50,
    lengthMenu: [[25,50,100,250,500,-1],[25,50,100,250,500,'Todas']],
    language: {
      lengthMenu: 'Mostrar _MENU_ entradas',
      info: 'Mostrando _START_ a _END_ de _TOTAL_ entradas',
      infoEmpty: 'Mostrando 0 a 0 de 0 entradas',
      infoFiltered: '(filtrado de _MAX_ entradas totales)',
      search: 'Buscar:',
      paginate: { first:'Primero', last:'Último', next:'Siguiente', previous:'Anterior' }
    },
    footerCallback: function () {
      const api = this.api();
      [6,7,8,9,10,11,12].forEach(idx => {
        const total = sumColumn(api, idx);
        $(api.table().footer()).find(`[data-colsum="${idx}"]`)
          .text(total.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}));
      });
      const totalVencido = sumColumn(api, 12);
      const totalCredito = sumColumn(api, 4);
      const $pctCell = $(api.table().footer()).find('[data-colpct="13"]');
      if (totalCredito > 0) {
        const pct = (totalVencido / totalCredito) * 100;
        $pctCell.text(pct.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}) + '%');
      } else {
        $pctCell.text('—');
      }
    }
  });
  window.dtBalance = dt;

  dt.on('draw', function(){ colorizePctCells(dt); });
  colorizePctCells(dt);

  const $wrap = $(dt.table().container());
  $('#dt-controls-top')
    .append($wrap.find('.dataTables_length'))
    .append($wrap.find('.dataTables_filter'));
  $('#dt-controls-bottom')
    .append($wrap.find('.dataTables_info'))
    .append($wrap.find('.dataTables_paginate'));

  const showAll = document.getElementById('show_all');
  const toggleCols = () => {
    const visible = showAll.checked;
    [1,2,3].forEach(i => dt.column(i).visible(visible, false));
    dt.columns.adjust().draw(false);
  };
  if (showAll) { toggleCols(); showAll.addEventListener('change', toggleCols); }

  const tabEls = document.querySelectorAll('#baTabs button[data-bs-toggle="tab"]');
  tabEls.forEach(el => el.addEventListener('shown.bs.tab', () => { dt.columns.adjust(); }));
});
</script>

<!-- ===== Exportar Excel (Totales) ===== -->
<script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const btn = document.getElementById('btnExportXLS');
  if (!btn) return;

  function buildVisibleOnlyTable(origTable, visibleIdx) {
    const tmp = document.createElement('table'); tmp.className = origTable.className;
    const sections = [
      {src: origTable.tHead, dst: tmp.createTHead()},
      {src: origTable.tBodies[0], dst: tmp.createTBody()},
      {src: origTable.tFoot, dst: tmp.createTFoot()}
    ];
    sections.forEach(({src, dst}) => {
      if (!src) return;
      for (const srcRow of src.rows) {
        const dstRow = dst.insertRow(-1);
        visibleIdx.forEach((i) => {
          const cell = srcRow.cells[i]; if (!cell) return;
          const newCell = cell.tagName.toLowerCase() === 'th' ? document.createElement('th') : document.createElement('td');
          newCell.innerHTML = cell.innerHTML; newCell.className = cell.className;
          dstRow.appendChild(newCell);
        });
      }
    });
    return tmp;
  }
  function getHeaderTextsByIndex(table) {
    const headers = [];
    if (table.tHead && table.tHead.rows.length) {
      const row = table.tHead.rows[0];
      for (let i = 0; i < row.cells.length; i++) headers.push((row.cells[i].innerText || row.cells[i].textContent || '').trim());
    }
    return headers;
  }

  btn.addEventListener('click', function () {
    const orig = document.getElementById('balance_age_table'); if (!orig) return;
    const dt = window.dtBalance;
    let visibleIdx = dt && typeof dt.columns === 'function'
      ? dt.columns(':visible').indexes().toArray()
      : Array.from({length: (orig.tHead?.rows[0]?.cells.length || 0)}, (_,i)=>i);

    const mini = buildVisibleOnlyTable(orig, visibleIdx);
    const headersExport = getHeaderTextsByIndex(mini);

    const ws = XLSX.utils.table_to_sheet(mini, { raw: true });
    ws['!autofilter'] = { ref: ws['!ref'] };
    const widthMap = {
      'Cliente':28,'Estación':24,'Ult. Déb.':12,'Ult. Créd.':12,'Crédito':14,'Dias Crédito':12,
      'Saldo actual':16,'Por vencer':16,'1-15':10,'16-30':10,'31-45':10,'45+':10,'Total vencido':14,'% de vencimiento':16
    };
    ws['!cols'] = headersExport.map(h => ({ wch: widthMap[h] || 14 }));

    const HEADER_PCT = '% de vencimiento';
    const colPctExport = headersExport.findIndex(h => h === HEADER_PCT);
    if (colPctExport >= 0 && ws['!ref']) {
      const range = XLSX.utils.decode_range(ws['!ref']);
      const firstDataRow = range.s.r + 1;
      for (let r = firstDataRow; r <= range.e.r; r++){
        const addr = XLSX.utils.encode_cell({ r, c: colPctExport });
        const cell = ws[addr]; if (!cell) continue;
        const raw = (cell.v ?? '').toString();
        theVal100 = parseFloat(raw.replace('%','').replace(/[^0-9.\-]/g,'')); if (isNaN(theVal100)) continue;
        ws[addr] = { t: 'n', v: theVal100/100, z: '0.00%' };
        let fg='C6EFCE', fontColor='006100'; if (theVal100>40){fg='F8CBAD';fontColor='9C0006';} else if (theVal100>10){fg='FFF2CC';fontColor='7F6000';}
        ws[addr].s = { fill:{patternType:"solid",fgColor:{rgb:fg}}, font:{color:{rgb:fontColor}} };
      }
    }

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Balance');
    const cta = "{{ cta_sel is not null ? cta_sel : '' }}";
    const gas = "{{ gas_sel is not null ? gas_sel : '' }}";
    XLSX.writeFile(wb, `Balance_Age_${cta}_${gas}_${new Date().toISOString().slice(0,10)}.xlsx`);
  });
});
</script>

<!-- ===== Inicialización y Export DETALLE ===== -->
<script>
document.addEventListener('DOMContentLoaded', function () {
  const tbl2 = document.getElementById('balance_age_table_det');
  if (!tbl2) return;

  const dt2 = $('#balance_age_table_det').DataTable({
    autoWidth: false, ordering: true, order: [],
    searching: true, paging: true, info: true, dom: 'lfrtip',
    pageLength: 50,
    lengthMenu: [[25,50,100,250,500,-1],[25,50,100,250,500,'Todas']],
    language: {
      lengthMenu: 'Mostrar _MENU_ entradas',
      info: 'Mostrando _START_ a _END_ de _TOTAL_ entradas',
      infoEmpty: 'Mostrando 0 a 0 de 0 entradas',
      infoFiltered: '(filtrado de _MAX_ entradas totales)',
      search: 'Buscar:',
      paginate: { first:'Primero', last:'Último', next:'Siguiente', previous:'Anterior' }
    },
    /* OCULTA la última columna pero la deja searchable (clave para búsquedas por cliente) */
    columnDefs: [
      { targets: [11], visible: false, searchable: true }
    ],
    footerCallback: function () {
      const api = this.api();
      [4,5,6,7,8,9,10].forEach(idx => {
        const total = api.column(idx, { page: 'current' }).data().reduce((acc, val) => {
          const n = (val+'').replace(/[^0-9.\-]/g,'');
          const parsed = parseFloat(n);
          return acc + (isNaN(parsed) ? 0 : parsed);
        }, 0);
        $(api.table().footer()).find(`[data-colsum="${idx}"]`)
          .text(total.toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}));
      });
    }
  });
  window.dtBalanceDet = dt2;

  // Mover controles a contenedores fijos
  const $wrap2 = $(dt2.table().container());
  $('#dt-controls-top-det')
    .append($wrap2.find('.dataTables_length'))
    .append($wrap2.find('.dataTables_filter'));
  $('#dt-controls-bottom-det')
    .append($wrap2.find('.dataTables_info'))
    .append($wrap2.find('.dataTables_paginate'));

  // Toggle columnas de Facturas (solo Estación = col 1)
  const showAll = document.getElementById('show_all');
  const toggleCols2 = () => {
    const visible = showAll && showAll.checked;
    [1].forEach(i => dt2.column(i).visible(visible, false));
    dt2.columns.adjust().draw(false);
  };
  toggleCols2();
  if (showAll) showAll.addEventListener('change', toggleCols2);

  // Ajuste de anchos al cambiar de pestaña
  const tabEls = document.querySelectorAll('#baTabs button[data-bs-toggle="tab"]');
  tabEls.forEach(el => el.addEventListener('shown.bs.tab', () => { dt2.columns.adjust(); }));

  // ---- Select2 para cliente ----
  function initSelect2(){
    const $sel = $('#clientFilter');
    if (!$sel.length) return;
    $sel.select2({
      placeholder: '(Todos)',
      allowClear: true,
      width: 'resolve',
      language: { noResults: function(){ return 'Sin resultados'; } }
    });

    // Búsqueda por cliente usando la columna oculta (idx 11)
    function escapeRegex(text){ return text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
    $sel.on('change', function(){
      const val = $(this).val() || '';
      if (val) {
        dt2.column(11).search('^' + escapeRegex(val) + '$', true, false);
      } else {
        dt2.column(11).search('');
      }
      dt2.draw();
    });
  }
  initSelect2();

  // Excel Facturas
  const btn2 = document.getElementById('btnExportXLS_det');
  if (!btn2) return;

  function buildVisibleOnlyTable2(origTable, visibleIdx) {
    const tmp = document.createElement('table'); tmp.className = origTable.className;
    const sections = [
      {src: origTable.tHead,      dst: tmp.createTHead()},
      {src: origTable.tBodies[0], dst: tmp.createTBody()},
      {src: origTable.tFoot,      dst: tmp.createTFoot()}
    ];
    sections.forEach(({src, dst}) => {
      if (!src) return;
      for (const srcRow of src.rows) {
        const dstRow = dst.insertRow(-1);
        visibleIdx.forEach((i) => {
          const cell = srcRow.cells[i]; if (!cell) return;
          const newCell = cell.tagName.toLowerCase() === 'th' ? document.createElement('th') : document.createElement('td');
          newCell.innerHTML = cell.innerHTML; newCell.className = cell.className;
          dstRow.appendChild(newCell);
        });
      }
    });
    return tmp;
  }
  function getHeaderTextsByIndex2(table) {
    const headers = [];
    if (table.tHead && table.tHead.rows.length) {
      const row = table.tHead.rows[0];
      for (let i = 0; i < row.cells.length; i++) headers.push((row.cells[i].innerText || row.cells[i].textContent || '').trim());
    }
    return headers;
  }

  btn2.addEventListener('click', function () {
    const orig = document.getElementById('balance_age_table_det'); if (!orig) return;

    let visibleIdx = dt2 && typeof dt2.columns === 'function'
      ? dt2.columns(':visible').indexes().toArray()
      : Array.from({length: (orig.tHead?.rows[0]?.cells.length || 0)}, (_,i)=>i);

    const mini = buildVisibleOnlyTable2(orig, visibleIdx);
    const headersExport = getHeaderTextsByIndex2(mini);

    const ws = XLSX.utils.table_to_sheet(mini, { raw: true });
    ws['!autofilter'] = { ref: ws['!ref'] };
    const widthMap = {
      'Clientes':28,'Estación':24,'Fecha':12,'Vencimiento':12,
      'Saldo Actual':16,'Por Vencer':16,'Vencido 1-15':12,'Vencido 16-30':12,
      'Vencido 31-45':12,'Vencido 45+':12,'Total Vencido':14,'Cliente (hidden)':28
    };
    ws['!cols'] = headersExport.map(h => ({ wch: widthMap[h] || 14 }));

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Facturas');

    const cta = "{{ cta_sel is not null ? cta_sel : '' }}";
    const gas = "{{ gas_sel is not null ? gas_sel : '' }}";
    XLSX.writeFile(wb, `Balance_Facturas_${cta}_${gas}_${new Date().toISOString().slice(0,10)}.xlsx`);
  });
});
</script>

{% if submitted %}
<!-- ===== NUEVO: Lógica de ENVÍO POR CORREO (Totales/Facturas) ===== -->
<script>
// Utilidades separadas para construir el XLSX en base64 desde la tabla visible
function ba_buildVisibleOnlyTable(origTable, visibleIdx) {
  const tmp = document.createElement('table'); tmp.className = origTable.className;
  const sections = [
    {src: origTable.tHead,      dst: tmp.createTHead()},
    {src: origTable.tBodies[0], dst: tmp.createTBody()},
    {src: origTable.tFoot,      dst: tmp.createTFoot()}
  ];
  sections.forEach(({src, dst}) => {
    if (!src) return;
    for (const srcRow of src.rows) {
      const dstRow = dst.insertRow(-1);
      visibleIdx.forEach((i) => {
        const cell = srcRow.cells[i]; if (!cell) return;
        const newCell = cell.tagName.toLowerCase() === 'th' ? document.createElement('th') : document.createElement('td');
        newCell.innerHTML = cell.innerHTML; newCell.className = cell.className;
        dstRow.appendChild(newCell);
      });
    }
  });
  return tmp;
}
function ba_getHeaders(table) {
  const headers = [];
  if (table.tHead && table.tHead.rows.length) {
    const row = table.tHead.rows[0];
    for (let i = 0; i < row.cells.length; i++) headers.push((row.cells[i].innerText || row.cells[i].textContent || '').trim());
  }
  return headers;
}
/**
 * Construye el workbook y regresa { filename, file_b64 }
 * @param {Object} opt
 *  - tableId: ID de la tabla origen
 *  - dtInstance: instancia DataTable
 *  - widthMap: mapa de anchos por encabezado
 *  - sheetName: nombre de hoja
 *  - filePrefix: prefijo de archivo
 *  - paintPct: si true, convierte y colorea la columna "% de vencimiento"
 */
function ba_buildWorkbookBase64(opt){
  const { tableId, dtInstance, widthMap, sheetName, filePrefix, paintPct } = opt;
  const orig = document.getElementById(tableId);
  if (!orig) return null;

  const visibleIdx = dtInstance?.columns ? dtInstance.columns(':visible').indexes().toArray()
                                         : Array.from({length: (orig.tHead?.rows[0]?.cells.length || 0)}, (_,i)=>i);

  const mini = ba_buildVisibleOnlyTable(orig, visibleIdx);
  const headersExport = ba_getHeaders(mini);
  const ws = XLSX.utils.table_to_sheet(mini, { raw: true });
  if (ws['!ref']) ws['!autofilter'] = { ref: ws['!ref'] };
  ws['!cols'] = headersExport.map(h => ({ wch: widthMap[h] || 14 }));

  if (paintPct && ws['!ref']) {
    const HEADER_PCT = '% de vencimiento';
    const colPctExport = headersExport.findIndex(h => h === HEADER_PCT);
    if (colPctExport >= 0) {
      const range = XLSX.utils.decode_range(ws['!ref']);
      const firstDataRow = range.s.r + 1;
      for (let r = firstDataRow; r <= range.e.r; r++){
        const addr = XLSX.utils.encode_cell({ r, c: colPctExport });
        const cell = ws[addr]; if (!cell) continue;
        const raw = (cell.v ?? '').toString();
        const val100 = parseFloat(raw.replace('%','').replace(/[^0-9.\-]/g,'')); if (isNaN(val100)) continue;
        ws[addr] = { t: 'n', v: val100/100, z: '0.00%' };
        let fg='C6EFCE', fontColor='006100'; if (val100>40){fg='F8CBAD';fontColor='9C0006';} else if (val100>10){fg='FFF2CC';fontColor='7F6000';}
        ws[addr].s = { fill:{patternType:"solid",fgColor:{rgb:fg}}, font:{color:{rgb:fontColor}} };
      }
    }
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, sheetName || 'Hoja1');

  const cta = "{{ cta_sel is not null ? cta_sel : '' }}";
  const gas = "{{ gas_sel is not null ? gas_sel : '' }}";
  const filename = `${filePrefix || 'Balance'}_${cta}_${gas}_${new Date().toISOString().slice(0,10)}.xlsx`;
  const file_b64 = XLSX.write(wb, { bookType: 'xlsx', type: 'base64' });
  return { filename, file_b64 };
}

// Estado temporal del adjunto a enviar
let ba_pendingMail = null;

// Botones de abrir modal (prepara adjunto)
document.addEventListener('DOMContentLoaded', function(){
  const btnTot = document.getElementById('btnMailTotales');
  if (btnTot){
    btnTot.addEventListener('click', function(){
      const widthMap = {
        'Cliente':28,'Estación':24,'Ult. Déb.':12,'Ult. Créd.':12,'Crédito':14,'Dias Crédito':12,
        'Saldo actual':16,'Por vencer':16,'1-15':10,'16-30':10,'31-45':10,'45+':10,'Total vencido':14,'% de vencimiento':16
      };
      const res = ba_buildWorkbookBase64({
        tableId: 'balance_age_table',
        dtInstance: window.dtBalance,
        widthMap,
        sheetName: 'Balance',
        filePrefix: 'Balance_Age',
        paintPct: true
      });
      if (!res){ toastr.error('No fue posible generar el Excel de Totales.', 'Error'); return; }
      ba_pendingMail = {
        ...res,
        subject: `Balance por Cliente/Estación - Totales (${new Date().toISOString().slice(0,10)})`
      };
      new bootstrap.Modal(document.getElementById('mailModalBA')).show();
    });
  }

  const btnDet = document.getElementById('btnMailFacturas');
  if (btnDet){
    btnDet.addEventListener('click', function(){
      const widthMap = {
        'Clientes':28,'Estación':24,'Fecha':12,'Vencimiento':12,
        'Saldo Actual':16,'Por Vencer':16,'Vencido 1-15':12,'Vencido 16-30':12,
        'Vencido 31-45':12,'Vencido 45+':12,'Total Vencido':14
      };
      const res = ba_buildWorkbookBase64({
        tableId: 'balance_age_table_det',
        dtInstance: window.dtBalanceDet,
        widthMap,
        sheetName: 'Facturas',
        filePrefix: 'Balance_Facturas',
        paintPct: false
      });
      if (!res){ toastr.error('No fue posible generar el Excel de Facturas.', 'Error'); return; }
      ba_pendingMail = {
        ...res,
        subject: `Balance por Cliente/Estación - Facturas (${new Date().toISOString().slice(0,10)})`
      };
      new bootstrap.Modal(document.getElementById('mailModalBA')).show();
    });
  }

  // Envío del formulario del modal
  const frm = document.getElementById('mail_form_ba');
  if (frm){
    frm.addEventListener('submit', function(e){
      e.preventDefault();
      if (!ba_pendingMail){ toastr.error('No hay archivo preparado para enviar.', 'Error'); return; }
      const sentTo = (document.getElementById('sentTo_ba').value || '').trim();
      if (!sentTo){ toastr.warning('Ingrese al menos un destinatario.', 'Atención'); return; }

      $.ajax({
        url: '/income/balance_age_send_mail',
        method: 'POST',
        data: {
          sentTo: sentTo,
          subject: ba_pendingMail.subject,
          filename: ba_pendingMail.filename,
          file_b64: ba_pendingMail.file_b64,
          cta: "{{ cta_sel is not null ? cta_sel : '' }}",
          gas: "{{ gas_sel is not null ? gas_sel : '' }}"
        },
        success: function(resp){
          try{
            const r = (typeof resp === 'string') ? JSON.parse(resp) : resp;
            if (r.status === 'success'){
              toastr.success(r.message || 'Correo enviado.', 'Éxito');
              const modalEl = document.getElementById('mailModalBA');
              const modal = bootstrap.Modal.getInstance(modalEl);
              if (modal) modal.hide();
              document.getElementById('sentTo_ba').value = '';
              ba_pendingMail = null;
            } else {
              toastr.error(r.message || 'No se pudo enviar el correo.', 'Error');
            }
          }catch(_){
            toastr.error('Respuesta inesperada del servidor.', 'Error');
          }
        },
        error: function(){ toastr.error('Error de red o del servidor.', 'Error'); }
      });
    });
  }
});
</script>

<script>
  // Autocompletar el correo del usuario al abrir el modal de envío
  $(function () {
    // Ajusta el selector del modal y del input según tu HTML
    const MODAL_ID = '#baMailModal';
    const INPUT_ID = '#ba_mail_to';

    $(document).on('show.bs.modal', MODAL_ID, function () {
      const $input = $(INPUT_ID);
      if (!$input.length) return;

      // Si ya hay algo escrito, no lo pisamos
      if (($input.val() || '').trim() !== '') return;

      $.getJSON('/income/balance_age_get_user_email')
        .done(function (resp) {
          if (resp && resp.ok && resp.user_mail) {
            $input.val(resp.user_mail);
          }
        })
        .fail(function () {
         
        });
    });
  });
</script>



{% endif %}
{% endblock %}
