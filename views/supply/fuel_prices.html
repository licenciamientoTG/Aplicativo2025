{% extends "views/layouts/base.html" %}
{% block title %}Abastos - Precios de combustibles{% endblock %}
{% block mycss %}
<style>
    .bootstrap-select .dropdown-toggle {
        max-width: 250px !important; /* Ajusta el 100% a otro valor fijo si es necesario */
    }
</style>
{% endblock %}
{% block menutitle %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <span>Precios de combustibles</span>
    <a href="#" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#revisarModal">
        <i class="fa fa-eye me-1"></i> Revisar
    </a>
</div>
{% endblock %}
{% block content %}


<div class="card">
    <div class="card-body">
        <div id="estaciones_seleccionadas"></div>
        <form action="/supply/send_prices">
            <div class="row">
                <div class="col">
                    <label for="product">Combustibles: </label>
                    <select class="form-control form-control-sm border selectpicker" data-live-search="true" name="product" id="product" placeholder="Seleccione el combustible" required>
                        <option value="179">T-Máxima Regular</option>
                        <option value="180">T-Super Premium</option>
                        <option value="181">Diesel</option>
                        <option value="192">Gasolina regular menor a 91 octanos</option>
                        <option value="193">Gasolina premium mayor o igual a 91 octanos</option>
                    </select>
                    <small id="ieps_value" class="text-primary"></small>
                </div>
                <div class="col-1">
                    <label for="from">Fecha: </label>
                    <input type="date" class="form-control form-control-sm" name="from" id="from" value="{{ 'now'|date('Y-m-d') }}" min="{{ 'now'|date('Y-m-d') }}">
                </div>
                <div class="col-1">
                    <label for="hour">Hora: </label>
                    <input type="time" class="form-control form-control-sm" name="hour" id="hour" value="22:00">
                </div>
                <div class="col">
                    <label for="pre">Precio: </label>
                    <input type="number" min="0.01" max="30" step="0.01" class="form-control form-control-sm" name="pre" id="pre" value="0.00">
                </div>
                <div class="col">
                    <label for="codgas">Estaciones: </label>
                    <select class="selectpicker form-control form-control-sm border" data-live-search="true" id="codgas" name="codgas[]" data-width="100%" multiple required placeholder="Seleccione una estación">
                        {% for gas in stations %}
                        <option value="{{ gas.Codigo }}">{{ gas.Nombre }} ({{gas.iva}}%)</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col">
                    <button id="submitButton" class="btn btn-primary btn-block w-100 mt-3" >Enviar</button>
                </div>
            </div>
        </form>
    </div>
</div>

<div class="card border shadow">
    <div class="card-body">
        {{ mensajeFinal | raw}}
    </div>
    <div class="card-body">
        {{ mensajeFinal2 | raw}}
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="card-actions float-end">
            <div class="dropdown position-relative">
                <a href="#" data-bs-toggle="dropdown" data-bs-display="static">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-more-horizontal align-middle">
                        <circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle>
                    </svg>
                </a>
                <div class="dropdown-menu dropdown-menu-end">
                    <a class="dropdown-item" href="#" id="exportExcel"><i data-feather="file-text"></i> Exportar a Excel</a>
                    <a class="dropdown-item" href="/supply/changes" id="changes" target="_blank"><i data-feather="file-text"></i> Ver historicos de cambios</a>
                    <a class="dropdown-item" href="/supply/get_binnacle" id="binnacle" target="_blank"><i data-feather="file-text"></i> Ver bitácora</a>
                </div>
            </div>
        </div>
        <h5 class="card-title">Lista de precios actuales</h5>
    </div>

    <div class="card-body table-responsive" id="cont">


        <div id="filtro-datatable_product_prices" class="mb-1">
            <div class="row">
                <!-- Agrega tus elementos de filtrado aquí -->
                <div class="col p-1"><input type="text" class="form-control form-control-sm" style="margin-left: 3px" id="CODEST"               placeholder="CODEST"></div>
                <div class="col p-1"><input type="text" class="form-control form-control-sm" style="margin-left: 3px" id="ESTACION"             placeholder="ESTACION"></div>
                <div class="col p-1"><input type="text" class="form-control form-control-sm" style="margin-left: 3px" id="PRECIOANTERIORMAXIMA" placeholder="PRECIOANTERIORMAXIMA"></div>
                <div class="col p-1"><input type="text" class="form-control form-control-sm" style="margin-left: 3px" id="PRECIONUEVOMAXIMA"    placeholder="PRECIONUEVOMAXIMA"></div>
                <div class="col p-1"><input type="text" class="form-control form-control-sm" style="margin-left: 3px" id="DIFERENCIAMAXIMA"     placeholder="DIFERENCIAMAXIMA"></div>
                <div class="col p-1"><input type="text" class="form-control form-control-sm" style="margin-left: 3px" id="PRECIOANTERIORSUPER"  placeholder="PRECIOANTERIORSUPER"></div>
                <div class="col p-1"><input type="text" class="form-control form-control-sm" style="margin-left: 3px" id="PRECIONUEVOSUPER"     placeholder="PRECIONUEVOSUPER"></div>
                <div class="col p-1"><input type="text" class="form-control form-control-sm" style="margin-left: 3px" id="DIFERENCIASUPER"      placeholder="DIFERENCIASUPER"></div>
                <div class="col p-1"><input type="text" class="form-control form-control-sm" style="margin-left: 3px" id="PRECIOANTERIORDIESEL" placeholder="PRECIOANTERIORDIESEL"></div>
                <div class="col p-1"><input type="text" class="form-control form-control-sm" style="margin-left: 3px" id="PRECIONUEVODIESEL"    placeholder="PRECIONUEVODIESEL"></div>
                <div class="col p-1"><input type="text" class="form-control form-control-sm" style="margin-left: 3px" id="DIFERENCIADIESEL"     placeholder="DIFERENCIADIESEL"></div>
                <div class="col p-1 text-center"><button type="button" class="btn btn-sm btn-success refresh"><i data-feather="refresh-ccw"></i></button></div>
            </div>
            <!-- Puedes agregar más filtros según tus necesidades -->
        </div>

        <table id="datatable_product_prices" class="table table-striped table-sm w-100" style="font-size: small">
            <thead>
            <tr>
                <th rowspan="2">NO. EST.</th>
                <th rowspan="2">NOMBRE ESTACIÓN</th>
                <th colspan="3" class="bg-success text-white text-center">T-MÁXIMA REGULAR</th>
                <th colspan="3" class="bg-primary text-white text-center">T-SUPER PREMIUM</th>
                <th colspan="3" class="bg-black text-light text-center">DIESEL AUTOMOTRíZ</th>
            </tr>
            <tr>
                <th>PRE. ANTERIOR</th>
                <th>PRE. ACTUAL</th>
                <th>DIFERENCIA</th>
                <th>PRE. ANTERIOR</th>
                <th>PRE. ACTUAL</th>
                <th>DIFERENCIA</th>
                <th>PRE. ANTERIOR</th>
                <th>PRE. ACTUAL</th>
                <th>DIFERENCIA</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
            <tfoot>
            <tr>
                <th>NO. EST.</th>
                <th>NOMBRE ESTACIÓN</th>
                <th>PRE. ANTERIOR</th>
                <th>PRE. ACTUAL</th>
                <th>DIFERENCIA</th>
                <th>PRE. ANTERIOR</th>
                <th>PRE. ACTUAL</th>
                <th>DIFERENCIA</th>
                <th>PRE. ANTERIOR</th>
                <th>PRE. ACTUAL</th>
                <th>DIFERENCIA</th>
            </tr>
            </tfoot>
        </table>
    </div>
</div>
<div class="modal fade" id="revisarModal" tabindex="-1" aria-labelledby="revisarModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 id="revisarModalLabel" class="modal-title">Revisar combustible</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>

      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-hover table-bordered align-middle" id="tablaPrecios">
            <thead class="table-light text-center">
              <tr>
                <th>Gasolinera</th>
                <th>Producto</th>
                <th>Precio (MXN)</th>
                <th>Fecha</th>
                <th>Hora</th>
              </tr>
            </thead>
            <tbody>
              {% for item in prices %}
                <tr>
                  <td><strong>{{ item.abr }}</strong></td>
                  <td>{{ item.Producto }}</td>
                  <td class="text-center">
                    <span class="badge bg-success fs-6">$ {{ item.pre|number_format(2, '.', ',') }}</span>
                  </td>
                  <td>{{ item.Fecha|date('Y-m-d') }}</td>
                  <td>{{ item.hra }}</td>
                </tr>
              {% else %}
                <tr>
                  <td colspan="5" class="text-center text-muted">No hay datos disponibles.</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block myjs %}
<script src="{{ JS }}supply.js"></script>
<script>
        
    $('[data-toggle="tooltip"]').tooltip();

    // Cuando hagamos un onchange en el select #product, vamos a actualizar las opciones del select #iva
    document.getElementById('product').onchange = function() {
        $('#iva').selectpicker('destroy');
        $('#iva').selectpicker();
    }

    function updateCodGasOptions() {
        // Primero que nada vamos a verificar si ya se seleccionó un producto

        if (document.getElementById('product').value == '') {
            alert('Primero selecciona un producto');
            document.getElementById('iva').value = '';
            return;
        }

        var codprod = document.getElementById('product').value;

        // Destruye cualquier instancia previa de selectpicker
        $('.selectpicker').selectpicker('destroy');

        var iva = document.getElementById('iva').value;
        var content = '';

        document.getElementById('contenido').innerHTML = content;
        $('.selectpicker').selectpicker();
    }

    $('#codgas').on('change', function() {
        var badges = '';

        // Recorrer las opciones seleccionadas
        $('#codgas option:selected').each(function() {
            badges += '<span class="badge text-bg-primary m-1">' + $(this).text() + '</span>';
        });

        // Insertar las badges en el elemento con id="estaciones_seleccionadas"
        $('#estaciones_seleccionadas').html(badges);
    });
</script>

<script>
    $('#tablaPrecios').DataTable({
        pageLength: 100,
        order: [[3, 'desc']], // Ordenar por fecha descendente
        language: {
            url: "https://cdn.datatables.net/plug-ins/2.1.2/i18n/es-MX.json"
        }
    });

    // Cuando se abre el modal, podrías hacer lógica adicional si necesitás
    $('#revisarModal').on('show.bs.modal', function () {
        // Ejemplo: limpiar alertas, inicializar validaciones, etc.
        console.log('Modal Revisar abierto con datos precargados desde el controlador.');
    });
</script>
{% endblock %}